
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../changelog/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>API documentation - spectranorm</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-documentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="spectranorm" class="md-header__button md-logo" aria-label="spectranorm" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            spectranorm
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API documentation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/sina-mansour/spectranorm" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="spectranorm" class="md-nav__button md-logo" aria-label="spectranorm" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    spectranorm
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sina-mansour/spectranorm" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API documentation
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API documentation
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spectranorm" class="md-nav__link">
    <span class="md-ellipsis">
      spectranorm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectranorm.snm" class="md-nav__link">
    <span class="md-ellipsis">
      snm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="snm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceModelSpec" class="md-nav__link">
    <span class="md-ellipsis">
      CovarianceModelSpec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel" class="md-nav__link">
    <span class="md-ellipsis">
      CovarianceNormativeModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CovarianceNormativeModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.from_direct_model" class="md-nav__link">
    <span class="md-ellipsis">
      from_direct_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovariateSpec" class="md-nav__link">
    <span class="md-ellipsis">
      CovariateSpec
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CovariateSpec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovariateSpec.factorize_categories" class="md-nav__link">
    <span class="md-ellipsis">
      factorize_categories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovariateSpec.make_spline_bases" class="md-nav__link">
    <span class="md-ellipsis">
      make_spline_bases
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel" class="md-nav__link">
    <span class="md-ellipsis">
      DirectNormativeModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DirectNormativeModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.from_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      from_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativeModelSpec" class="md-nav__link">
    <span class="md-ellipsis">
      NormativeModelSpec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions" class="md-nav__link">
    <span class="md-ellipsis">
      NormativePredictions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NormativePredictions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions.evaluate_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions.extend_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      extend_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions.to_array" class="md-nav__link">
    <span class="md-ellipsis">
      to_array
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions.to_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      to_dataframe
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel" class="md-nav__link">
    <span class="md-ellipsis">
      SpectralNormativeModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpectralNormativeModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.build_from_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      build_from_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit_all_covariance" class="md-nav__link">
    <span class="md-ellipsis">
      fit_all_covariance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit_all_direct" class="md-nav__link">
    <span class="md-ellipsis">
      fit_all_direct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit_single_covariance" class="md-nav__link">
    <span class="md-ellipsis">
      fit_single_covariance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit_single_direct" class="md-nav__link">
    <span class="md-ellipsis">
      fit_single_direct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.identify_sparse_covariance_structure" class="md-nav__link">
    <span class="md-ellipsis">
      identify_sparse_covariance_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SplineSpec" class="md-nav__link">
    <span class="md-ellipsis">
      SplineSpec
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SplineSpec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SplineSpec.create_spline_spec" class="md-nav__link">
    <span class="md-ellipsis">
      create_spline_spec
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectranorm.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general" class="md-nav__link">
    <span class="md-ellipsis">
      general
    </span>
  </a>
  
    <nav class="md-nav" aria-label="general">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.ReportTimeFormatter" class="md-nav__link">
    <span class="md-ellipsis">
      ReportTimeFormatter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.ensure_dir" class="md-nav__link">
    <span class="md-ellipsis">
      ensure_dir
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ensure_dir">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.ensure_dir--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.ensure_dir--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.get_logger" class="md-nav__link">
    <span class="md-ellipsis">
      get_logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.prepare_save_directory" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_save_directory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare_save_directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.prepare_save_directory--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.report_time" class="md-nav__link">
    <span class="md-ellipsis">
      report_time
    </span>
  </a>
  
    <nav class="md-nav" aria-label="report_time">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.report_time--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.report_time--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.suppress_output" class="md-nav__link">
    <span class="md-ellipsis">
      suppress_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.validate_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      validate_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.validate_load_directory" class="md-nav__link">
    <span class="md-ellipsis">
      validate_load_directory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="validate_load_directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.validate_load_directory--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp" class="md-nav__link">
    <span class="md-ellipsis">
      gsp
    </span>
  </a>
  
    <nav class="md-nav" aria-label="gsp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis" class="md-nav__link">
    <span class="md-ellipsis">
      EigenmodeBasis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EigenmodeBasis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis.load_and_encode_data_list" class="md-nav__link">
    <span class="md-ellipsis">
      load_and_encode_data_list
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.compute_random_walk_laplacian_eigenmodes" class="md-nav__link">
    <span class="md-ellipsis">
      compute_random_walk_laplacian_eigenmodes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.compute_symmetric_normalized_laplacian_eigenmodes" class="md-nav__link">
    <span class="md-ellipsis">
      compute_symmetric_normalized_laplacian_eigenmodes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.convert_adjacency_to_transition_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      convert_adjacency_to_transition_matrix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.make_csr_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      make_csr_matrix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.perform_symmetric_normalization" class="md-nav__link">
    <span class="md-ellipsis">
      perform_symmetric_normalization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics" class="md-nav__link">
    <span class="md-ellipsis">
      metrics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_bic" class="md-nav__link">
    <span class="md-ellipsis">
      compute_bic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_expv" class="md-nav__link">
    <span class="md-ellipsis">
      compute_expv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_mae" class="md-nav__link">
    <span class="md-ellipsis">
      compute_mae
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_mape" class="md-nav__link">
    <span class="md-ellipsis">
      compute_mape
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_mse" class="md-nav__link">
    <span class="md-ellipsis">
      compute_mse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_msll" class="md-nav__link">
    <span class="md-ellipsis">
      compute_msll
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_r2" class="md-nav__link">
    <span class="md-ellipsis">
      compute_r2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_rmse" class="md-nav__link">
    <span class="md-ellipsis">
      compute_rmse
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools" class="md-nav__link">
    <span class="md-ellipsis">
      nitools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="nitools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_adaptive_area_barycentric_transformation" class="md-nav__link">
    <span class="md-ellipsis">
      compute_adaptive_area_barycentric_transformation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_adaptive_area_barycentric_transformation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_adaptive_area_barycentric_transformation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_adaptive_area_barycentric_transformation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_barycentric_transformation" class="md-nav__link">
    <span class="md-ellipsis">
      compute_barycentric_transformation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_barycentric_transformation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_barycentric_transformation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_barycentric_transformation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fslr_thickness" class="md-nav__link">
    <span class="md-ellipsis">
      compute_fslr_thickness
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_fslr_thickness">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fslr_thickness--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fslr_thickness--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fsnative_to_fslr32k_transformation" class="md-nav__link">
    <span class="md-ellipsis">
      compute_fsnative_to_fslr32k_transformation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_fsnative_to_fslr32k_transformation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fsnative_to_fslr32k_transformation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fsnative_to_fslr32k_transformation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_total_euler_number" class="md-nav__link">
    <span class="md-ellipsis">
      compute_total_euler_number
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_total_euler_number">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_total_euler_number--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_total_euler_number--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_vertex_areas" class="md-nav__link">
    <span class="md-ellipsis">
      compute_vertex_areas
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_vertex_areas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_vertex_areas--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_vertex_areas--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_euler_number" class="md-nav__link">
    <span class="md-ellipsis">
      get_euler_number
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_euler_number">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_euler_number--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_euler_number--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_fslr_surface_indices_from_cifti" class="md-nav__link">
    <span class="md-ellipsis">
      get_fslr_surface_indices_from_cifti
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_fslr_surface_indices_from_cifti">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_fslr_surface_indices_from_cifti--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_fslr_surface_indices_from_cifti--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_freesurfer_surface" class="md-nav__link">
    <span class="md-ellipsis">
      load_freesurfer_surface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_freesurfer_surface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_freesurfer_surface--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_freesurfer_surface--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_gifti_surface" class="md-nav__link">
    <span class="md-ellipsis">
      load_gifti_surface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_gifti_surface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_gifti_surface--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_gifti_surface--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel" class="md-nav__link">
    <span class="md-ellipsis">
      parallel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="parallel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm" class="md-nav__link">
    <span class="md-ellipsis">
      ParallelTqdm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParallelTqdm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm--additional-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Additional parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm--removed-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Removed parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm--usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm.print_progress" class="md-nav__link">
    <span class="md-ellipsis">
      print_progress
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats" class="md-nav__link">
    <span class="md-ellipsis">
      stats
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats.compute_censored_log_likelihood" class="md-nav__link">
    <span class="md-ellipsis">
      compute_censored_log_likelihood
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats.compute_centiles_from_z_scores" class="md-nav__link">
    <span class="md-ellipsis">
      compute_centiles_from_z_scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats.compute_correlation_significance_by_fisher_z" class="md-nav__link">
    <span class="md-ellipsis">
      compute_correlation_significance_by_fisher_z
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats.compute_log_likelihood" class="md-nav__link">
    <span class="md-ellipsis">
      compute_log_likelihood
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spectranorm" class="md-nav__link">
    <span class="md-ellipsis">
      spectranorm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectranorm.snm" class="md-nav__link">
    <span class="md-ellipsis">
      snm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="snm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceModelSpec" class="md-nav__link">
    <span class="md-ellipsis">
      CovarianceModelSpec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel" class="md-nav__link">
    <span class="md-ellipsis">
      CovarianceNormativeModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CovarianceNormativeModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.from_direct_model" class="md-nav__link">
    <span class="md-ellipsis">
      from_direct_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovarianceNormativeModel.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovariateSpec" class="md-nav__link">
    <span class="md-ellipsis">
      CovariateSpec
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CovariateSpec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovariateSpec.factorize_categories" class="md-nav__link">
    <span class="md-ellipsis">
      factorize_categories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.CovariateSpec.make_spline_bases" class="md-nav__link">
    <span class="md-ellipsis">
      make_spline_bases
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel" class="md-nav__link">
    <span class="md-ellipsis">
      DirectNormativeModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DirectNormativeModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.from_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      from_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.DirectNormativeModel.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativeModelSpec" class="md-nav__link">
    <span class="md-ellipsis">
      NormativeModelSpec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions" class="md-nav__link">
    <span class="md-ellipsis">
      NormativePredictions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NormativePredictions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions.evaluate_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions.extend_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      extend_predictions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions.to_array" class="md-nav__link">
    <span class="md-ellipsis">
      to_array
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.NormativePredictions.to_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      to_dataframe
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel" class="md-nav__link">
    <span class="md-ellipsis">
      SpectralNormativeModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpectralNormativeModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.build_from_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      build_from_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit_all_covariance" class="md-nav__link">
    <span class="md-ellipsis">
      fit_all_covariance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit_all_direct" class="md-nav__link">
    <span class="md-ellipsis">
      fit_all_direct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit_single_covariance" class="md-nav__link">
    <span class="md-ellipsis">
      fit_single_covariance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.fit_single_direct" class="md-nav__link">
    <span class="md-ellipsis">
      fit_single_direct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.identify_sparse_covariance_structure" class="md-nav__link">
    <span class="md-ellipsis">
      identify_sparse_covariance_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SpectralNormativeModel.save_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SplineSpec" class="md-nav__link">
    <span class="md-ellipsis">
      SplineSpec
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SplineSpec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.SplineSpec.create_spline_spec" class="md-nav__link">
    <span class="md-ellipsis">
      create_spline_spec
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.snm.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectranorm.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general" class="md-nav__link">
    <span class="md-ellipsis">
      general
    </span>
  </a>
  
    <nav class="md-nav" aria-label="general">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.ReportTimeFormatter" class="md-nav__link">
    <span class="md-ellipsis">
      ReportTimeFormatter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.ensure_dir" class="md-nav__link">
    <span class="md-ellipsis">
      ensure_dir
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ensure_dir">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.ensure_dir--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.ensure_dir--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.get_logger" class="md-nav__link">
    <span class="md-ellipsis">
      get_logger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.prepare_save_directory" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_save_directory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="prepare_save_directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.prepare_save_directory--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.report_time" class="md-nav__link">
    <span class="md-ellipsis">
      report_time
    </span>
  </a>
  
    <nav class="md-nav" aria-label="report_time">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.report_time--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.report_time--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.suppress_output" class="md-nav__link">
    <span class="md-ellipsis">
      suppress_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.validate_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      validate_dataframe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.validate_load_directory" class="md-nav__link">
    <span class="md-ellipsis">
      validate_load_directory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="validate_load_directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.general.validate_load_directory--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp" class="md-nav__link">
    <span class="md-ellipsis">
      gsp
    </span>
  </a>
  
    <nav class="md-nav" aria-label="gsp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis" class="md-nav__link">
    <span class="md-ellipsis">
      EigenmodeBasis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EigenmodeBasis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis.load_and_encode_data_list" class="md-nav__link">
    <span class="md-ellipsis">
      load_and_encode_data_list
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.EigenmodeBasis.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.compute_random_walk_laplacian_eigenmodes" class="md-nav__link">
    <span class="md-ellipsis">
      compute_random_walk_laplacian_eigenmodes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.compute_symmetric_normalized_laplacian_eigenmodes" class="md-nav__link">
    <span class="md-ellipsis">
      compute_symmetric_normalized_laplacian_eigenmodes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.convert_adjacency_to_transition_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      convert_adjacency_to_transition_matrix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.make_csr_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      make_csr_matrix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.gsp.perform_symmetric_normalization" class="md-nav__link">
    <span class="md-ellipsis">
      perform_symmetric_normalization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics" class="md-nav__link">
    <span class="md-ellipsis">
      metrics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_bic" class="md-nav__link">
    <span class="md-ellipsis">
      compute_bic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_expv" class="md-nav__link">
    <span class="md-ellipsis">
      compute_expv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_mae" class="md-nav__link">
    <span class="md-ellipsis">
      compute_mae
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_mape" class="md-nav__link">
    <span class="md-ellipsis">
      compute_mape
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_mse" class="md-nav__link">
    <span class="md-ellipsis">
      compute_mse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_msll" class="md-nav__link">
    <span class="md-ellipsis">
      compute_msll
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_r2" class="md-nav__link">
    <span class="md-ellipsis">
      compute_r2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.metrics.compute_rmse" class="md-nav__link">
    <span class="md-ellipsis">
      compute_rmse
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools" class="md-nav__link">
    <span class="md-ellipsis">
      nitools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="nitools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_adaptive_area_barycentric_transformation" class="md-nav__link">
    <span class="md-ellipsis">
      compute_adaptive_area_barycentric_transformation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_adaptive_area_barycentric_transformation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_adaptive_area_barycentric_transformation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_adaptive_area_barycentric_transformation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_barycentric_transformation" class="md-nav__link">
    <span class="md-ellipsis">
      compute_barycentric_transformation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_barycentric_transformation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_barycentric_transformation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_barycentric_transformation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fslr_thickness" class="md-nav__link">
    <span class="md-ellipsis">
      compute_fslr_thickness
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_fslr_thickness">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fslr_thickness--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fslr_thickness--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fsnative_to_fslr32k_transformation" class="md-nav__link">
    <span class="md-ellipsis">
      compute_fsnative_to_fslr32k_transformation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_fsnative_to_fslr32k_transformation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fsnative_to_fslr32k_transformation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_fsnative_to_fslr32k_transformation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_total_euler_number" class="md-nav__link">
    <span class="md-ellipsis">
      compute_total_euler_number
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_total_euler_number">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_total_euler_number--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_total_euler_number--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_vertex_areas" class="md-nav__link">
    <span class="md-ellipsis">
      compute_vertex_areas
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_vertex_areas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_vertex_areas--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.compute_vertex_areas--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_euler_number" class="md-nav__link">
    <span class="md-ellipsis">
      get_euler_number
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_euler_number">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_euler_number--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_euler_number--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_fslr_surface_indices_from_cifti" class="md-nav__link">
    <span class="md-ellipsis">
      get_fslr_surface_indices_from_cifti
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_fslr_surface_indices_from_cifti">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_fslr_surface_indices_from_cifti--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.get_fslr_surface_indices_from_cifti--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_freesurfer_surface" class="md-nav__link">
    <span class="md-ellipsis">
      load_freesurfer_surface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_freesurfer_surface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_freesurfer_surface--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_freesurfer_surface--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_gifti_surface" class="md-nav__link">
    <span class="md-ellipsis">
      load_gifti_surface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_gifti_surface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_gifti_surface--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.nitools.load_gifti_surface--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel" class="md-nav__link">
    <span class="md-ellipsis">
      parallel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="parallel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm" class="md-nav__link">
    <span class="md-ellipsis">
      ParallelTqdm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParallelTqdm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm--additional-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Additional parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm--removed-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Removed parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm--usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.parallel.ParallelTqdm.print_progress" class="md-nav__link">
    <span class="md-ellipsis">
      print_progress
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats" class="md-nav__link">
    <span class="md-ellipsis">
      stats
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats.compute_censored_log_likelihood" class="md-nav__link">
    <span class="md-ellipsis">
      compute_censored_log_likelihood
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats.compute_centiles_from_z_scores" class="md-nav__link">
    <span class="md-ellipsis">
      compute_centiles_from_z_scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats.compute_correlation_significance_by_fisher_z" class="md-nav__link">
    <span class="md-ellipsis">
      compute_correlation_significance_by_fisher_z
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spectranorm.utils.stats.compute_log_likelihood" class="md-nav__link">
    <span class="md-ellipsis">
      compute_log_likelihood
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="api-documentation">API documentation</h1>


<div class="doc doc-object doc-module">



<a id="spectranorm"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h2 id="spectranorm.snm" class="doc doc-heading">
            <code>snm</code>


</h2>

    <div class="doc doc-contents ">

        <p>snm.py</p>
<p>Core implementation of spectral normative modeling (SNM).</p>
<p>This module provides the code base for using spectral normative models. It can
be used to fit direct and spectral normative models to data and also to
predict normative centiles using pre-trained models.</p>
<p>See full documentation at:
https://sina-mansour.github.io/spectranorm</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="spectranorm.snm.CovarianceModelSpec" class="doc doc-heading">
            <code>CovarianceModelSpec</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>General specification of a normative model for covariance.</p>
<p>This model aims to learn the relationships between two variables of interest for
both of which a normative model is specified. This can capture patterns where the
normative trends in two variables are related.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovarianceModelSpec.variable_of_interest_1">variable_of_interest_1</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Name of the first variable of interest.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovarianceModelSpec.variable_of_interest_2">variable_of_interest_2</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Name of the second variable of interest.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovarianceModelSpec.covariates">covariates</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="CovariateSpec


  
      dataclass
   (spectranorm.snm.CovariateSpec)" href="#spectranorm.snm.CovariateSpec">CovariateSpec</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[CovariateSpec]
Listing all model covariates and specifying how each covariate is modeled.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovarianceModelSpec.influencing_covariance">influencing_covariance</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]
List of covariate names that influence the covariance between the two
variables of interest.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CovarianceModelSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General specification of a normative model for covariance.</span>

<span class="sd">    This model aims to learn the relationships between two variables of interest for</span>
<span class="sd">    both of which a normative model is specified. This can capture patterns where the</span>
<span class="sd">    normative trends in two variables are related.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        variable_of_interest_1: str</span>
<span class="sd">            Name of the first variable of interest.</span>
<span class="sd">        variable_of_interest_2: str</span>
<span class="sd">            Name of the second variable of interest.</span>
<span class="sd">        covariates: list[CovariateSpec]</span>
<span class="sd">            Listing all model covariates and specifying how each covariate is modeled.</span>
<span class="sd">        influencing_covariance: list[str]</span>
<span class="sd">            List of covariate names that influence the covariance between the two</span>
<span class="sd">            variables of interest.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">variable_of_interest_1</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">variable_of_interest_2</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CovariateSpec</span><span class="p">]</span>
    <span class="n">influencing_covariance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;variable_of_interest_1 must be a string.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;variable_of_interest_2 must be a string.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;covariates must be a list of CovariateSpec instances.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">CovariateSpec</span><span class="p">)</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;All items in covariates must be CovariateSpec instances.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">influencing_covariance</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;influencing_covariance must be a list of covariate names.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="spectranorm.snm.CovarianceNormativeModel" class="doc doc-heading">
            <code>CovarianceNormativeModel</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Covariance normative model implementation.</p>
<p>This class implements covariance normative modeling, which models the covariance
structure between a pair of variables as a normative random variable.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovarianceNormativeModel.spec">spec</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="CovarianceModelSpec


  
      dataclass
   (spectranorm.snm.CovarianceModelSpec)" href="#spectranorm.snm.CovarianceModelSpec">CovarianceModelSpec</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CovarianceModelSpec
Specification of the covariance model including variables of interest,
and list of covariates.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovarianceNormativeModel.batch_covariates">batch_covariates</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]
List of covariate names that are treated as batch effects.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovarianceNormativeModel.defaults">defaults</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict
Default parameters for the model, including spline specifications,
ADVI iterations, convergence tolerance, random seed, and Adam optimizer
learning rates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CovarianceNormativeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Covariance normative model implementation.</span>

<span class="sd">    This class implements covariance normative modeling, which models the covariance</span>
<span class="sd">    structure between a pair of variables as a normative random variable.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        spec: CovarianceModelSpec</span>
<span class="sd">            Specification of the covariance model including variables of interest,</span>
<span class="sd">            and list of covariates.</span>
<span class="sd">        batch_covariates: list[str]</span>
<span class="sd">            List of covariate names that are treated as batch effects.</span>
<span class="sd">        defaults: dict</span>
<span class="sd">            Default parameters for the model, including spline specifications,</span>
<span class="sd">            ADVI iterations, convergence tolerance, random seed, and Adam optimizer</span>
<span class="sd">            learning rates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">spec</span><span class="p">:</span> <span class="n">CovarianceModelSpec</span>
    <span class="n">batch_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;spline_df&quot;</span><span class="p">:</span> <span class="n">DEFAULT_SPLINE_DF</span><span class="p">,</span>
            <span class="s2">&quot;spline_degree&quot;</span><span class="p">:</span> <span class="n">DEFAULT_SPLINE_DEGREE</span><span class="p">,</span>
            <span class="s2">&quot;spline_extrapolation_factor&quot;</span><span class="p">:</span> <span class="n">DEFAULT_SPLINE_EXTRAPOLATION_FACTOR</span><span class="p">,</span>
            <span class="s2">&quot;advi_iterations&quot;</span><span class="p">:</span> <span class="n">DEFAULT_ADVI_ITERATIONS</span><span class="p">,</span>
            <span class="s2">&quot;advi_convergence_tolerance&quot;</span><span class="p">:</span> <span class="n">DEFAULT_ADVI_CONVERGENCE_TOLERANCE</span><span class="p">,</span>
            <span class="s2">&quot;random_seed&quot;</span><span class="p">:</span> <span class="n">DEFAULT_RANDOM_SEED</span><span class="p">,</span>
            <span class="s2">&quot;adam_learning_rate&quot;</span><span class="p">:</span> <span class="n">DEFAULT_ADAM_LEARNING_RATE</span><span class="p">,</span>
            <span class="s2">&quot;adam_learning_rate_decay&quot;</span><span class="p">:</span> <span class="n">DEFAULT_ADAM_LEARNING_RATE_DECAY</span><span class="p">,</span>
            <span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">:</span> <span class="n">DEFAULT_COVARIANCE_AUGMENTATION_MULTIPLICITY</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation of the CovarianceNormativeModel instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;CovarianceNormativeModel(</span><span class="se">\n\t</span><span class="s2">spec=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">, </span><span class="se">\n\t</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;batch_covariates=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_covariates</span><span class="si">}</span><span class="se">\n</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_direct_model</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">direct_model</span><span class="p">:</span> <span class="n">DirectNormativeModel</span><span class="p">,</span>
        <span class="n">variable_of_interest_1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">variable_of_interest_2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">influencing_covariance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">defaults_overwrite</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CovarianceNormativeModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the model from a direct model instance, and two variable names.</span>

<span class="sd">        Args:</span>
<span class="sd">            direct_model: DirectNormativeModel</span>
<span class="sd">                This model will be used to instantiate a similar covariance model.</span>
<span class="sd">            variable_of_interest_1: str</span>
<span class="sd">                Name of the first target variable to model.</span>
<span class="sd">            variable_of_interest_2: str</span>
<span class="sd">                Name of the second target variable to model.</span>
<span class="sd">            influencing_covariance: list[str] | None</span>
<span class="sd">                List of covariates that influence the covariance structure. If not</span>
<span class="sd">                provided, this will be copied from the direct model&#39;s</span>
<span class="sd">                `influencing_variance`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CovarianceNormativeModel</span>
<span class="sd">                An instance of CovarianceNormativeModel initialized with the provided</span>
<span class="sd">                data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validity checks for input parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">direct_model</span><span class="p">,</span> <span class="n">DirectNormativeModel</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;direct_model must be an instance of DirectNormativeModel.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable_of_interest_1</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable_of_interest_2</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Variables of interest must be strings.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># Substitute influencing_covariance if not provided</span>
        <span class="k">if</span> <span class="n">influencing_covariance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">influencing_covariance</span> <span class="o">=</span> <span class="n">direct_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_variance</span>

        <span class="c1"># Use the same setup as the direct model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">=</span><span class="n">CovarianceModelSpec</span><span class="p">(</span>
                <span class="n">variable_of_interest_1</span><span class="o">=</span><span class="n">variable_of_interest_1</span><span class="p">,</span>
                <span class="n">variable_of_interest_2</span><span class="o">=</span><span class="n">variable_of_interest_2</span><span class="p">,</span>
                <span class="n">covariates</span><span class="o">=</span><span class="n">direct_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
                <span class="n">influencing_covariance</span><span class="o">=</span><span class="n">influencing_covariance</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">batch_covariates</span><span class="o">=</span><span class="n">direct_model</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># update defaults</span>
        <span class="n">model</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">direct_model</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults_overwrite</span> <span class="ow">or</span> <span class="p">{})</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the covariance model instance.</span>

<span class="sd">        This method checks if the model instance is complete and valid.</span>
<span class="sd">        It raises errors if any required fields are missing or if there are</span>
<span class="sd">        inconsistencies in the model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Model specification is not set. Please initialize the model,&quot;</span>
                <span class="s2">&quot; e.g., with &#39;from_dataframe&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;No covariates specified in the model. &quot;</span>
                <span class="s2">&quot;Please add covariates to the specification.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_covariance</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;No covariates specified to influence the covariance &quot;</span>
                <span class="s2">&quot;between the variables of interest.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the fitted model and it&#39;s posterior to a directory.</span>
<span class="sd">        The model will be saved in a subdirectory named &#39;saved_model&#39;.</span>
<span class="sd">        If this directory is not empty, an error is raised.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory: Path</span>
<span class="sd">                Path to a directory to save the model.</span>
<span class="sd">            save_posterior: bool (default=False)</span>
<span class="sd">                If True, save the model&#39;s posterior trace inference data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare the save directory</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">prepare_save_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;saved_model&quot;</span><span class="p">)</span>

        <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
            <span class="s2">&quot;batch_covariates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
            <span class="s2">&quot;defaults&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_params&quot;</span><span class="p">):</span>
            <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_inference_data&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">save_posterior</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span>
                    <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_inference_data.nc&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_dict</span><span class="p">,</span> <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_dict.joblib&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">load_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CovarianceNormativeModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the model and its posterior from a directory.</span>
<span class="sd">        The model will be loaded from a subdirectory named &#39;saved_model&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory: Path</span>
<span class="sd">                Path to the directory containing the model.</span>
<span class="sd">            load_posterior: bool (default=False)</span>
<span class="sd">                If True, load the model&#39;s posterior trace from the saved inference data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the load directory</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_load_directory</span><span class="p">(</span>
            <span class="n">directory</span><span class="p">,</span>
            <span class="s2">&quot;saved_model&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Load the saved model dict</span>
        <span class="n">model_dict</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_dict.joblib&quot;</span><span class="p">)</span>

        <span class="c1"># Create an instance of the class</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span>
            <span class="n">batch_covariates</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;batch_covariates&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Set the attributes from the loaded model dictionary</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;defaults&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;model_params&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">load_posterior</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">model_inference_data</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_netcdf</span><span class="p">(</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
                    <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_inference_data.nc&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">instance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_dataframe_for_fitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the training DataFrame for fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_dataframe</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="si">}</span><span class="s2">_mu_estimate&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="si">}</span><span class="s2">_mu_estimate&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="si">}</span><span class="s2">_std_estimate&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="si">}</span><span class="s2">_std_estimate&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_model_coordinates</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">observations</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the model coordinates for the training DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Data coordinates</span>
        <span class="n">model_coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;observations&quot;</span><span class="p">:</span> <span class="n">observations</span><span class="p">,</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

        <span class="c1"># Additional coordinates for covariates</span>
        <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
                        <span class="n">model_coords</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_splines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                    <span class="n">model_coords</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_linear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                <span class="n">model_coords</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">categories</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid covariate type &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_coords</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_linear_correlation_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cov</span><span class="p">:</span> <span class="n">CovariateSpec</span><span class="p">,</span>
        <span class="n">effects_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model a linear effect for a numerical covariate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Linear effect</span>
        <span class="n">linear_beta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;linear_beta_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_linear&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="n">effects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">((</span><span class="n">train_data</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="n">linear_beta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Increment parameter count for linear effect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_spline_correlation_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cov</span><span class="p">:</span> <span class="n">CovariateSpec</span><span class="p">,</span>
        <span class="n">effects_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">spline_bases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="n">sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model a spline effect for a numerical covariate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Spline effect</span>
        <span class="n">spline_bases</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_bases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">make_spline_bases</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="n">spline_betas</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ZeroSumNormal</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;spline_betas_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">spline_bases</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_splines&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="c1"># Note ZeroSumNormal imposes a centering constraint (ensuring identifiability)</span>
        <span class="n">effects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spline_bases</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">spline_betas</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
        <span class="c1"># Increment parameter count for spline effects</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">df</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_categorical_correlation_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cov</span><span class="p">:</span> <span class="n">CovariateSpec</span><span class="p">,</span>
        <span class="n">effects_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">category_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="n">sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">sigma_hierarchical_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model the effect of a categorical covariate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Factorize categories</span>
        <span class="n">category_indices</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">factorize_categories</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">hierarchical</span><span class="p">:</span>
            <span class="c1"># Hierarchical categorical effect</span>
            <span class="c1"># Hyperpriors for category (Bayesian equivalent of random effects)</span>
            <span class="n">sigma_intercept_category</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;sigma_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;scalar&quot;</span><span class="p">,),</span>
            <span class="p">)</span>

            <span class="c1"># Hierarchical intercepts for each category (using reparameterized form)</span>
            <span class="n">categorical_intercept_offset</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ZeroSumNormal</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;intercept_offset_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_hierarchical_prior</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="c1"># Note ZeroSumNormal imposes a centering constraint</span>
            <span class="c1"># (ensuring identifiability)</span>
            <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">categorical_intercept_offset</span>
                    <span class="o">*</span> <span class="n">pt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sigma_intercept_category</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>

            <span class="c1"># Increment parameter count for hierarchical intercept</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Non-hierarchical (linear) categorical effect</span>
            <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ZeroSumNormal</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="c1"># Note ZeroSumNormal imposes a centering constraint</span>
            <span class="c1"># (ensuring identifiability)</span>
        <span class="n">effects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">categorical_intercept</span><span class="p">[</span><span class="n">category_indices</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]],</span>
        <span class="p">)</span>
        <span class="c1"># Increment parameter count for categorical effects</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_all_correlation_effects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">z_transformed_correlation_effects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">combination_indices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">combination_weights</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">standardized_vois</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">standardized_vois_mu_estimate</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">standardized_vois_std_estimate</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine all effects to model the observed data likelihood from the list of</span>
<span class="sd">        correlation effects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Combine all covariance effects</span>
        <span class="n">z_transformed_correlation_estimate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z_transformed_correlation_effects</span><span class="p">)</span>

        <span class="c1"># Convert z-transformed score to correlation</span>
        <span class="n">correlation_estimate</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">z_transformed_correlation_estimate</span><span class="p">)</span>

        <span class="c1"># Now apply the random combinations to get final distribution estimates</span>
        <span class="c1"># Apply combination weights for mu estimate</span>
        <span class="n">combined_mu_estimate</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span>
                <span class="n">standardized_vois_mu_estimate</span><span class="p">[</span><span class="n">combination_indices</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">combination_weights</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Apply combination weights for sigma estimate</span>
        <span class="n">combined_sigma_estimate</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span>
            <span class="n">standardized_vois_std_estimate</span><span class="p">[</span><span class="n">combination_indices</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">combination_weights</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Apply combination weights for correlation estimate</span>
        <span class="n">combined_correlation_estimate</span> <span class="o">=</span> <span class="n">correlation_estimate</span><span class="p">[</span><span class="n">combination_indices</span><span class="p">]</span>  <span class="c1"># pyright: ignore[reportOptionalSubscript]</span>
        <span class="c1"># Now build the std estimate</span>
        <span class="n">combined_std_estimate</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">combined_sigma_estimate</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># pyright: ignore[reportOptionalSubscript]</span>
            <span class="o">+</span> <span class="n">combined_sigma_estimate</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># pyright: ignore[reportOptionalSubscript]</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">*</span> <span class="n">combined_sigma_estimate</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># pyright: ignore[reportOptionalSubscript]</span>
                <span class="o">*</span> <span class="n">combined_sigma_estimate</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># pyright: ignore[reportOptionalSubscript]</span>
                <span class="o">*</span> <span class="n">combined_correlation_estimate</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Apply combination to the variables of interest</span>
        <span class="n">combined_variable_of_interest</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span>
                <span class="n">standardized_vois</span><span class="p">[</span><span class="n">combination_indices</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">combination_weights</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Model likelihood estimation for covariance model</span>
        <span class="n">_likelihood</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;likelihood_cov_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="n">combined_mu_estimate</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">combined_std_estimate</span><span class="p">,</span>
            <span class="n">observed</span><span class="o">=</span><span class="n">combined_variable_of_interest</span><span class="p">,</span>
            <span class="n">total_size</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;sample_size&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fit_model_with_advi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the model using Automatic Differentiation Variational Inference (ADVI).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;adam_learning_rate&quot;</span><span class="p">]</span>
        <span class="n">decay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;adam_learning_rate_decay&quot;</span><span class="p">]</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">shared</span><span class="p">(</span><span class="n">base_lr</span><span class="p">)</span>  <span class="c1"># type: ignore[no-untyped-call]  # type: ignore[no-untyped-call]</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>

        <span class="c1"># Adaptive learning rate schedule callback</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">update_learning_rate</span><span class="p">(</span><span class="n">_approx</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">_loss</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lr</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">base_lr</span> <span class="o">*</span> <span class="p">(</span><span class="n">decay</span><span class="o">**</span><span class="n">iteration</span><span class="p">))</span>

        <span class="c1"># Run automatic differential variational inference to fit the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;advi&quot;</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;advi_iterations&quot;</span><span class="p">],</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">],</span>  <span class="c1"># For reproducibility</span>
            <span class="n">obj_optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span>
                <span class="n">update_learning_rate</span><span class="p">,</span>
                <span class="n">pm</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">CheckParametersConvergence</span><span class="p">(</span>
                    <span class="n">tolerance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;advi_convergence_tolerance&quot;</span><span class="p">],</span>
                    <span class="n">diff</span><span class="o">=</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">progressbar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Sample from the posterior distribution and store the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="mi">2000</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Compute posterior means and standard deviations</span>
        <span class="n">posterior_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;draw&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">posterior_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
            <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;draw&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Store posterior means and stds as a dictionary in model parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">posterior_means</span><span class="o">.</span><span class="n">data_vars</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">posterior_means</span><span class="o">.</span><span class="n">data_vars</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_stds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">posterior_stds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">posterior_stds</span><span class="o">.</span><span class="n">data_vars</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the normative model to the training data.</span>

<span class="sd">        This method implements the fitting logic for the normative model</span>
<span class="sd">        based on the provided training data and model specification.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_data: pd.DataFrame</span>
<span class="sd">                DataFrame containing the training data. It must include the variable</span>
<span class="sd">                of interest, their predicted moments, and all specified covariates.</span>
<span class="sd">            save_directory: Path | None</span>
<span class="sd">                A path to a directory to save the model. If provided, the fitted model</span>
<span class="sd">                will be saved to this path.</span>
<span class="sd">            progress_bar: bool</span>
<span class="sd">                If True, display a progress bar during fitting. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validation checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dataframe_for_fitting</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

        <span class="c1"># Random number generator seed for reproducibility</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">])</span>

        <span class="c1"># A dictionary to hold the model parameters after fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Data preparation</span>
        <span class="c1"># Combination weights</span>
        <span class="n">combination_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">combination_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span>
                <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                    <span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">],</span>
                        <span class="mi">2</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="c1"># Data coordinates</span>
        <span class="n">combination_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">repeats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">model_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_model_coordinates</span><span class="p">(</span>
            <span class="n">observations</span><span class="o">=</span><span class="n">combination_indices</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Fitting logic</span>
        <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">model_coords</span><span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="c1"># Standardize the variable of interest, and store mean and std</span>
            <span class="c1"># This is done to ensure that the model is not sensitive to</span>
            <span class="c1"># the scale of the variable</span>
            <span class="n">variables_of_interest</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_vois&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables_of_interest</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_vois&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables_of_interest</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">standardized_vois</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">variables_of_interest</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_vois&quot;</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_vois&quot;</span><span class="p">]</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="n">variables_of_interest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;sample_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_size</span>
            <span class="n">variables_of_interest_mu_estimate</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="si">}</span><span class="s2">_mu_estimate&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="si">}</span><span class="s2">_mu_estimate&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">standardized_vois_mu_estimate</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">variables_of_interest_mu_estimate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_vois&quot;</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_vois&quot;</span><span class="p">]</span>
            <span class="n">variables_of_interest_std_estimate</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="si">}</span><span class="s2">_std_estimate&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="si">}</span><span class="s2">_std_estimate&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">standardized_vois_std_estimate</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">variables_of_interest_std_estimate</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_vois&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Create a list to contain the effects of covariates on</span>
            <span class="c1"># the z-transformed correlation</span>
            <span class="n">z_transformed_correlation_effects</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># A dictionary for precomputed bspline basis functions</span>
            <span class="n">spline_bases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># A dictionary for factorized categories</span>
            <span class="n">category_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Model the z-transformed correlation between the variables of interest</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Initialize parameter count</span>
            <span class="c1"># Model the global intercept for z</span>
            <span class="n">global_intercept_z</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
                <span class="s2">&quot;global_intercept_z&quot;</span><span class="p">,</span>
                <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;scalar&quot;</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="n">z_transformed_correlation_effects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_intercept_z</span><span class="p">)</span>
            <span class="c1"># Increment parameter count for global intercept</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Model additional covariate effects on the z estimate</span>
            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_covariance</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_model_linear_correlation_effect</span><span class="p">(</span>
                                <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
                                <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span>
                                <span class="n">effects_list</span><span class="o">=</span><span class="n">z_transformed_correlation_effects</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_model_spline_correlation_effect</span><span class="p">(</span>
                                <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
                                <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span>
                                <span class="n">effects_list</span><span class="o">=</span><span class="n">z_transformed_correlation_effects</span><span class="p">,</span>
                                <span class="n">spline_bases</span><span class="o">=</span><span class="n">spline_bases</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_model_categorical_correlation_effect</span><span class="p">(</span>
                            <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
                            <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span>
                            <span class="n">effects_list</span><span class="o">=</span><span class="n">z_transformed_correlation_effects</span><span class="p">,</span>
                            <span class="n">category_indices</span><span class="o">=</span><span class="n">category_indices</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Invalid covariate type &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

            <span class="c1"># Combine all covariance effects</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_combine_all_correlation_effects</span><span class="p">(</span>
                <span class="n">z_transformed_correlation_effects</span><span class="o">=</span><span class="n">z_transformed_correlation_effects</span><span class="p">,</span>
                <span class="n">combination_indices</span><span class="o">=</span><span class="n">combination_indices</span><span class="p">,</span>
                <span class="n">combination_weights</span><span class="o">=</span><span class="n">combination_weights</span><span class="p">,</span>
                <span class="n">standardized_vois</span><span class="o">=</span><span class="n">standardized_vois</span><span class="p">,</span>
                <span class="n">standardized_vois_mu_estimate</span><span class="o">=</span><span class="n">standardized_vois_mu_estimate</span><span class="p">,</span>
                <span class="n">standardized_vois_std_estimate</span><span class="o">=</span><span class="n">standardized_vois_std_estimate</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Fit the model using ADVI</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_model_with_advi</span><span class="p">(</span><span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">)</span>

        <span class="c1"># Save the model if a save path is provided</span>
        <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict correlation for new data (from covariates) using the fitted model.</span>

<span class="sd">        Args:</span>
<span class="sd">            test_covariates: pd.DataFrame</span>
<span class="sd">                DataFrame containing the new covariate data to predict.</span>
<span class="sd">                This must include all specified covariates.</span>
<span class="sd">            model_params: dict | None</span>
<span class="sd">                Optional dictionary of model parameters to use. If not provided,</span>
<span class="sd">                the stored parameters from model.fit() will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            NormativePredictions: Object containing the predicted pairwise correlations</span>
<span class="sd">                for the variables of interest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the new data</span>
        <span class="n">validation_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">]</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_dataframe</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">,</span> <span class="n">validation_columns</span><span class="p">)</span>

        <span class="c1"># Parameters</span>
        <span class="k">if</span> <span class="n">model_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>

        <span class="c1"># Posterior means</span>
        <span class="n">posterior_means</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">]</span>

        <span class="c1"># Calculate mean and variance effects</span>
        <span class="n">z_transformed_correlation_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_covariates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">posterior_means</span><span class="p">[</span><span class="s2">&quot;global_intercept_z&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_covariance</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Covariate &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is missing moments for&quot;</span>
                                <span class="s2">&quot; standardization.&quot;</span>
                            <span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="n">z_transformed_correlation_estimate</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="o">/</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span> <span class="o">*</span> <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;linear_beta_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                        <span class="n">spline_bases</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">make_spline_bases</span><span class="p">(</span>
                            <span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="p">)</span>
                        <span class="n">spline_betas</span> <span class="o">=</span> <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;spline_betas_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                        <span class="n">z_transformed_correlation_estimate</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">spline_bases</span> <span class="o">@</span> <span class="n">spline_betas</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="n">category_indices</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">factorize_categories</span><span class="p">(</span>
                        <span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="p">)</span>
                    <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">hierarchical</span><span class="p">:</span>
                        <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;intercept_offset_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                            <span class="o">*</span> <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;sigma_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="n">z_transformed_correlation_estimate</span> <span class="o">+=</span> <span class="n">categorical_intercept</span><span class="p">[</span>
                        <span class="n">category_indices</span>
                    <span class="p">]</span>

        <span class="c1"># Convert z-transformed score to correlation</span>
        <span class="n">correlation_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">z_transformed_correlation_estimate</span><span class="p">)</span>

        <span class="c1"># Create a the predictions object and return</span>
        <span class="k">return</span> <span class="n">NormativePredictions</span><span class="p">({</span><span class="s2">&quot;correlation_estimate&quot;</span><span class="p">:</span> <span class="n">correlation_estimate</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.CovarianceNormativeModel.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>String representation of the CovarianceNormativeModel instance.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    String representation of the CovarianceNormativeModel instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;CovarianceNormativeModel(</span><span class="se">\n\t</span><span class="s2">spec=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">, </span><span class="se">\n\t</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;batch_covariates=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_covariates</span><span class="si">}</span><span class="se">\n</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.CovarianceNormativeModel.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Fit the normative model to the training data.</p>
<p>This method implements the fitting logic for the normative model
based on the provided training data and model specification.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_data</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the training data. It must include the variable
of interest, their predicted moments, and all specified covariates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path | None
A path to a directory to save the model. If provided, the fitted model
will be saved to this path.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress_bar</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool
If True, display a progress bar during fitting. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit the normative model to the training data.</span>

<span class="sd">    This method implements the fitting logic for the normative model</span>
<span class="sd">    based on the provided training data and model specification.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_data: pd.DataFrame</span>
<span class="sd">            DataFrame containing the training data. It must include the variable</span>
<span class="sd">            of interest, their predicted moments, and all specified covariates.</span>
<span class="sd">        save_directory: Path | None</span>
<span class="sd">            A path to a directory to save the model. If provided, the fitted model</span>
<span class="sd">            will be saved to this path.</span>
<span class="sd">        progress_bar: bool</span>
<span class="sd">            If True, display a progress bar during fitting. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validation checks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_model</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dataframe_for_fitting</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

    <span class="c1"># Random number generator seed for reproducibility</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">])</span>

    <span class="c1"># A dictionary to hold the model parameters after fitting</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Data preparation</span>
    <span class="c1"># Combination weights</span>
    <span class="n">combination_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">combination_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span>
            <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                <span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">],</span>
                    <span class="mi">2</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="c1"># Data coordinates</span>
    <span class="n">combination_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
        <span class="n">repeats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;augmentation_multiplicity&quot;</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">model_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_model_coordinates</span><span class="p">(</span>
        <span class="n">observations</span><span class="o">=</span><span class="n">combination_indices</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Fitting logic</span>
    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">model_coords</span><span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
        <span class="c1"># Standardize the variable of interest, and store mean and std</span>
        <span class="c1"># This is done to ensure that the model is not sensitive to</span>
        <span class="c1"># the scale of the variable</span>
        <span class="n">variables_of_interest</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_vois&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables_of_interest</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_vois&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables_of_interest</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">standardized_vois</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">variables_of_interest</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_vois&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_vois&quot;</span><span class="p">]</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="n">variables_of_interest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;sample_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="n">variables_of_interest_mu_estimate</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="si">}</span><span class="s2">_mu_estimate&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="si">}</span><span class="s2">_mu_estimate&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">standardized_vois_mu_estimate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">variables_of_interest_mu_estimate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_vois&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_vois&quot;</span><span class="p">]</span>
        <span class="n">variables_of_interest_std_estimate</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_1</span><span class="si">}</span><span class="s2">_std_estimate&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest_2</span><span class="si">}</span><span class="s2">_std_estimate&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">standardized_vois_std_estimate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">variables_of_interest_std_estimate</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_vois&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Create a list to contain the effects of covariates on</span>
        <span class="c1"># the z-transformed correlation</span>
        <span class="n">z_transformed_correlation_effects</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># A dictionary for precomputed bspline basis functions</span>
        <span class="n">spline_bases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># A dictionary for factorized categories</span>
        <span class="n">category_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Model the z-transformed correlation between the variables of interest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Initialize parameter count</span>
        <span class="c1"># Model the global intercept for z</span>
        <span class="n">global_intercept_z</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="s2">&quot;global_intercept_z&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;scalar&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="n">z_transformed_correlation_effects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_intercept_z</span><span class="p">)</span>
        <span class="c1"># Increment parameter count for global intercept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Model additional covariate effects on the z estimate</span>
        <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_covariance</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_model_linear_correlation_effect</span><span class="p">(</span>
                            <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
                            <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span>
                            <span class="n">effects_list</span><span class="o">=</span><span class="n">z_transformed_correlation_effects</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_model_spline_correlation_effect</span><span class="p">(</span>
                            <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
                            <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span>
                            <span class="n">effects_list</span><span class="o">=</span><span class="n">z_transformed_correlation_effects</span><span class="p">,</span>
                            <span class="n">spline_bases</span><span class="o">=</span><span class="n">spline_bases</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_model_categorical_correlation_effect</span><span class="p">(</span>
                        <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
                        <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span>
                        <span class="n">effects_list</span><span class="o">=</span><span class="n">z_transformed_correlation_effects</span><span class="p">,</span>
                        <span class="n">category_indices</span><span class="o">=</span><span class="n">category_indices</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid covariate type &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># Combine all covariance effects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combine_all_correlation_effects</span><span class="p">(</span>
            <span class="n">z_transformed_correlation_effects</span><span class="o">=</span><span class="n">z_transformed_correlation_effects</span><span class="p">,</span>
            <span class="n">combination_indices</span><span class="o">=</span><span class="n">combination_indices</span><span class="p">,</span>
            <span class="n">combination_weights</span><span class="o">=</span><span class="n">combination_weights</span><span class="p">,</span>
            <span class="n">standardized_vois</span><span class="o">=</span><span class="n">standardized_vois</span><span class="p">,</span>
            <span class="n">standardized_vois_mu_estimate</span><span class="o">=</span><span class="n">standardized_vois_mu_estimate</span><span class="p">,</span>
            <span class="n">standardized_vois_std_estimate</span><span class="o">=</span><span class="n">standardized_vois_std_estimate</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Fit the model using ADVI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_model_with_advi</span><span class="p">(</span><span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">)</span>

    <span class="c1"># Save the model if a save path is provided</span>
    <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.CovarianceNormativeModel.from_direct_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_direct_model</span><span class="p">(</span><span class="n">direct_model</span><span class="p">:</span> <span class="n">DirectNormativeModel</span><span class="p">,</span> <span class="n">variable_of_interest_1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">variable_of_interest_2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">influencing_covariance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">defaults_overwrite</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CovarianceNormativeModel</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the model from a direct model instance, and two variable names.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>direct_model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DirectNormativeModel


  
      dataclass
   (spectranorm.snm.DirectNormativeModel)" href="#spectranorm.snm.DirectNormativeModel">DirectNormativeModel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DirectNormativeModel
This model will be used to instantiate a similar covariance model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>variable_of_interest_1</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Name of the first target variable to model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>variable_of_interest_2</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Name of the second target variable to model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>influencing_covariance</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of covariates that influence the covariance structure. If not
provided, this will be copied from the direct model's
<code>influencing_variance</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="CovarianceNormativeModel


  
      dataclass
   (spectranorm.snm.CovarianceNormativeModel)" href="#spectranorm.snm.CovarianceNormativeModel">CovarianceNormativeModel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CovarianceNormativeModel
An instance of CovarianceNormativeModel initialized with the provided
data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_direct_model</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">direct_model</span><span class="p">:</span> <span class="n">DirectNormativeModel</span><span class="p">,</span>
    <span class="n">variable_of_interest_1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">variable_of_interest_2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">influencing_covariance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">defaults_overwrite</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CovarianceNormativeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the model from a direct model instance, and two variable names.</span>

<span class="sd">    Args:</span>
<span class="sd">        direct_model: DirectNormativeModel</span>
<span class="sd">            This model will be used to instantiate a similar covariance model.</span>
<span class="sd">        variable_of_interest_1: str</span>
<span class="sd">            Name of the first target variable to model.</span>
<span class="sd">        variable_of_interest_2: str</span>
<span class="sd">            Name of the second target variable to model.</span>
<span class="sd">        influencing_covariance: list[str] | None</span>
<span class="sd">            List of covariates that influence the covariance structure. If not</span>
<span class="sd">            provided, this will be copied from the direct model&#39;s</span>
<span class="sd">            `influencing_variance`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        CovarianceNormativeModel</span>
<span class="sd">            An instance of CovarianceNormativeModel initialized with the provided</span>
<span class="sd">            data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validity checks for input parameters</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">direct_model</span><span class="p">,</span> <span class="n">DirectNormativeModel</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;direct_model must be an instance of DirectNormativeModel.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable_of_interest_1</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable_of_interest_2</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Variables of interest must be strings.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="c1"># Substitute influencing_covariance if not provided</span>
    <span class="k">if</span> <span class="n">influencing_covariance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">influencing_covariance</span> <span class="o">=</span> <span class="n">direct_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_variance</span>

    <span class="c1"># Use the same setup as the direct model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">=</span><span class="n">CovarianceModelSpec</span><span class="p">(</span>
            <span class="n">variable_of_interest_1</span><span class="o">=</span><span class="n">variable_of_interest_1</span><span class="p">,</span>
            <span class="n">variable_of_interest_2</span><span class="o">=</span><span class="n">variable_of_interest_2</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="n">direct_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
            <span class="n">influencing_covariance</span><span class="o">=</span><span class="n">influencing_covariance</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">batch_covariates</span><span class="o">=</span><span class="n">direct_model</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># update defaults</span>
    <span class="n">model</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">direct_model</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults_overwrite</span> <span class="ow">or</span> <span class="p">{})</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.CovarianceNormativeModel.load_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_model</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">load_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CovarianceNormativeModel</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Load the model and its posterior from a directory.
The model will be loaded from a subdirectory named 'saved_model'.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path
Path to the directory containing the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>load_posterior</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool (default=False)
If True, load the model's posterior trace from the saved inference data.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">load_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CovarianceNormativeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the model and its posterior from a directory.</span>
<span class="sd">    The model will be loaded from a subdirectory named &#39;saved_model&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory: Path</span>
<span class="sd">            Path to the directory containing the model.</span>
<span class="sd">        load_posterior: bool (default=False)</span>
<span class="sd">            If True, load the model&#39;s posterior trace from the saved inference data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate the load directory</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_load_directory</span><span class="p">(</span>
        <span class="n">directory</span><span class="p">,</span>
        <span class="s2">&quot;saved_model&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Load the saved model dict</span>
    <span class="n">model_dict</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_dict.joblib&quot;</span><span class="p">)</span>

    <span class="c1"># Create an instance of the class</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span>
        <span class="n">batch_covariates</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;batch_covariates&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Set the attributes from the loaded model dictionary</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;defaults&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;model_params&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">load_posterior</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">model_inference_data</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_netcdf</span><span class="p">(</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
                <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_inference_data.nc&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.CovarianceNormativeModel.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Predict correlation for new data (from covariates) using the fitted model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>test_covariates</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the new covariate data to predict.
This must include all specified covariates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict | None
Optional dictionary of model parameters to use. If not provided,
the stored parameters from model.fit() will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>NormativePredictions</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="NormativePredictions


  
      dataclass
   (spectranorm.snm.NormativePredictions)" href="#spectranorm.snm.NormativePredictions">NormativePredictions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object containing the predicted pairwise correlations
for the variables of interest.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predict correlation for new data (from covariates) using the fitted model.</span>

<span class="sd">    Args:</span>
<span class="sd">        test_covariates: pd.DataFrame</span>
<span class="sd">            DataFrame containing the new covariate data to predict.</span>
<span class="sd">            This must include all specified covariates.</span>
<span class="sd">        model_params: dict | None</span>
<span class="sd">            Optional dictionary of model parameters to use. If not provided,</span>
<span class="sd">            the stored parameters from model.fit() will be used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        NormativePredictions: Object containing the predicted pairwise correlations</span>
<span class="sd">            for the variables of interest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate the new data</span>
    <span class="n">validation_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">]</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_dataframe</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">,</span> <span class="n">validation_columns</span><span class="p">)</span>

    <span class="c1"># Parameters</span>
    <span class="k">if</span> <span class="n">model_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>

    <span class="c1"># Posterior means</span>
    <span class="n">posterior_means</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">]</span>

    <span class="c1"># Calculate mean and variance effects</span>
    <span class="n">z_transformed_correlation_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_covariates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span>
        <span class="n">posterior_means</span><span class="p">[</span><span class="s2">&quot;global_intercept_z&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_covariance</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Covariate &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is missing moments for&quot;</span>
                            <span class="s2">&quot; standardization.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="n">z_transformed_correlation_estimate</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="o">/</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;linear_beta_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                    <span class="n">spline_bases</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">make_spline_bases</span><span class="p">(</span>
                        <span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="p">)</span>
                    <span class="n">spline_betas</span> <span class="o">=</span> <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;spline_betas_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="n">z_transformed_correlation_estimate</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">spline_bases</span> <span class="o">@</span> <span class="n">spline_betas</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                <span class="n">category_indices</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">factorize_categories</span><span class="p">(</span>
                    <span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">hierarchical</span><span class="p">:</span>
                    <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;intercept_offset_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                        <span class="o">*</span> <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;sigma_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="n">posterior_means</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="n">z_transformed_correlation_estimate</span> <span class="o">+=</span> <span class="n">categorical_intercept</span><span class="p">[</span>
                    <span class="n">category_indices</span>
                <span class="p">]</span>

    <span class="c1"># Convert z-transformed score to correlation</span>
    <span class="n">correlation_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">z_transformed_correlation_estimate</span><span class="p">)</span>

    <span class="c1"># Create a the predictions object and return</span>
    <span class="k">return</span> <span class="n">NormativePredictions</span><span class="p">({</span><span class="s2">&quot;correlation_estimate&quot;</span><span class="p">:</span> <span class="n">correlation_estimate</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.CovarianceNormativeModel.save_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_model</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save the fitted model and it's posterior to a directory.
The model will be saved in a subdirectory named 'saved_model'.
If this directory is not empty, an error is raised.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path
Path to a directory to save the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_posterior</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool (default=False)
If True, save the model's posterior trace inference data.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the fitted model and it&#39;s posterior to a directory.</span>
<span class="sd">    The model will be saved in a subdirectory named &#39;saved_model&#39;.</span>
<span class="sd">    If this directory is not empty, an error is raised.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory: Path</span>
<span class="sd">            Path to a directory to save the model.</span>
<span class="sd">        save_posterior: bool (default=False)</span>
<span class="sd">            If True, save the model&#39;s posterior trace inference data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare the save directory</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">prepare_save_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;saved_model&quot;</span><span class="p">)</span>

    <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
        <span class="s2">&quot;batch_covariates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
        <span class="s2">&quot;defaults&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_params&quot;</span><span class="p">):</span>
        <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_inference_data&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">save_posterior</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span>
                <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_inference_data.nc&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_dict</span><span class="p">,</span> <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_dict.joblib&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="spectranorm.snm.CovariateSpec" class="doc doc-heading">
            <code>CovariateSpec</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Specification of a single covariate and how it should be modeled.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovariateSpec.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Name of the covariate (e.g., 'age', 'site').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovariateSpec.cov_type">cov_type</span></code></td>
            <td>
                  <code><span title="spectranorm.snm.CovariateType">CovariateType</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Type of the covariate ('numerical' or 'categorical').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovariateSpec.effect">effect</span></code></td>
            <td>
                  <code><span title="spectranorm.snm.NumericalEffect">NumericalEffect</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
For numerical covariates, how the effect is modeled ('linear'
or 'spline').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovariateSpec.categories">categories</span></code></td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.str_">str_</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray | None
For categorical covariates, the category labels stored as a NumPy array.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovariateSpec.hierarchical">hierarchical</span></code></td>
            <td>
                  <code><span title="bool">bool</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool
For categorical covariates, whether to model with a
hierarchical structure.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.CovariateSpec.spline_spec">spline_spec</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SplineSpec


  
      dataclass
   (spectranorm.snm.SplineSpec)" href="#spectranorm.snm.SplineSpec">SplineSpec</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SplineSpec | None
Optional SplineSpec instance for spline modeling;
required if effect is 'spline'.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="validation" open>
  <summary>Validation</summary>
  <ul>
<li>Numerical covariates must specify 'effect'.</li>
<li>If 'effect' is 'spline', 'spline_spec' must be provided.</li>
<li>Categorical covariates must specify 'hierarchical'.</li>
<li>Categorical covariates cannot have 'effect' or 'spline_spec'.</li>
<li>Categorical covariates must have categories listed.</li>
</ul>
</details>






              <details class="quote">
                <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CovariateSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specification of a single covariate and how it should be modeled.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of the covariate (e.g., &#39;age&#39;, &#39;site&#39;).</span>
<span class="sd">        cov_type: str</span>
<span class="sd">            Type of the covariate (&#39;numerical&#39; or &#39;categorical&#39;).</span>
<span class="sd">        effect: str</span>
<span class="sd">            For numerical covariates, how the effect is modeled (&#39;linear&#39;</span>
<span class="sd">            or &#39;spline&#39;).</span>
<span class="sd">        categories: np.ndarray | None</span>
<span class="sd">            For categorical covariates, the category labels stored as a NumPy array.</span>
<span class="sd">        hierarchical: bool</span>
<span class="sd">            For categorical covariates, whether to model with a</span>
<span class="sd">            hierarchical structure.</span>
<span class="sd">        spline_spec: SplineSpec | None</span>
<span class="sd">            Optional SplineSpec instance for spline modeling;</span>
<span class="sd">            required if effect is &#39;spline&#39;.</span>

<span class="sd">    Validation:</span>
<span class="sd">        - Numerical covariates must specify &#39;effect&#39;.</span>
<span class="sd">        - If &#39;effect&#39; is &#39;spline&#39;, &#39;spline_spec&#39; must be provided.</span>
<span class="sd">        - Categorical covariates must specify &#39;hierarchical&#39;.</span>
<span class="sd">        - Categorical covariates cannot have &#39;effect&#39; or &#39;spline_spec&#39;.</span>
<span class="sd">        - Categorical covariates must have categories listed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">cov_type</span><span class="p">:</span> <span class="n">CovariateType</span>  <span class="c1"># &quot;categorical&quot; or &quot;numerical&quot;</span>
    <span class="n">effect</span><span class="p">:</span> <span class="n">NumericalEffect</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Only if numerical</span>
    <span class="n">categories</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Only if categorical</span>
    <span class="n">hierarchical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Only if categorical</span>
    <span class="n">spline_spec</span><span class="p">:</span> <span class="n">SplineSpec</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Only for spline modeling</span>
    <span class="n">moments</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Only for linear effects</span>

    <span class="c1"># Validation checks for the covariate specification.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_numerical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;spline&quot;</span><span class="p">}:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Numerical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must specify effect as &quot;</span>
                <span class="s2">&quot;&#39;linear&#39; or &#39;spline&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Numerical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; should not specify &#39;hierarchical&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Numerical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; should not specify &#39;categories&#39;.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Numerical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must have spline &quot;</span>
                    <span class="s2">&quot;specification if effect is &#39;spline&#39;.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Numerical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; should not specify &quot;</span>
                    <span class="s2">&quot;moments if effect is &#39;spline&#39;.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Numerical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; should not have spline &quot;</span>
                    <span class="s2">&quot;specification unless effect is &#39;spline&#39;.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Numerical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must specify moments &quot;</span>
                    <span class="s2">&quot;(mean and standard deviation) for linear effects.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_categorical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Categorical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; should not have a &quot;</span>
                <span class="s2">&quot;numerical effect type.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Categorical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; should not have spline &quot;</span>
                <span class="s2">&quot;specification.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Categorical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must specify whether &quot;</span>
                <span class="s2">&quot;it is hierarchical.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Categorical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must specify categories.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Categorical covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must specify categories &quot;</span>
                <span class="s2">&quot;as a NumPy array.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_numerical</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_categorical</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid covariate type &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_spline_bases</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_intercept</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create B-spline basis expansion functions for a given covariate.</span>

<span class="sd">        Args:</span>
<span class="sd">            values (np.ndarray): The values to create the spline basis functions for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The B-spline basis function expansion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect</span> <span class="o">!=</span> <span class="s2">&quot;spline&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is not a spline covariate.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># Create B-spline basis functions</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">patsy</span><span class="o">.</span><span class="n">bs</span><span class="p">(</span>  <span class="c1"># pyright: ignore[reportAttributeAccessIssue]</span>
                <span class="n">values</span><span class="p">,</span>
                <span class="n">knots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">knots</span><span class="p">,</span>
                <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
                <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
                <span class="n">lower_bound</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">,</span>
                <span class="n">upper_bound</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">,</span>
                <span class="n">include_intercept</span><span class="o">=</span><span class="n">include_intercept</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">factorize_categories</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Factorize categorical covariate values into numerical indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            values (np.ndarray): The values to factorize.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The factorized numerical indices for the categories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">!=</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is not a categorical &quot;</span>
                <span class="s2">&quot;covariate to be factorized.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># Create a mapping from category values to indices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not have categories defined.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">category_mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">category</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1"># Factorize the values using the mapping</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">category_mapping</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.CovariateSpec.factorize_categories" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">factorize_categories</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Factorize categorical covariate values into numerical indices.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>values</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The values to factorize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.int_">int_</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray: The factorized numerical indices for the categories.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">factorize_categories</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Factorize categorical covariate values into numerical indices.</span>

<span class="sd">    Args:</span>
<span class="sd">        values (np.ndarray): The values to factorize.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: The factorized numerical indices for the categories.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">!=</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is not a categorical &quot;</span>
            <span class="s2">&quot;covariate to be factorized.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="c1"># Create a mapping from category values to indices</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
        <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not have categories defined.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="n">category_mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">category</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1"># Factorize the values using the mapping</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">category_mapping</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.CovariateSpec.make_spline_bases" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_spline_bases</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_intercept</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create B-spline basis expansion functions for a given covariate.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>values</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The values to create the spline basis functions for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray: The B-spline basis function expansion.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_spline_bases</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">include_intercept</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create B-spline basis expansion functions for a given covariate.</span>

<span class="sd">    Args:</span>
<span class="sd">        values (np.ndarray): The values to create the spline basis functions for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: The B-spline basis function expansion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect</span> <span class="o">!=</span> <span class="s2">&quot;spline&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Covariate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is not a spline covariate.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="c1"># Create B-spline basis functions</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">patsy</span><span class="o">.</span><span class="n">bs</span><span class="p">(</span>  <span class="c1"># pyright: ignore[reportAttributeAccessIssue]</span>
            <span class="n">values</span><span class="p">,</span>
            <span class="n">knots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">knots</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
            <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
            <span class="n">lower_bound</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">,</span>
            <span class="n">upper_bound</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">,</span>
            <span class="n">include_intercept</span><span class="o">=</span><span class="n">include_intercept</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="spectranorm.snm.DirectNormativeModel" class="doc doc-heading">
            <code>DirectNormativeModel</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Direct normative model implementation.</p>
<p>This class implements the direct normative modeling approach, which
directly models the variable of interest using the specified covariates.
It can be used to fit a model to data and predict normative centiles.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.DirectNormativeModel.spec">spec</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="NormativeModelSpec


  
      dataclass
   (spectranorm.snm.NormativeModelSpec)" href="#spectranorm.snm.NormativeModelSpec">NormativeModelSpec</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NormativeModelSpec
Specification of the normative model including variable of interest,
covariates, and data source.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.DirectNormativeModel.batch_covariates">batch_covariates</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]
List of covariate names that are treated as batch effects.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.DirectNormativeModel.defaults">defaults</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict
Default parameters for the model, including spline specifications,
ADVI iterations, convergence tolerance, random seed, and Adam optimizer
learning rates.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DirectNormativeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Direct normative model implementation.</span>

<span class="sd">    This class implements the direct normative modeling approach, which</span>
<span class="sd">    directly models the variable of interest using the specified covariates.</span>
<span class="sd">    It can be used to fit a model to data and predict normative centiles.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        spec: NormativeModelSpec</span>
<span class="sd">            Specification of the normative model including variable of interest,</span>
<span class="sd">            covariates, and data source.</span>
<span class="sd">        batch_covariates: list[str]</span>
<span class="sd">            List of covariate names that are treated as batch effects.</span>
<span class="sd">        defaults: dict</span>
<span class="sd">            Default parameters for the model, including spline specifications,</span>
<span class="sd">            ADVI iterations, convergence tolerance, random seed, and Adam optimizer</span>
<span class="sd">            learning rates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">spec</span><span class="p">:</span> <span class="n">NormativeModelSpec</span>
    <span class="n">batch_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;spline_df&quot;</span><span class="p">:</span> <span class="n">DEFAULT_SPLINE_DF</span><span class="p">,</span>
            <span class="s2">&quot;spline_degree&quot;</span><span class="p">:</span> <span class="n">DEFAULT_SPLINE_DEGREE</span><span class="p">,</span>
            <span class="s2">&quot;spline_extrapolation_factor&quot;</span><span class="p">:</span> <span class="n">DEFAULT_SPLINE_EXTRAPOLATION_FACTOR</span><span class="p">,</span>
            <span class="s2">&quot;advi_iterations&quot;</span><span class="p">:</span> <span class="n">DEFAULT_ADVI_ITERATIONS</span><span class="p">,</span>
            <span class="s2">&quot;advi_convergence_tolerance&quot;</span><span class="p">:</span> <span class="n">DEFAULT_ADVI_CONVERGENCE_TOLERANCE</span><span class="p">,</span>
            <span class="s2">&quot;random_seed&quot;</span><span class="p">:</span> <span class="n">DEFAULT_RANDOM_SEED</span><span class="p">,</span>
            <span class="s2">&quot;adam_learning_rate&quot;</span><span class="p">:</span> <span class="n">DEFAULT_ADAM_LEARNING_RATE</span><span class="p">,</span>
            <span class="s2">&quot;adam_learning_rate_decay&quot;</span><span class="p">:</span> <span class="n">DEFAULT_ADAM_LEARNING_RATE_DECAY</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation of the DirectNormativeModel instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;DirectNormativeModel(</span><span class="se">\n\t</span><span class="s2">spec=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">, </span><span class="se">\n\t</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;batch_covariates=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_covariates</span><span class="si">}</span><span class="se">\n</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_init_args</span><span class="p">(</span>
        <span class="n">model_type</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">,</span>
        <span class="n">variable_of_interest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">numerical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">categorical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">batch_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">nonlinear_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Validity checks for input parameters</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;HBR&quot;</span><span class="p">,</span> <span class="s2">&quot;BLR&quot;</span><span class="p">}:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid model type &#39;</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;HBR&#39; or &#39;BLR&#39;.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">list_name</span><span class="p">,</span> <span class="n">covariate_list</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;numerical&quot;</span><span class="p">,</span> <span class="n">numerical_covariates</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;categorical&quot;</span><span class="p">,</span> <span class="n">categorical_covariates</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="n">batch_covariates</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;nonlinear&quot;</span><span class="p">,</span> <span class="n">nonlinear_covariates</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">covariate_list</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;All covariate names must be strings: </span><span class="si">{</span><span class="n">list_name</span><span class="si">}</span><span class="s2"> covariates.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable_of_interest</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Variable of interest must be a string.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_covariates</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">batch_covariates</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;All batch covariates must be included in categorical covariates.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">numerical_covariates</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">nonlinear_covariates</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;All nonlinear covariates must be included in numerical covariates.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dataframe</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">model_type</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">,</span>
        <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">variable_of_interest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">numerical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">categorical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nonlinear_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">influencing_mean</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">influencing_variance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">spline_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DirectNormativeModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a normative model from a pandas DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_type: ModelType</span>
<span class="sd">                Type of the model to create, either &quot;HBR&quot; (Hierarchical Bayesian</span>
<span class="sd">                Regression) or &quot;BLR&quot; (Bayesian Linear Regression).</span>
<span class="sd">            dataframe: pd.DataFrame</span>
<span class="sd">                DataFrame containing the data.</span>
<span class="sd">            variable_of_interest: str</span>
<span class="sd">                Name of the target variable to model.</span>
<span class="sd">            numerical_covariates: list[str] | None</span>
<span class="sd">                List of numerical covariate names.</span>
<span class="sd">            categorical_covariates: list[str] | None</span>
<span class="sd">                List of categorical covariate names.</span>
<span class="sd">            batch_covariates: list[str] | None</span>
<span class="sd">                List of batch covariate names which should also be included in</span>
<span class="sd">                categorical_covariates.</span>
<span class="sd">            nonlinear_covariates: list[str] | None</span>
<span class="sd">                List of covariate names to be modeled as nonlinear effects.</span>
<span class="sd">                These should also be included in numerical_covariates.</span>
<span class="sd">            influencing_mean: list[str] | None</span>
<span class="sd">                List of covariate names that influence the mean of the variable</span>
<span class="sd">                of interest. These should be included in either numerical_covariates</span>
<span class="sd">                or categorical_covariates.</span>
<span class="sd">            influencing_variance: list[str] | None</span>
<span class="sd">                List of covariate names that influence the variance of the variable</span>
<span class="sd">                of interest. These should be included in either numerical_covariates</span>
<span class="sd">                or categorical_covariates.</span>
<span class="sd">            spline_kwargs: dict</span>
<span class="sd">                Additional keyword arguments for spline specification, such as</span>
<span class="sd">                `df`, `degree`, and `knots`. These are passed to the</span>
<span class="sd">                `create_spline_spec` method to create spline specifications for</span>
<span class="sd">                nonlinear covariates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DirectNormativeModel</span>
<span class="sd">                An instance of DirectNormativeModel initialized with the provided data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set default values for optional parameters</span>
        <span class="n">numerical_covariates</span> <span class="o">=</span> <span class="n">numerical_covariates</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">categorical_covariates</span> <span class="o">=</span> <span class="n">categorical_covariates</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">batch_covariates</span> <span class="o">=</span> <span class="n">batch_covariates</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">nonlinear_covariates</span> <span class="o">=</span> <span class="n">nonlinear_covariates</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">influencing_mean</span> <span class="o">=</span> <span class="n">influencing_mean</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">influencing_variance</span> <span class="o">=</span> <span class="n">influencing_variance</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">spline_kwargs</span> <span class="o">=</span> <span class="n">spline_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># Validity checks for input parameters</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_validate_init_args</span><span class="p">(</span>
            <span class="n">model_type</span><span class="p">,</span>
            <span class="n">variable_of_interest</span><span class="p">,</span>
            <span class="n">numerical_covariates</span><span class="p">,</span>
            <span class="n">categorical_covariates</span><span class="p">,</span>
            <span class="n">batch_covariates</span><span class="p">,</span>
            <span class="n">nonlinear_covariates</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_dataframe</span><span class="p">(</span>
            <span class="n">dataframe</span><span class="p">,</span>
            <span class="p">[</span><span class="n">variable_of_interest</span><span class="p">,</span> <span class="o">*</span><span class="n">numerical_covariates</span><span class="p">,</span> <span class="o">*</span><span class="n">categorical_covariates</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Create an instance of the class</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">=</span><span class="n">NormativeModelSpec</span><span class="p">(</span>
                <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">variable_of_interest</span><span class="p">,</span>
                <span class="n">covariates</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">influencing_mean</span><span class="o">=</span><span class="n">influencing_mean</span><span class="p">,</span>
                <span class="n">influencing_variance</span><span class="o">=</span><span class="n">influencing_variance</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">batch_covariates</span><span class="o">=</span><span class="n">batch_covariates</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Populate the spline_kwargs with defaults if not provided</span>
        <span class="n">spline_kwargs</span><span class="p">[</span><span class="s2">&quot;df&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;df&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;spline_df&quot;</span><span class="p">])</span>
        <span class="n">spline_kwargs</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;degree&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;spline_degree&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">spline_kwargs</span><span class="p">[</span><span class="s2">&quot;extrapolation_factor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;extrapolation_factor&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;spline_extrapolation_factor&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Start building the model specification</span>
        <span class="c1"># Add categorical covariates</span>
        <span class="k">for</span> <span class="n">cov_name</span> <span class="ow">in</span> <span class="n">categorical_covariates</span><span class="p">:</span>
            <span class="n">hierarchical</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">cov_name</span> <span class="ow">in</span> <span class="n">batch_covariates</span> <span class="ow">and</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;HBR&quot;</span><span class="p">:</span>
                <span class="n">hierarchical</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">CovariateSpec</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">cov_name</span><span class="p">,</span>
                    <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;categorical&quot;</span><span class="p">,</span>
                    <span class="n">categories</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                    <span class="n">hierarchical</span><span class="o">=</span><span class="n">hierarchical</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">cov_name</span> <span class="ow">in</span> <span class="n">numerical_covariates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nonlinear_covariates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">CovariateSpec</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">cov_name</span><span class="p">,</span>
                        <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;numerical&quot;</span><span class="p">,</span>
                        <span class="n">effect</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                        <span class="n">moments</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">dataframe</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                            <span class="n">dataframe</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">CovariateSpec</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">cov_name</span><span class="p">,</span>
                        <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;numerical&quot;</span><span class="p">,</span>
                        <span class="n">effect</span><span class="o">=</span><span class="s2">&quot;spline&quot;</span><span class="p">,</span>
                        <span class="n">spline_spec</span><span class="o">=</span><span class="n">SplineSpec</span><span class="o">.</span><span class="n">create_spline_spec</span><span class="p">(</span>
                            <span class="n">dataframe</span><span class="p">[</span><span class="n">cov_name</span><span class="p">],</span>
                            <span class="o">**</span><span class="n">spline_kwargs</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the model instance.</span>

<span class="sd">        This method checks if the model instance is complete and valid.</span>
<span class="sd">        It raises errors if any required fields are missing or if there are</span>
<span class="sd">        inconsistencies in the model specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Model specification is not set. &quot;</span>
                <span class="s2">&quot;Please initialize the model, e.g., with &#39;from_dataframe&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;No covariates specified in the model. &quot;</span>
                <span class="s2">&quot;Please add covariates to the specification.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_mean</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_variance</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;No covariates specified to influence the mean or &quot;</span>
                <span class="s2">&quot;variance of the variable of interest.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the fitted model and it&#39;s posterior to a directory.</span>
<span class="sd">        The model will be saved in a subdirectory named &#39;saved_model&#39;.</span>
<span class="sd">        If this directory is not empty, an error is raised.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory: Path</span>
<span class="sd">                Path to a directory to save the model.</span>
<span class="sd">            save_posterior: bool (default=False)</span>
<span class="sd">                If True, save the model&#39;s posterior trace inference data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare the save directory</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">prepare_save_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;saved_model&quot;</span><span class="p">)</span>

        <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
            <span class="s2">&quot;batch_covariates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
            <span class="s2">&quot;defaults&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_params&quot;</span><span class="p">):</span>
            <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_inference_data&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">save_posterior</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span>
                    <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_inference_data.nc&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_dict</span><span class="p">,</span> <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_dict.joblib&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">load_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DirectNormativeModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the model and its posterior from a directory.</span>
<span class="sd">        The model will be loaded from a subdirectory named &#39;saved_model&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory: Path</span>
<span class="sd">                Path to the directory containing the model.</span>
<span class="sd">            load_posterior: bool (default=False)</span>
<span class="sd">                If True, load the model&#39;s posterior trace from the saved inference data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the load directory</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_load_directory</span><span class="p">(</span>
            <span class="n">directory</span><span class="p">,</span>
            <span class="s2">&quot;saved_model&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Load the saved model dict</span>
        <span class="n">model_dict</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_dict.joblib&quot;</span><span class="p">)</span>

        <span class="c1"># Create an instance of the class</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span>
            <span class="n">batch_covariates</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;batch_covariates&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Set the attributes from the loaded model dictionary</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;defaults&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;model_params&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">load_posterior</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">model_inference_data</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_netcdf</span><span class="p">(</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
                    <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_inference_data.nc&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">instance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_dataframe_for_fitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the training DataFrame for fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_dataframe</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_model_coordinates</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">observations</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the model coordinates for the training DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Data coordinates</span>
        <span class="n">model_coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;observations&quot;</span><span class="p">:</span> <span class="n">observations</span><span class="p">,</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

        <span class="c1"># Additional coordinates for covariates</span>
        <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
                        <span class="n">model_coords</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_splines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                    <span class="n">model_coords</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_linear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                <span class="n">model_coords</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">categories</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid covariate type &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_coords</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_linear_mean_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cov</span><span class="p">:</span> <span class="n">CovariateSpec</span><span class="p">,</span>
        <span class="n">effects_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model a linear effect for a numerical covariate on the mean estimate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Linear effect</span>
        <span class="n">linear_beta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;linear_beta_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_linear&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="n">effects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">((</span><span class="n">train_data</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="n">linear_beta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Increment parameter count for linear effect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_spline_mean_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cov</span><span class="p">:</span> <span class="n">CovariateSpec</span><span class="p">,</span>
        <span class="n">effects_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">spline_bases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="n">sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model a spline effect for a numerical covariate on the mean estimate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Spline effect</span>
        <span class="n">spline_bases</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_bases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">make_spline_bases</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="n">spline_betas</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ZeroSumNormal</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;spline_betas_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">spline_bases</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_splines&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="c1"># Note ZeroSumNormal imposes a centering constraint (ensuring identifiability)</span>
        <span class="n">effects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spline_bases</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">spline_betas</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
        <span class="c1"># Increment parameter count for spline effects</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">df</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_categorical_mean_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cov</span><span class="p">:</span> <span class="n">CovariateSpec</span><span class="p">,</span>
        <span class="n">effects_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">category_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="n">sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">hierarchical_sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model the effect of a categorical covariate on the mean estimate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Factorize categories</span>
        <span class="n">category_indices</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">factorize_categories</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">hierarchical</span><span class="p">:</span>
            <span class="c1"># Hierarchical categorical effect</span>
            <span class="c1"># Hyperpriors for category (Bayesian equivalent of random effects)</span>
            <span class="n">sigma_intercept_category</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;sigma_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;scalar&quot;</span><span class="p">,),</span>
            <span class="p">)</span>

            <span class="c1"># Hierarchical intercepts for each category (using reparameterized form)</span>
            <span class="n">categorical_intercept_offset</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ZeroSumNormal</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;intercept_offset_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">hierarchical_sigma_prior</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="c1"># Note ZeroSumNormal imposes a centering constraint</span>
            <span class="c1"># (ensuring identifiability)</span>
            <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">categorical_intercept_offset</span>
                    <span class="o">*</span> <span class="n">pt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sigma_intercept_category</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>

            <span class="c1"># Increment parameter count for hierarchical intercept</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Non-hierarchical (linear) categorical effect</span>
            <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ZeroSumNormal</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="c1"># Note ZeroSumNormal imposes a centering constraint</span>
            <span class="c1"># (ensuring identifiability)</span>
        <span class="n">effects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">categorical_intercept</span><span class="p">[</span><span class="n">category_indices</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]],</span>
        <span class="p">)</span>
        <span class="c1"># Increment parameter count for categorical effects</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_all_mean_effects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">spline_bases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="n">category_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model all covariate mean effects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mean_effects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Model the global intercept</span>
        <span class="n">global_intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="s2">&quot;global_intercept&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;scalar&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="n">mean_effects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_intercept</span><span class="p">)</span>
        <span class="c1"># Increment parameter count for global intercept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Model additional covariate effects on the mean</span>
        <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_mean</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_model_linear_mean_effect</span><span class="p">(</span>
                            <span class="n">train_data</span><span class="p">,</span>
                            <span class="n">cov</span><span class="p">,</span>
                            <span class="n">mean_effects</span><span class="p">,</span>
                            <span class="n">sigma_prior</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_model_spline_mean_effect</span><span class="p">(</span>
                            <span class="n">train_data</span><span class="p">,</span>
                            <span class="n">cov</span><span class="p">,</span>
                            <span class="n">mean_effects</span><span class="p">,</span>
                            <span class="n">spline_bases</span><span class="p">,</span>
                            <span class="n">sigma_prior</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_model_categorical_mean_effect</span><span class="p">(</span>
                        <span class="n">train_data</span><span class="p">,</span>
                        <span class="n">cov</span><span class="p">,</span>
                        <span class="n">mean_effects</span><span class="p">,</span>
                        <span class="n">category_indices</span><span class="p">,</span>
                        <span class="n">sigma_prior</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">hierarchical_sigma_prior</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid covariate type &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mean_effects</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_linear_variance_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cov</span><span class="p">:</span> <span class="n">CovariateSpec</span><span class="p">,</span>
        <span class="n">effects_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model a linear effect for a numerical covariate on the variance estimate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Linear effect</span>
        <span class="n">linear_beta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;variance_linear_beta_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_linear&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="n">effects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">((</span><span class="n">train_data</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="n">linear_beta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Increment parameter count for linear effect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_spline_variance_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cov</span><span class="p">:</span> <span class="n">CovariateSpec</span><span class="p">,</span>
        <span class="n">effects_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">spline_bases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="n">sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model a spline effect for a numerical covariate on the variance estimate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Spline effect</span>
        <span class="n">spline_bases</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_bases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">make_spline_bases</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="n">spline_betas</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ZeroSumNormal</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;variance_spline_betas_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">spline_bases</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_splines&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="c1"># Note ZeroSumNormal imposes a centering constraint (ensuring identifiability)</span>
        <span class="n">effects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spline_bases</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">spline_betas</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
        <span class="c1"># Increment parameter count for spline effects</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cov</span><span class="o">.</span><span class="n">spline_spec</span><span class="o">.</span><span class="n">df</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_categorical_variance_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cov</span><span class="p">:</span> <span class="n">CovariateSpec</span><span class="p">,</span>
        <span class="n">effects_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">category_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="n">sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">hierarchical_sigma_prior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model the effect of a categorical covariate on the variance estimate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Factorize categories</span>
        <span class="n">category_indices</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">factorize_categories</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">hierarchical</span><span class="p">:</span>
            <span class="c1"># Hierarchical categorical effect</span>
            <span class="c1"># Hyperpriors for category (Bayesian equivalent of random effects)</span>
            <span class="n">sigma_intercept_category</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;variance_sigma_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;scalar&quot;</span><span class="p">,),</span>
            <span class="p">)</span>

            <span class="c1"># Hierarchical intercepts for each category (using reparameterized form)</span>
            <span class="n">categorical_intercept_offset</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ZeroSumNormal</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;variance_intercept_offset_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">hierarchical_sigma_prior</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="c1"># Note ZeroSumNormal imposes a centering constraint</span>
            <span class="c1"># (ensuring identifiability)</span>
            <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;variance_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">categorical_intercept_offset</span>
                    <span class="o">*</span> <span class="n">pt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sigma_intercept_category</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>

            <span class="c1"># Increment parameter count for hierarchical intercept</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Non-hierarchical (linear) categorical effect</span>
            <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ZeroSumNormal</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;variance_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_prior</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="c1"># Note ZeroSumNormal imposes a centering constraint</span>
            <span class="c1"># (ensuring identifiability)</span>
        <span class="n">effects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">categorical_intercept</span><span class="p">[</span><span class="n">category_indices</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]],</span>
        <span class="p">)</span>
        <span class="c1"># Increment parameter count for categorical effects</span>
        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_model_all_variance_effects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">spline_bases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="n">category_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Model all covariate variance effects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">variance_effects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Model the global variance</span>
        <span class="n">global_variance_baseline</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="s2">&quot;global_variance_baseline&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;scalar&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="n">variance_effects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_variance_baseline</span><span class="p">)</span>
        <span class="c1"># Increment parameter count for global variance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Model additional covariate effects on the variance</span>
        <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_variance</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_model_linear_variance_effect</span><span class="p">(</span>
                            <span class="n">train_data</span><span class="p">,</span>
                            <span class="n">cov</span><span class="p">,</span>
                            <span class="n">variance_effects</span><span class="p">,</span>
                            <span class="n">sigma_prior</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_model_spline_variance_effect</span><span class="p">(</span>
                            <span class="n">train_data</span><span class="p">,</span>
                            <span class="n">cov</span><span class="p">,</span>
                            <span class="n">variance_effects</span><span class="p">,</span>
                            <span class="n">spline_bases</span><span class="p">,</span>
                            <span class="n">sigma_prior</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_model_categorical_variance_effect</span><span class="p">(</span>
                        <span class="n">train_data</span><span class="p">,</span>
                        <span class="n">cov</span><span class="p">,</span>
                        <span class="n">variance_effects</span><span class="p">,</span>
                        <span class="n">category_indices</span><span class="p">,</span>
                        <span class="n">sigma_prior</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="n">hierarchical_sigma_prior</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid covariate type &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">variance_effects</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_all_effects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mean_effects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">variance_effects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TensorVariable</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">standardized_voi</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine all effects to model the observed data likelihood.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Combine all mean and variance effects</span>
        <span class="n">mu_estimate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mean_effects</span><span class="p">)</span>
        <span class="n">log_sigma_estimate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">variance_effects</span><span class="p">)</span>
        <span class="n">sigma_estimate</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_sigma_estimate</span><span class="p">)</span>

        <span class="c1"># Model likelihood of the variable of interest</span>
        <span class="n">_likelihood</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;likelihood_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="n">mu_estimate</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_estimate</span><span class="p">,</span>
            <span class="n">observed</span><span class="o">=</span><span class="n">standardized_voi</span><span class="p">,</span>
            <span class="n">total_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;sample_size&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fit_model_with_advi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the model using Automatic Differentiation Variational Inference (ADVI).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;adam_learning_rate&quot;</span><span class="p">]</span>
        <span class="n">decay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;adam_learning_rate_decay&quot;</span><span class="p">]</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">shared</span><span class="p">(</span><span class="n">base_lr</span><span class="p">)</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>

        <span class="c1"># Adaptive learning rate schedule callback</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">update_learning_rate</span><span class="p">(</span><span class="n">_approx</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">_loss</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lr</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">base_lr</span> <span class="o">*</span> <span class="p">(</span><span class="n">decay</span><span class="o">**</span><span class="n">iteration</span><span class="p">))</span>

        <span class="c1"># Run automatic differential variational inference to fit the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;advi&quot;</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;advi_iterations&quot;</span><span class="p">],</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">],</span>  <span class="c1"># For reproducibility</span>
            <span class="n">obj_optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span>
                <span class="n">update_learning_rate</span><span class="p">,</span>
                <span class="n">pm</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">CheckParametersConvergence</span><span class="p">(</span>
                    <span class="n">tolerance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;advi_convergence_tolerance&quot;</span><span class="p">],</span>
                    <span class="n">diff</span><span class="o">=</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">progressbar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Sample from the posterior distribution and store the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="mi">2000</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Compute posterior means and standard deviations</span>
        <span class="n">posterior_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;draw&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">posterior_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;draw&quot;</span><span class="p">))</span>

        <span class="c1"># Store posterior means and stds as a dictionary in model parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">posterior_means</span><span class="o">.</span><span class="n">data_vars</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">posterior_means</span><span class="o">.</span><span class="n">data_vars</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_stds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">posterior_stds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">posterior_stds</span><span class="o">.</span><span class="n">data_vars</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the normative model to the training data.</span>

<span class="sd">        This method implements the fitting logic for the normative model</span>
<span class="sd">        based on the provided training data and model specification.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_data: pd.DataFrame</span>
<span class="sd">                DataFrame containing the training data. It must include the variable</span>
<span class="sd">                of interest and all specified covariates.</span>
<span class="sd">            save_directory: Path | None</span>
<span class="sd">                A path to a directory to save the model. If provided, the fitted model</span>
<span class="sd">                will be saved to this path.</span>
<span class="sd">            progress_bar: bool</span>
<span class="sd">                If True, display a progress bar during fitting. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validation checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dataframe_for_fitting</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

        <span class="c1"># A dictionary to hold the model parameters after fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Data preparation</span>
        <span class="n">model_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_model_coordinates</span><span class="p">(</span>
            <span class="n">observations</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="c1"># Fitting logic</span>
        <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">model_coords</span><span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="c1"># Standardize the variable of interest, and store mean and std</span>
            <span class="c1"># This ensures that the model is not sensitive to the scale of the variable</span>
            <span class="n">variable_of_interest</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_VOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_VOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">standardized_voi</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">variable_of_interest</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_VOI&quot;</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_VOI&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;sample_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># A dictionary for precomputed bspline basis functions</span>
            <span class="n">spline_bases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># A dictionary for factorized categories</span>
            <span class="n">category_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Initialize parameter count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Model the mean of the variable of interest</span>
            <span class="n">mean_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_all_mean_effects</span><span class="p">(</span>
                <span class="n">train_data</span><span class="p">,</span>
                <span class="n">spline_bases</span><span class="p">,</span>
                <span class="n">category_indices</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Model the variance of the variable of interest</span>
            <span class="n">variance_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_all_variance_effects</span><span class="p">(</span>
                <span class="n">train_data</span><span class="p">,</span>
                <span class="n">spline_bases</span><span class="p">,</span>
                <span class="n">category_indices</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Combine all mean and variance effects</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_combine_all_effects</span><span class="p">(</span><span class="n">mean_effects</span><span class="p">,</span> <span class="n">variance_effects</span><span class="p">,</span> <span class="n">standardized_voi</span><span class="p">)</span>

            <span class="c1"># Fit the model using ADVI</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_model_with_advi</span><span class="p">(</span><span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">)</span>

        <span class="c1"># Save the model if a save path is provided</span>
        <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_predict_mu</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method to predict the mean of the variable of interest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate mean effect</span>
        <span class="n">mu_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="n">test_covariates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span><span class="s2">&quot;global_intercept&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_mean</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
                            <span class="n">mu_estimate</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="p">(</span><span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="o">/</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="p">)</span> <span class="o">*</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span>
                                <span class="sa">f</span><span class="s2">&quot;linear_beta_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">]</span>
                    <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                        <span class="n">spline_bases</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">make_spline_bases</span><span class="p">(</span>
                            <span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="p">)</span>
                        <span class="n">spline_betas</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span>
                            <span class="sa">f</span><span class="s2">&quot;spline_betas_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">]</span>
                        <span class="n">mu_estimate</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spline_bases</span><span class="p">,</span> <span class="n">spline_betas</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="n">category_indices</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">factorize_categories</span><span class="p">(</span>
                        <span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">hierarchical</span><span class="p">:</span>
                        <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span>
                                <span class="sa">f</span><span class="s2">&quot;intercept_offset_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">]</span>
                            <span class="o">*</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span>
                                <span class="sa">f</span><span class="s2">&quot;sigma_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">categorical_intercept</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span>
                            <span class="sa">f</span><span class="s2">&quot;intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">]</span>
                    <span class="n">mu_estimate</span> <span class="o">+=</span> <span class="n">categorical_intercept</span><span class="p">[</span><span class="n">category_indices</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">mu_estimate</span> <span class="o">*</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_VOI&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_VOI&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_predict_std</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method to predict the standard deviation of the variable of interest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate deviation effect</span>
        <span class="n">log_sigma_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="n">test_covariates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span><span class="s2">&quot;global_variance_baseline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_variance</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;numerical&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># to satisfy type checker</span>
                            <span class="n">log_sigma_estimate</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="p">(</span><span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="o">/</span> <span class="n">cov</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="p">)</span> <span class="o">*</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span>
                                <span class="sa">f</span><span class="s2">&quot;variance_linear_beta_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">]</span>
                    <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                        <span class="n">spline_bases</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">make_spline_bases</span><span class="p">(</span>
                            <span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="p">)</span>
                        <span class="n">variance_spline_betas</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span>
                            <span class="sa">f</span><span class="s2">&quot;variance_spline_betas_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">]</span>
                        <span class="n">log_sigma_estimate</span> <span class="o">+=</span> <span class="n">spline_bases</span> <span class="o">@</span> <span class="n">variance_spline_betas</span>
                <span class="k">elif</span> <span class="n">cov</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="n">category_indices</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">factorize_categories</span><span class="p">(</span>
                        <span class="n">test_covariates</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">hierarchical</span><span class="p">:</span>
                        <span class="n">categorical_variance_intercept</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span>
                                <span class="sa">f</span><span class="s2">&quot;variance_intercept_offset_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">]</span>
                            <span class="o">*</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;posterior_means&quot;</span><span class="p">][</span>
                                <span class="sa">f</span><span class="s2">&quot;variance_sigma_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">categorical_variance_intercept</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span>
                            <span class="s2">&quot;posterior_means&quot;</span>
                        <span class="p">][</span><span class="sa">f</span><span class="s2">&quot;variance_intercept_</span><span class="si">{</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="n">log_sigma_estimate</span> <span class="o">+=</span> <span class="n">categorical_variance_intercept</span><span class="p">[</span>
                        <span class="n">category_indices</span>
                    <span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_sigma_estimate</span><span class="p">)</span> <span class="o">*</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_VOI&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">extended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict normative moments (mean, std) for new data using the fitted model.</span>

<span class="sd">        Args:</span>
<span class="sd">            test_covariates: pd.DataFrame</span>
<span class="sd">                DataFrame containing the new covariate data to predict.</span>
<span class="sd">                This must include all specified covariates.</span>
<span class="sd">            extended: bool</span>
<span class="sd">                If True, return additional stats such as log-likelihood, centiles, etc.</span>
<span class="sd">                Note that extended predictions require variable_of_interest to be</span>
<span class="sd">                provided in the test_covariates DataFrame.</span>
<span class="sd">            model_params: dict | None</span>
<span class="sd">                Optional dictionary of model parameters to use. If not provided,</span>
<span class="sd">                the stored parameters from model.fit() will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            NormativePredictions: Object containing the predicted moments (mean, std)</span>
<span class="sd">                for the variable of interest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the new data</span>
        <span class="n">validation_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extended</span><span class="p">:</span>
            <span class="n">validation_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_dataframe</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">,</span> <span class="n">validation_columns</span><span class="p">)</span>

        <span class="c1"># Parameters</span>
        <span class="k">if</span> <span class="n">model_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>

        <span class="c1"># Calculate mean and variance effects and store in the predictions object</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">NormativePredictions</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mu_estimate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_mu</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">,</span> <span class="n">model_params</span><span class="p">),</span>
                <span class="s2">&quot;std_estimate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_std</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">,</span> <span class="n">model_params</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Check if extended predictions are requested</span>
        <span class="k">if</span> <span class="n">extended</span><span class="p">:</span>
            <span class="c1"># Add extended statistics to predictions (e.g. centiles, log loss, etc.)</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">extend_predictions</span><span class="p">(</span>
                <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">test_covariates</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span>
                <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the model on new data and return predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_data: pd.DataFrame</span>
<span class="sd">                DataFrame containing the new data to evaluate.</span>
<span class="sd">                It must include all specified covariates and the variable of interest.</span>

<span class="sd">        Returns:</span>
<span class="sd">            NormativePredictions: Object containing the predictions and evaluation</span>
<span class="sd">            metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Run extended predictions</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_covariates</span><span class="o">=</span><span class="n">new_data</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate_predictions</span><span class="p">(</span>
            <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">new_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">train_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_VOI&quot;</span><span class="p">],</span>
            <span class="n">train_std</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_VOI&quot;</span><span class="p">],</span>
            <span class="n">n_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">],</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.DirectNormativeModel.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>String representation of the DirectNormativeModel instance.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    String representation of the DirectNormativeModel instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;DirectNormativeModel(</span><span class="se">\n\t</span><span class="s2">spec=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">, </span><span class="se">\n\t</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;batch_covariates=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_covariates</span><span class="si">}</span><span class="se">\n</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.DirectNormativeModel.evaluate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate</span><span class="p">(</span><span class="n">new_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Evaluate the model on new data and return predictions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>new_data</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the new data to evaluate.
It must include all specified covariates and the variable of interest.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>NormativePredictions</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="NormativePredictions


  
      dataclass
   (spectranorm.snm.NormativePredictions)" href="#spectranorm.snm.NormativePredictions">NormativePredictions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object containing the predictions and evaluation</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="NormativePredictions


  
      dataclass
   (spectranorm.snm.NormativePredictions)" href="#spectranorm.snm.NormativePredictions">NormativePredictions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>metrics.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the model on new data and return predictions.</span>

<span class="sd">    Args:</span>
<span class="sd">        new_data: pd.DataFrame</span>
<span class="sd">            DataFrame containing the new data to evaluate.</span>
<span class="sd">            It must include all specified covariates and the variable of interest.</span>

<span class="sd">    Returns:</span>
<span class="sd">        NormativePredictions: Object containing the predictions and evaluation</span>
<span class="sd">        metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Run extended predictions</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_covariates</span><span class="o">=</span><span class="n">new_data</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate_predictions</span><span class="p">(</span>
        <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">new_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">train_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_VOI&quot;</span><span class="p">],</span>
        <span class="n">train_std</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_VOI&quot;</span><span class="p">],</span>
        <span class="n">n_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.DirectNormativeModel.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Fit the normative model to the training data.</p>
<p>This method implements the fitting logic for the normative model
based on the provided training data and model specification.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_data</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the training data. It must include the variable
of interest and all specified covariates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path | None
A path to a directory to save the model. If provided, the fitted model
will be saved to this path.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress_bar</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool
If True, display a progress bar during fitting. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit the normative model to the training data.</span>

<span class="sd">    This method implements the fitting logic for the normative model</span>
<span class="sd">    based on the provided training data and model specification.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_data: pd.DataFrame</span>
<span class="sd">            DataFrame containing the training data. It must include the variable</span>
<span class="sd">            of interest and all specified covariates.</span>
<span class="sd">        save_directory: Path | None</span>
<span class="sd">            A path to a directory to save the model. If provided, the fitted model</span>
<span class="sd">            will be saved to this path.</span>
<span class="sd">        progress_bar: bool</span>
<span class="sd">            If True, display a progress bar during fitting. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validation checks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_model</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dataframe_for_fitting</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

    <span class="c1"># A dictionary to hold the model parameters after fitting</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Data preparation</span>
    <span class="n">model_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_model_coordinates</span><span class="p">(</span>
        <span class="n">observations</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="c1"># Fitting logic</span>
    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">model_coords</span><span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
        <span class="c1"># Standardize the variable of interest, and store mean and std</span>
        <span class="c1"># This ensures that the model is not sensitive to the scale of the variable</span>
        <span class="n">variable_of_interest</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_VOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_VOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">standardized_voi</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">variable_of_interest</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;mean_VOI&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;std_VOI&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;sample_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># A dictionary for precomputed bspline basis functions</span>
        <span class="n">spline_bases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># A dictionary for factorized categories</span>
        <span class="n">category_indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Initialize parameter count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Model the mean of the variable of interest</span>
        <span class="n">mean_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_all_mean_effects</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">spline_bases</span><span class="p">,</span>
            <span class="n">category_indices</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Model the variance of the variable of interest</span>
        <span class="n">variance_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_all_variance_effects</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">spline_bases</span><span class="p">,</span>
            <span class="n">category_indices</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Combine all mean and variance effects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combine_all_effects</span><span class="p">(</span><span class="n">mean_effects</span><span class="p">,</span> <span class="n">variance_effects</span><span class="p">,</span> <span class="n">standardized_voi</span><span class="p">)</span>

        <span class="c1"># Fit the model using ADVI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_model_with_advi</span><span class="p">(</span><span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="p">)</span>

    <span class="c1"># Save the model if a save path is provided</span>
    <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.DirectNormativeModel.from_dataframe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_dataframe</span><span class="p">(</span><span class="n">model_type</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">variable_of_interest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">numerical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">categorical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nonlinear_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">influencing_mean</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">influencing_variance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spline_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DirectNormativeModel</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize a normative model from a pandas DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_type</code>
            </td>
            <td>
                  <code><span title="spectranorm.snm.ModelType">ModelType</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ModelType
Type of the model to create, either "HBR" (Hierarchical Bayesian
Regression) or "BLR" (Bayesian Linear Regression).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dataframe</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>variable_of_interest</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Name of the target variable to model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>numerical_covariates</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of numerical covariate names.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>categorical_covariates</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of categorical covariate names.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_covariates</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of batch covariate names which should also be included in
categorical_covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nonlinear_covariates</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of covariate names to be modeled as nonlinear effects.
These should also be included in numerical_covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>influencing_mean</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of covariate names that influence the mean of the variable
of interest. These should be included in either numerical_covariates
or categorical_covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>influencing_variance</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of covariate names that influence the variance of the variable
of interest. These should be included in either numerical_covariates
or categorical_covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spline_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict
Additional keyword arguments for spline specification, such as
<code>df</code>, <code>degree</code>, and <code>knots</code>. These are passed to the
<code>create_spline_spec</code> method to create spline specifications for
nonlinear covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="DirectNormativeModel


  
      dataclass
   (spectranorm.snm.DirectNormativeModel)" href="#spectranorm.snm.DirectNormativeModel">DirectNormativeModel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DirectNormativeModel
An instance of DirectNormativeModel initialized with the provided data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_dataframe</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">,</span>
    <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">variable_of_interest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">numerical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nonlinear_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">influencing_mean</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">influencing_variance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spline_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DirectNormativeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a normative model from a pandas DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_type: ModelType</span>
<span class="sd">            Type of the model to create, either &quot;HBR&quot; (Hierarchical Bayesian</span>
<span class="sd">            Regression) or &quot;BLR&quot; (Bayesian Linear Regression).</span>
<span class="sd">        dataframe: pd.DataFrame</span>
<span class="sd">            DataFrame containing the data.</span>
<span class="sd">        variable_of_interest: str</span>
<span class="sd">            Name of the target variable to model.</span>
<span class="sd">        numerical_covariates: list[str] | None</span>
<span class="sd">            List of numerical covariate names.</span>
<span class="sd">        categorical_covariates: list[str] | None</span>
<span class="sd">            List of categorical covariate names.</span>
<span class="sd">        batch_covariates: list[str] | None</span>
<span class="sd">            List of batch covariate names which should also be included in</span>
<span class="sd">            categorical_covariates.</span>
<span class="sd">        nonlinear_covariates: list[str] | None</span>
<span class="sd">            List of covariate names to be modeled as nonlinear effects.</span>
<span class="sd">            These should also be included in numerical_covariates.</span>
<span class="sd">        influencing_mean: list[str] | None</span>
<span class="sd">            List of covariate names that influence the mean of the variable</span>
<span class="sd">            of interest. These should be included in either numerical_covariates</span>
<span class="sd">            or categorical_covariates.</span>
<span class="sd">        influencing_variance: list[str] | None</span>
<span class="sd">            List of covariate names that influence the variance of the variable</span>
<span class="sd">            of interest. These should be included in either numerical_covariates</span>
<span class="sd">            or categorical_covariates.</span>
<span class="sd">        spline_kwargs: dict</span>
<span class="sd">            Additional keyword arguments for spline specification, such as</span>
<span class="sd">            `df`, `degree`, and `knots`. These are passed to the</span>
<span class="sd">            `create_spline_spec` method to create spline specifications for</span>
<span class="sd">            nonlinear covariates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DirectNormativeModel</span>
<span class="sd">            An instance of DirectNormativeModel initialized with the provided data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set default values for optional parameters</span>
    <span class="n">numerical_covariates</span> <span class="o">=</span> <span class="n">numerical_covariates</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">categorical_covariates</span> <span class="o">=</span> <span class="n">categorical_covariates</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">batch_covariates</span> <span class="o">=</span> <span class="n">batch_covariates</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">nonlinear_covariates</span> <span class="o">=</span> <span class="n">nonlinear_covariates</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">influencing_mean</span> <span class="o">=</span> <span class="n">influencing_mean</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">influencing_variance</span> <span class="o">=</span> <span class="n">influencing_variance</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">spline_kwargs</span> <span class="o">=</span> <span class="n">spline_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="c1"># Validity checks for input parameters</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">_validate_init_args</span><span class="p">(</span>
        <span class="n">model_type</span><span class="p">,</span>
        <span class="n">variable_of_interest</span><span class="p">,</span>
        <span class="n">numerical_covariates</span><span class="p">,</span>
        <span class="n">categorical_covariates</span><span class="p">,</span>
        <span class="n">batch_covariates</span><span class="p">,</span>
        <span class="n">nonlinear_covariates</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_dataframe</span><span class="p">(</span>
        <span class="n">dataframe</span><span class="p">,</span>
        <span class="p">[</span><span class="n">variable_of_interest</span><span class="p">,</span> <span class="o">*</span><span class="n">numerical_covariates</span><span class="p">,</span> <span class="o">*</span><span class="n">categorical_covariates</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Create an instance of the class</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">=</span><span class="n">NormativeModelSpec</span><span class="p">(</span>
            <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">variable_of_interest</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">influencing_mean</span><span class="o">=</span><span class="n">influencing_mean</span><span class="p">,</span>
            <span class="n">influencing_variance</span><span class="o">=</span><span class="n">influencing_variance</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">batch_covariates</span><span class="o">=</span><span class="n">batch_covariates</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Populate the spline_kwargs with defaults if not provided</span>
    <span class="n">spline_kwargs</span><span class="p">[</span><span class="s2">&quot;df&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;df&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;spline_df&quot;</span><span class="p">])</span>
    <span class="n">spline_kwargs</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;degree&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;spline_degree&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">spline_kwargs</span><span class="p">[</span><span class="s2">&quot;extrapolation_factor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;extrapolation_factor&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;spline_extrapolation_factor&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Start building the model specification</span>
    <span class="c1"># Add categorical covariates</span>
    <span class="k">for</span> <span class="n">cov_name</span> <span class="ow">in</span> <span class="n">categorical_covariates</span><span class="p">:</span>
        <span class="n">hierarchical</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">cov_name</span> <span class="ow">in</span> <span class="n">batch_covariates</span> <span class="ow">and</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;HBR&quot;</span><span class="p">:</span>
            <span class="n">hierarchical</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">CovariateSpec</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">cov_name</span><span class="p">,</span>
                <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;categorical&quot;</span><span class="p">,</span>
                <span class="n">categories</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="n">hierarchical</span><span class="o">=</span><span class="n">hierarchical</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">cov_name</span> <span class="ow">in</span> <span class="n">numerical_covariates</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cov_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nonlinear_covariates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">CovariateSpec</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">cov_name</span><span class="p">,</span>
                    <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;numerical&quot;</span><span class="p">,</span>
                    <span class="n">effect</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                    <span class="n">moments</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">dataframe</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                        <span class="n">dataframe</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">CovariateSpec</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">cov_name</span><span class="p">,</span>
                    <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;numerical&quot;</span><span class="p">,</span>
                    <span class="n">effect</span><span class="o">=</span><span class="s2">&quot;spline&quot;</span><span class="p">,</span>
                    <span class="n">spline_spec</span><span class="o">=</span><span class="n">SplineSpec</span><span class="o">.</span><span class="n">create_spline_spec</span><span class="p">(</span>
                        <span class="n">dataframe</span><span class="p">[</span><span class="n">cov_name</span><span class="p">],</span>
                        <span class="o">**</span><span class="n">spline_kwargs</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.DirectNormativeModel.load_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_model</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">load_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DirectNormativeModel</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Load the model and its posterior from a directory.
The model will be loaded from a subdirectory named 'saved_model'.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path
Path to the directory containing the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>load_posterior</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool (default=False)
If True, load the model's posterior trace from the saved inference data.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">load_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DirectNormativeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the model and its posterior from a directory.</span>
<span class="sd">    The model will be loaded from a subdirectory named &#39;saved_model&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory: Path</span>
<span class="sd">            Path to the directory containing the model.</span>
<span class="sd">        load_posterior: bool (default=False)</span>
<span class="sd">            If True, load the model&#39;s posterior trace from the saved inference data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate the load directory</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_load_directory</span><span class="p">(</span>
        <span class="n">directory</span><span class="p">,</span>
        <span class="s2">&quot;saved_model&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Load the saved model dict</span>
    <span class="n">model_dict</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_dict.joblib&quot;</span><span class="p">)</span>

    <span class="c1"># Create an instance of the class</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span>
        <span class="n">batch_covariates</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;batch_covariates&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Set the attributes from the loaded model dictionary</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;defaults&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;model_params&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">load_posterior</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">model_inference_data</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_netcdf</span><span class="p">(</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
                <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_inference_data.nc&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.DirectNormativeModel.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">extended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Predict normative moments (mean, std) for new data using the fitted model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>test_covariates</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the new covariate data to predict.
This must include all specified covariates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>extended</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool
If True, return additional stats such as log-likelihood, centiles, etc.
Note that extended predictions require variable_of_interest to be
provided in the test_covariates DataFrame.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict | None
Optional dictionary of model parameters to use. If not provided,
the stored parameters from model.fit() will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>NormativePredictions</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="NormativePredictions


  
      dataclass
   (spectranorm.snm.NormativePredictions)" href="#spectranorm.snm.NormativePredictions">NormativePredictions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object containing the predicted moments (mean, std)
for the variable of interest.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">extended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predict normative moments (mean, std) for new data using the fitted model.</span>

<span class="sd">    Args:</span>
<span class="sd">        test_covariates: pd.DataFrame</span>
<span class="sd">            DataFrame containing the new covariate data to predict.</span>
<span class="sd">            This must include all specified covariates.</span>
<span class="sd">        extended: bool</span>
<span class="sd">            If True, return additional stats such as log-likelihood, centiles, etc.</span>
<span class="sd">            Note that extended predictions require variable_of_interest to be</span>
<span class="sd">            provided in the test_covariates DataFrame.</span>
<span class="sd">        model_params: dict | None</span>
<span class="sd">            Optional dictionary of model parameters to use. If not provided,</span>
<span class="sd">            the stored parameters from model.fit() will be used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        NormativePredictions: Object containing the predicted moments (mean, std)</span>
<span class="sd">            for the variable of interest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate the new data</span>
    <span class="n">validation_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">extended</span><span class="p">:</span>
        <span class="n">validation_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_dataframe</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">,</span> <span class="n">validation_columns</span><span class="p">)</span>

    <span class="c1"># Parameters</span>
    <span class="k">if</span> <span class="n">model_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>

    <span class="c1"># Calculate mean and variance effects and store in the predictions object</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">NormativePredictions</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;mu_estimate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_mu</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">,</span> <span class="n">model_params</span><span class="p">),</span>
            <span class="s2">&quot;std_estimate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_std</span><span class="p">(</span><span class="n">test_covariates</span><span class="p">,</span> <span class="n">model_params</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Check if extended predictions are requested</span>
    <span class="k">if</span> <span class="n">extended</span><span class="p">:</span>
        <span class="c1"># Add extended statistics to predictions (e.g. centiles, log loss, etc.)</span>
        <span class="n">predictions</span><span class="o">.</span><span class="n">extend_predictions</span><span class="p">(</span>
            <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">test_covariates</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">variable_of_interest</span>
            <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.DirectNormativeModel.save_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_model</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save the fitted model and it's posterior to a directory.
The model will be saved in a subdirectory named 'saved_model'.
If this directory is not empty, an error is raised.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path
Path to a directory to save the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_posterior</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool (default=False)
If True, save the model's posterior trace inference data.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_posterior</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the fitted model and it&#39;s posterior to a directory.</span>
<span class="sd">    The model will be saved in a subdirectory named &#39;saved_model&#39;.</span>
<span class="sd">    If this directory is not empty, an error is raised.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory: Path</span>
<span class="sd">            Path to a directory to save the model.</span>
<span class="sd">        save_posterior: bool (default=False)</span>
<span class="sd">            If True, save the model&#39;s posterior trace inference data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare the save directory</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">prepare_save_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;saved_model&quot;</span><span class="p">)</span>

    <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
        <span class="s2">&quot;batch_covariates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
        <span class="s2">&quot;defaults&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_params&quot;</span><span class="p">):</span>
        <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_inference_data&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">save_posterior</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_inference_data</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span>
                <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_inference_data.nc&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_dict</span><span class="p">,</span> <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;model_dict.joblib&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="spectranorm.snm.NormativeModelSpec" class="doc doc-heading">
            <code>NormativeModelSpec</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>General specification of a normative model.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.NormativeModelSpec.variable_of_interest">variable_of_interest</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Name of the target variable to model (e.g., "thickness").</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.NormativeModelSpec.covariates">covariates</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="CovariateSpec


  
      dataclass
   (spectranorm.snm.CovariateSpec)" href="#spectranorm.snm.CovariateSpec">CovariateSpec</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[CovariateSpec]
Listing all model covariates and specifying how each covariate is modeled.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.NormativeModelSpec.influencing_mean">influencing_mean</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]
List of covariate names that influence the mean of the variable of interest.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.NormativeModelSpec.influencing_variance">influencing_variance</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]
List of covariate names that influence the variance of the variable of
interest.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NormativeModelSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General specification of a normative model.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        variable_of_interest: str</span>
<span class="sd">            Name of the target variable to model (e.g., &quot;thickness&quot;).</span>
<span class="sd">        covariates: list[CovariateSpec]</span>
<span class="sd">            Listing all model covariates and specifying how each covariate is modeled.</span>
<span class="sd">        influencing_mean: list[str]</span>
<span class="sd">            List of covariate names that influence the mean of the variable of interest.</span>
<span class="sd">        influencing_variance: list[str]</span>
<span class="sd">            List of covariate names that influence the variance of the variable of</span>
<span class="sd">            interest.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">variable_of_interest</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CovariateSpec</span><span class="p">]</span>
    <span class="n">influencing_mean</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">influencing_variance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_of_interest</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;variable_of_interest must be a string.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;covariates must be a list of CovariateSpec instances.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">CovariateSpec</span><span class="p">)</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;All items in covariates must be CovariateSpec instances.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">influencing_mean</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;influencing_mean must be a list of covariate names.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">influencing_variance</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;influencing_variance must be a list of covariate names.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="spectranorm.snm.NormativePredictions" class="doc doc-heading">
            <code>NormativePredictions</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Container for the results of model.predict() function.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.NormativePredictions.predictions">predictions</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict
Dictionary containing the model's predictions, including
- Predictions of mean (mu_estimate).
- Predictions of standard deviation (std_estimate).
- [Optional] The observed variable of interest (the name of which is
  provided in the function argument).
- [Optional] Additional evaluation metrics for the predictions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NormativePredictions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for the results of model.predict() function.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        predictions: dict</span>
<span class="sd">            Dictionary containing the model&#39;s predictions, including</span>
<span class="sd">            - Predictions of mean (mu_estimate).</span>
<span class="sd">            - Predictions of standard deviation (std_estimate).</span>
<span class="sd">            - [Optional] The observed variable of interest (the name of which is</span>
<span class="sd">              provided in the function argument).</span>
<span class="sd">            - [Optional] Additional evaluation metrics for the predictions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">predictions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
    <span class="n">evaluations</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extend_predictions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variable_of_interest</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extend the NormativePredictions (predictions dictionary) with additional</span>
<span class="sd">        statistics.</span>

<span class="sd">        Args:</span>
<span class="sd">            variable_of_interest: np.ndarray</span>
<span class="sd">                The observed values for the variable(s) of interest.</span>

<span class="sd">        Returns:</span>
<span class="sd">            NormativePredictions</span>
<span class="sd">                Extended NormativePredictions with additional statistics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;z-score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">variable_of_interest</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;std_estimate&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;log-likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_censored_log_likelihood</span><span class="p">(</span>
                <span class="n">variable_of_interest</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;std_estimate&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;centiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_centiles_from_z_scores</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;z-score&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_predictions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variable_of_interest</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">train_mean</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">train_std</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">n_params</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the predictions against the observed variable of interest.</span>

<span class="sd">        This function computes a battery of evaluation metrics implemented</span>
<span class="sd">        in `snm.utils.metrics`. Namely the evaluations include:</span>
<span class="sd">            - Mean Absolute Error (MAE)</span>
<span class="sd">            - Mean Squared Error (MSE)</span>
<span class="sd">            - Root Mean Squared Error (RMSE)</span>
<span class="sd">            - Mean Absolute Percentage Error (MAPE)</span>
<span class="sd">            - R-squared</span>
<span class="sd">            - Explained Variance Score</span>
<span class="sd">            - Mean Standardized Log Loss (MSLL)</span>
<span class="sd">            - Bayesian Information Criterion (BIC)</span>

<span class="sd">        Args:</span>
<span class="sd">            variable_of_interest: np.ndarray</span>
<span class="sd">                The observed values for the variable(s) of interest.</span>
<span class="sd">            train_mean: np.ndarray</span>
<span class="sd">                Mean(s) of the variable(s) of interest from the training data.</span>
<span class="sd">            train_std: np.ndarray</span>
<span class="sd">                Standard deviation(s) of the variable(s) of interest from the training</span>
<span class="sd">                data.</span>
<span class="sd">            n_params: int</span>
<span class="sd">                Number of free parameters in the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            NormativePredictions</span>
<span class="sd">                Object containing the evaluation results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend_predictions</span><span class="p">(</span><span class="n">variable_of_interest</span><span class="p">)</span>
        <span class="c1"># Mean Absolute Error (MAE)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;MAE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_mae</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
            <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># Mean Squared Error (MSE)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;MSE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_mse</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
            <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># Root Mean Squared Error (RMSE)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_rmse</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
            <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># Mean Absolute Percentage Error (MAPE)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;MAPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_mape</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
            <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># R-squared</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;R-squared&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_r2</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
            <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># Explained Variance Score</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;Explained Variance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_expv</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
            <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># Mean Standardized Log Loss (MSLL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;MSLL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_msll</span><span class="p">(</span>
            <span class="n">model_log_likelihoods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;log-likelihood&quot;</span><span class="p">],</span>
            <span class="n">baseline_log_likelihoods</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_censored_log_likelihood</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
                <span class="n">train_mean</span><span class="p">,</span>
                <span class="n">train_std</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># Bayesian Information Criterion (BIC)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;BIC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_bic</span><span class="p">(</span>
            <span class="n">model_log_likelihoods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;log-likelihood&quot;</span><span class="p">],</span>
            <span class="n">n_params</span><span class="o">=</span><span class="n">n_params</span><span class="p">,</span>
            <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return prediction results as a list of NumPy arrays.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: list[str]</span>
<span class="sd">                Optional list of keys to return.</span>
<span class="sd">                Defaults to [&quot;mu_estimate&quot;, &quot;std_estimate&quot;].</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[np.ndarray]</span>
<span class="sd">                NumPy arrays for the requested predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;std_estimate&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dataframe</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return prediction results as a DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: pd.Index | list | None</span>
<span class="sd">                Optional index for the DataFrame (defaults to None)</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame</span>
<span class="sd">                DataFrame containing the predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Flatten the predictions dictionary if multiple queries are predicted</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">predictions</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
                    <span class="c1"># delete the key</span>
                    <span class="k">del</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Make a new DataFrame for the predictions dictionary</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.NormativePredictions.evaluate_predictions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_predictions</span><span class="p">(</span><span class="n">variable_of_interest</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">train_mean</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">train_std</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">n_params</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Evaluate the predictions against the observed variable of interest.</p>
<p>This function computes a battery of evaluation metrics implemented
in <code>snm.utils.metrics</code>. Namely the evaluations include:
    - Mean Absolute Error (MAE)
    - Mean Squared Error (MSE)
    - Root Mean Squared Error (RMSE)
    - Mean Absolute Percentage Error (MAPE)
    - R-squared
    - Explained Variance Score
    - Mean Standardized Log Loss (MSLL)
    - Bayesian Information Criterion (BIC)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>variable_of_interest</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
The observed values for the variable(s) of interest.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>train_mean</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Mean(s) of the variable(s) of interest from the training data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>train_std</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Standard deviation(s) of the variable(s) of interest from the training
data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_params</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
Number of free parameters in the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="NormativePredictions


  
      dataclass
   (spectranorm.snm.NormativePredictions)" href="#spectranorm.snm.NormativePredictions">NormativePredictions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NormativePredictions
Object containing the evaluation results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_predictions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">variable_of_interest</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">train_mean</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">train_std</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">n_params</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the predictions against the observed variable of interest.</span>

<span class="sd">    This function computes a battery of evaluation metrics implemented</span>
<span class="sd">    in `snm.utils.metrics`. Namely the evaluations include:</span>
<span class="sd">        - Mean Absolute Error (MAE)</span>
<span class="sd">        - Mean Squared Error (MSE)</span>
<span class="sd">        - Root Mean Squared Error (RMSE)</span>
<span class="sd">        - Mean Absolute Percentage Error (MAPE)</span>
<span class="sd">        - R-squared</span>
<span class="sd">        - Explained Variance Score</span>
<span class="sd">        - Mean Standardized Log Loss (MSLL)</span>
<span class="sd">        - Bayesian Information Criterion (BIC)</span>

<span class="sd">    Args:</span>
<span class="sd">        variable_of_interest: np.ndarray</span>
<span class="sd">            The observed values for the variable(s) of interest.</span>
<span class="sd">        train_mean: np.ndarray</span>
<span class="sd">            Mean(s) of the variable(s) of interest from the training data.</span>
<span class="sd">        train_std: np.ndarray</span>
<span class="sd">            Standard deviation(s) of the variable(s) of interest from the training</span>
<span class="sd">            data.</span>
<span class="sd">        n_params: int</span>
<span class="sd">            Number of free parameters in the model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        NormativePredictions</span>
<span class="sd">            Object containing the evaluation results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">extend_predictions</span><span class="p">(</span><span class="n">variable_of_interest</span><span class="p">)</span>
    <span class="c1"># Mean Absolute Error (MAE)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;MAE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_mae</span><span class="p">(</span>
        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># Mean Squared Error (MSE)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;MSE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_mse</span><span class="p">(</span>
        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># Root Mean Squared Error (RMSE)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_rmse</span><span class="p">(</span>
        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># Mean Absolute Percentage Error (MAPE)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;MAPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_mape</span><span class="p">(</span>
        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># R-squared</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;R-squared&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_r2</span><span class="p">(</span>
        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># Explained Variance Score</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;Explained Variance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_expv</span><span class="p">(</span>
        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># Mean Standardized Log Loss (MSLL)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;MSLL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_msll</span><span class="p">(</span>
        <span class="n">model_log_likelihoods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;log-likelihood&quot;</span><span class="p">],</span>
        <span class="n">baseline_log_likelihoods</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_censored_log_likelihood</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">],</span>
            <span class="n">train_mean</span><span class="p">,</span>
            <span class="n">train_std</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># Bayesian Information Criterion (BIC)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evaluations</span><span class="p">[</span><span class="s2">&quot;BIC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_bic</span><span class="p">(</span>
        <span class="n">model_log_likelihoods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;log-likelihood&quot;</span><span class="p">],</span>
        <span class="n">n_params</span><span class="o">=</span><span class="n">n_params</span><span class="p">,</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.NormativePredictions.extend_predictions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extend_predictions</span><span class="p">(</span><span class="n">variable_of_interest</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Extend the NormativePredictions (predictions dictionary) with additional
statistics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>variable_of_interest</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
The observed values for the variable(s) of interest.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="NormativePredictions


  
      dataclass
   (spectranorm.snm.NormativePredictions)" href="#spectranorm.snm.NormativePredictions">NormativePredictions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NormativePredictions
Extended NormativePredictions with additional statistics.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extend_predictions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">variable_of_interest</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extend the NormativePredictions (predictions dictionary) with additional</span>
<span class="sd">    statistics.</span>

<span class="sd">    Args:</span>
<span class="sd">        variable_of_interest: np.ndarray</span>
<span class="sd">            The observed values for the variable(s) of interest.</span>

<span class="sd">    Returns:</span>
<span class="sd">        NormativePredictions</span>
<span class="sd">            Extended NormativePredictions with additional statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;z-score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">variable_of_interest</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;std_estimate&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;log-likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_censored_log_likelihood</span><span class="p">(</span>
            <span class="n">variable_of_interest</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;std_estimate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;centiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_centiles_from_z_scores</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;z-score&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variable_of_interest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.NormativePredictions.to_array" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_array</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Return prediction results as a list of NumPy arrays.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>keys</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]
Optional list of keys to return.
Defaults to ["mu_estimate", "std_estimate"].</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[np.ndarray]
NumPy arrays for the requested predictions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return prediction results as a list of NumPy arrays.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys: list[str]</span>
<span class="sd">            Optional list of keys to return.</span>
<span class="sd">            Defaults to [&quot;mu_estimate&quot;, &quot;std_estimate&quot;].</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[np.ndarray]</span>
<span class="sd">            NumPy arrays for the requested predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;std_estimate&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.NormativePredictions.to_dataframe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_dataframe</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Return prediction results as a DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>index</code>
            </td>
            <td>
                  <code><span title="pandas.Index">Index</span>[<span title="typing.Any">Any</span>] | <span title="list">list</span>[<span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.Index | list | None
Optional index for the DataFrame (defaults to None)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the predictions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_dataframe</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return prediction results as a DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        index: pd.Index | list | None</span>
<span class="sd">            Optional index for the DataFrame (defaults to None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame containing the predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Flatten the predictions dictionary if multiple queries are predicted</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">predictions</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="c1"># delete the key</span>
                <span class="k">del</span> <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="c1"># Make a new DataFrame for the predictions dictionary</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="spectranorm.snm.SpectralNormativeModel" class="doc doc-heading">
            <code>SpectralNormativeModel</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Spectral normative model implementation.</p>
<p>This class implements the spectral normative modeling approach, which
utilizes a base direct model to generalize normative modeling to any
arbitrary variable of interest reconstructed from a graph spectral
embedding. It can be used to fit a normative model to high-dimensional
data and predict normative centiles for arbitrary variables of interest.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.SpectralNormativeModel.eigenmode_basis">eigenmode_basis</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="EigenmodeBasis


  
      dataclass
   (spectranorm.utils.gsp.EigenmodeBasis)" href="#spectranorm.utils.gsp.EigenmodeBasis">EigenmodeBasis</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>utils.gsp.EigenmodeBasis
The eigenmode basis used for spectral normative modeling. This should be an
instance of utils.gsp.EigenmodeBasis.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.SpectralNormativeModel.base_model">base_model</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DirectNormativeModel


  
      dataclass
   (spectranorm.snm.DirectNormativeModel)" href="#spectranorm.snm.DirectNormativeModel">DirectNormativeModel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DirectNormativeModel
The base (direct) normative model used for spectral normative modeling.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span>
<span class="normal">3345</span>
<span class="normal">3346</span>
<span class="normal">3347</span>
<span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span>
<span class="normal">3354</span>
<span class="normal">3355</span>
<span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span>
<span class="normal">3368</span>
<span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SpectralNormativeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spectral normative model implementation.</span>

<span class="sd">    This class implements the spectral normative modeling approach, which</span>
<span class="sd">    utilizes a base direct model to generalize normative modeling to any</span>
<span class="sd">    arbitrary variable of interest reconstructed from a graph spectral</span>
<span class="sd">    embedding. It can be used to fit a normative model to high-dimensional</span>
<span class="sd">    data and predict normative centiles for arbitrary variables of interest.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        eigenmode_basis: utils.gsp.EigenmodeBasis</span>
<span class="sd">            The eigenmode basis used for spectral normative modeling. This should be an</span>
<span class="sd">            instance of utils.gsp.EigenmodeBasis.</span>
<span class="sd">        base_model: DirectNormativeModel</span>
<span class="sd">            The base (direct) normative model used for spectral normative modeling.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">eigenmode_basis</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">gsp</span><span class="o">.</span><span class="n">EigenmodeBasis</span>
    <span class="n">base_model</span><span class="p">:</span> <span class="n">DirectNormativeModel</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_from_dataframe</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">eigenmode_basis</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">gsp</span><span class="o">.</span><span class="n">EigenmodeBasis</span><span class="p">,</span>
        <span class="n">model_type</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">,</span>
        <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">numerical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">categorical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nonlinear_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">influencing_mean</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">influencing_variance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">spline_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralNormativeModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize SNM with an eigenmode basis and a base direct model built from a</span>
<span class="sd">        pandas DataFrame containing all covariates.</span>

<span class="sd">        This uses the from_dataframe method of the DirectNormativeModel class</span>
<span class="sd">        to populate the direct model specification of SNM. Given that SNM does not</span>
<span class="sd">        require a fixed variable of interest, this method assigns a dummy name</span>
<span class="sd">        to the variable_of_interest parameter of the DirectNormativeModel. As such,</span>
<span class="sd">        the provided dataframe should not contain a column with &quot;dummy_VOI&quot; as name.</span>

<span class="sd">        Essentially, the provided dataframe should contain all covariates as columns.</span>

<span class="sd">        Args:</span>
<span class="sd">            eigenmode_basis: utils.gsp.EigenmodeBasis</span>
<span class="sd">                The eigenmode basis to be used for spectral normative modeling.</span>
<span class="sd">            model_type: ModelType</span>
<span class="sd">                Type of the model to create, either &quot;HBR&quot; (Hierarchical Bayesian</span>
<span class="sd">                Regression) or &quot;BLR&quot; (Bayesian Linear Regression).</span>
<span class="sd">            covariates_dataframe: pd.DataFrame</span>
<span class="sd">                DataFrame containing the data for all covariates and all samples.</span>
<span class="sd">            numerical_covariates: list[str] | None</span>
<span class="sd">                List of numerical covariate names.</span>
<span class="sd">            categorical_covariates: list[str] | None</span>
<span class="sd">                List of categorical covariate names.</span>
<span class="sd">            batch_covariates: list[str] | None</span>
<span class="sd">                List of batch covariate names which should also be included in</span>
<span class="sd">                categorical_covariates.</span>
<span class="sd">            nonlinear_covariates: list[str] | None</span>
<span class="sd">                List of covariate names to be modeled as nonlinear effects.</span>
<span class="sd">                These should also be included in numerical_covariates.</span>
<span class="sd">            influencing_mean: list[str] | None</span>
<span class="sd">                List of covariate names that influence the mean of the variable</span>
<span class="sd">                of interest. These should be included in either numerical_covariates</span>
<span class="sd">                or categorical_covariates.</span>
<span class="sd">            influencing_variance: list[str] | None</span>
<span class="sd">                List of covariate names that influence the variance of the variable</span>
<span class="sd">                of interest. These should be included in either numerical_covariates</span>
<span class="sd">                or categorical_covariates.</span>
<span class="sd">            spline_kwargs: dict</span>
<span class="sd">                Additional keyword arguments for spline specification, such as</span>
<span class="sd">                `df`, `degree`, and `knots`. These are passed to the</span>
<span class="sd">                `create_spline_spec` method to create spline specifications for</span>
<span class="sd">                nonlinear covariates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SpectralNormativeModel</span>
<span class="sd">                An instance of SpectralNormativeModel with base model specs initialized</span>
<span class="sd">                based on the provided data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add a dummy variable of interest to the covariates_dataframe</span>
        <span class="n">covariates_dataframe</span> <span class="o">=</span> <span class="n">covariates_dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">covariates_dataframe</span><span class="p">[</span><span class="s2">&quot;dummy_VOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Dummy variable of interest</span>
        <span class="c1"># Specify the base model from the dataframe</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">eigenmode_basis</span><span class="o">=</span><span class="n">eigenmode_basis</span><span class="p">,</span>
            <span class="n">base_model</span><span class="o">=</span><span class="n">DirectNormativeModel</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
                <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span>
                <span class="n">dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
                <span class="n">variable_of_interest</span><span class="o">=</span><span class="s2">&quot;dummy_VOI&quot;</span><span class="p">,</span>  <span class="c1"># Dummy variable of interest</span>
                <span class="n">numerical_covariates</span><span class="o">=</span><span class="p">(</span><span class="n">numerical_covariates</span> <span class="ow">or</span> <span class="p">[]),</span>
                <span class="n">categorical_covariates</span><span class="o">=</span><span class="p">(</span><span class="n">categorical_covariates</span> <span class="ow">or</span> <span class="p">[]),</span>
                <span class="n">batch_covariates</span><span class="o">=</span><span class="p">(</span><span class="n">batch_covariates</span> <span class="ow">or</span> <span class="p">[]),</span>
                <span class="n">nonlinear_covariates</span><span class="o">=</span><span class="p">(</span><span class="n">nonlinear_covariates</span> <span class="ow">or</span> <span class="p">[]),</span>
                <span class="n">influencing_mean</span><span class="o">=</span><span class="p">(</span><span class="n">influencing_mean</span> <span class="ow">or</span> <span class="p">[]),</span>
                <span class="n">influencing_variance</span><span class="o">=</span><span class="p">(</span><span class="n">influencing_variance</span> <span class="ow">or</span> <span class="p">[]),</span>
                <span class="n">spline_kwargs</span><span class="o">=</span><span class="p">(</span><span class="n">spline_kwargs</span> <span class="ow">or</span> <span class="p">{}),</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the fitted spectral normative model to the specified directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory: Path</span>
<span class="sd">                Directory to save the fitted model. A subdirectory named</span>
<span class="sd">                &quot;spectral_normative_model&quot; will be created within this directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare the save directory</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">prepare_save_directory</span><span class="p">(</span>
            <span class="n">directory</span><span class="p">,</span>
            <span class="s2">&quot;spectral_normative_model&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Save the model</span>
        <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
            <span class="s2">&quot;batch_covariates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
            <span class="s2">&quot;defaults&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
            <span class="s2">&quot;eigenmode_basis&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_params&quot;</span><span class="p">):</span>
            <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_dict</span><span class="p">,</span> <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;spectral_model_dict.joblib&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_fit_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method to validate input data for fitting the spectral normative model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the input data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">encoded_train_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;encoded_train_data must be a numpy array.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoded_train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n_modes</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;encoded_train_data must have at least </span><span class="si">{</span><span class="n">n_modes</span><span class="si">}</span><span class="s2"> columns (n_modes).&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">&lt;</span> <span class="n">n_modes</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Eigenmode basis has only </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="o">.</span><span class="n">n_modes</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; modes, while </span><span class="si">{</span><span class="n">n_modes</span><span class="si">}</span><span class="s2"> were requested.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">identify_sparse_covariance_structure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">correlation_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify the sparse cross-basis covariance structure in the phenotype.</span>
<span class="sd">        This method analyzes the encoded phenotype to determine the covariance</span>
<span class="sd">        pairs that need to be modeled.</span>

<span class="sd">        Note: if the batches become too small, this estimate can become less stable</span>
<span class="sd">        in which case it is recommended to provide the sparse covariance structure</span>
<span class="sd">        to the model instead.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: np.ndarray</span>
<span class="sd">                The encoded training data representing the phenotype in the graph</span>
<span class="sd">                frequency domain.</span>
<span class="sd">            covariates_dataframe: pd.DataFrame</span>
<span class="sd">                The DataFrame containing covariates for the samples. The batch</span>
<span class="sd">                covariates will be used to group the samples and identify the</span>
<span class="sd">                important covariance pairs.</span>
<span class="sd">            correlation_threshold: float</span>
<span class="sd">                The threshold to include covariance pairs if significantly correlated.</span>
<span class="sd">                Should be between 0 and 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray:</span>
<span class="sd">                A (N, 2) array: the rows and columns of the</span>
<span class="sd">                identified sparse covariance structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start with correlation structure across the whole sample</span>
        <span class="n">corr_max</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_correlation_significance_by_fisher_z</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
            <span class="n">n_samples</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">correlation_threshold</span><span class="o">=</span><span class="n">correlation_threshold</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Now iterate over all batch covariates</span>
        <span class="k">for</span> <span class="n">batch_effect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">:</span>
            <span class="c1"># For every batch re-evaluate correlations</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">covariates_dataframe</span><span class="p">[</span><span class="n">batch_effect</span><span class="p">]):</span>
                <span class="c1"># Make a mask for the current batch</span>
                <span class="n">batch_mask</span> <span class="o">=</span> <span class="n">covariates_dataframe</span><span class="p">[</span><span class="n">batch_effect</span><span class="p">]</span> <span class="o">==</span> <span class="n">batch</span>
                <span class="c1"># Update maximums</span>
                <span class="n">corr_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">corr_max</span><span class="p">,</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_correlation_significance_by_fisher_z</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">batch_mask</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                            <span class="n">n_samples</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">batch_mask</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">correlation_threshold</span><span class="o">=</span><span class="n">correlation_threshold</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>

        <span class="c1"># Now compute the sparsity structure based on the resulting matrix</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">corr_max</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Remove redundant and duplicate pairs</span>
        <span class="n">rows_lim</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">rows</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="p">]</span>
        <span class="n">cols_lim</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">rows</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rows_lim</span><span class="p">,</span> <span class="n">cols_lim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_valid_covariance_structure</span><span class="p">(</span>
        <span class="n">covariance_structure</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the validity of the sparse covariance structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check it&#39;s a 2D array with two columns</span>
        <span class="n">expected_ndims</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">expected_ncols</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">covariance_structure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">covariance_structure</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">expected_ndims</span>
            <span class="ow">and</span> <span class="n">covariance_structure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_ncols</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">covariance_structure</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_single_direct</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variable_of_interest</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_model_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a direct normative model for a single spectral eigenmode.</span>
<span class="sd">        This method fits the base direct model to the provided variable of interest</span>
<span class="sd">        and covariates dataframe, allowing for the model to be trained on a specific</span>
<span class="sd">        eigenmode of the spectral embedding.</span>

<span class="sd">        Args:</span>
<span class="sd">            variable_of_interest: np.ndarray</span>
<span class="sd">                The loading vector capturing the variance within training data that</span>
<span class="sd">                corresponds to a single eigenmode.</span>
<span class="sd">            covariates_dataframe: pd.DataFrame</span>
<span class="sd">                DataFrame containing the covariates for the samples.</span>
<span class="sd">            save_directory: Path | None</span>
<span class="sd">                Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">            return_model_params: bool</span>
<span class="sd">                If True, return the fitted model parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict:</span>
<span class="sd">                If `return_model_params` is True, return the fitted model parameters</span>
<span class="sd">                in a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare the data for fitting</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">covariates_dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Add the mode loading as the variable of interest</span>
        <span class="n">train_data</span><span class="p">[</span><span class="s2">&quot;VOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span>

        <span class="c1"># Instantiate a direct normative model from the base model</span>
        <span class="n">direct_model</span> <span class="o">=</span> <span class="n">DirectNormativeModel</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">=</span><span class="n">NormativeModelSpec</span><span class="p">(</span>
                <span class="n">variable_of_interest</span><span class="o">=</span><span class="s2">&quot;VOI&quot;</span><span class="p">,</span>  <span class="c1"># Use the added VOI column</span>
                <span class="n">covariates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
                <span class="n">influencing_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_mean</span><span class="p">,</span>
                <span class="n">influencing_variance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_variance</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">batch_covariates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
            <span class="n">defaults</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Fit the model silently</span>
        <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">suppress_output</span><span class="p">():</span>
            <span class="n">direct_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
                <span class="n">save_directory</span><span class="o">=</span><span class="n">save_directory</span><span class="p">,</span>
                <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Return the fitted model parameters if requested</span>
        <span class="k">if</span> <span class="n">return_model_params</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">direct_model</span><span class="o">.</span><span class="n">model_params</span>

        <span class="c1"># If not returning model parameters, return None</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_single_covariance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variable_of_interest_1</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">variable_of_interest_2</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">direct_model_params_1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">direct_model_params_2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_model_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">defaults_overwrite</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a covariance normative model between a single pair of eigenmodes.</span>
<span class="sd">        This method fits a covariance model to the provided pair of variables</span>
<span class="sd">        and covariates dataframe, considering the direct model fits for each</span>
<span class="sd">        eigenmode, while allowing for the cross-eigenmode covariance to vary</span>
<span class="sd">        normatively.</span>

<span class="sd">        Args:</span>
<span class="sd">            variable_of_interest_1: np.ndarray</span>
<span class="sd">                The loading vector capturing the variance within training data that</span>
<span class="sd">                corresponds to a single eigenmode.</span>
<span class="sd">            variable_of_interest_2: np.ndarray</span>
<span class="sd">                The loading vector capturing the variance within training data that</span>
<span class="sd">                corresponds to a second eigenmode.</span>
<span class="sd">            direct_model_params_1: dict</span>
<span class="sd">                The parameters of the direct model fitted to the first eigenmode.</span>
<span class="sd">            direct_model_params_2: dict</span>
<span class="sd">                The parameters of the direct model fitted to the second eigenmode.</span>
<span class="sd">            covariates_dataframe: pd.DataFrame</span>
<span class="sd">                DataFrame containing the covariates for the samples.</span>
<span class="sd">            save_directory: Path | None</span>
<span class="sd">                Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">            return_model_params: bool</span>
<span class="sd">                If True, return the fitted model parameters.</span>
<span class="sd">            defaults_overwrite: dict (default={})</span>
<span class="sd">                Dictionary of default values to overwrite in the model fitting process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict:</span>
<span class="sd">                If `return_model_params` is True, return the fitted model parameters</span>
<span class="sd">                in a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare the data for fitting</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">covariates_dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Add the respective mode loadings as the variables of interest</span>
        <span class="n">train_data</span><span class="p">[</span><span class="s2">&quot;VOI_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest_1</span>
        <span class="n">train_data</span><span class="p">[</span><span class="s2">&quot;VOI_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest_2</span>
        <span class="n">train_data</span><span class="p">[[</span><span class="s2">&quot;VOI_1_mu_estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;VOI_1_std_estimate&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">train_data</span><span class="p">,</span>
                <span class="n">model_params</span><span class="o">=</span><span class="n">direct_model_params_1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
            <span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>  <span class="c1"># Add the direct model predictions</span>
        <span class="n">train_data</span><span class="p">[[</span><span class="s2">&quot;VOI_2_mu_estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;VOI_2_std_estimate&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">train_data</span><span class="p">,</span>
                <span class="n">model_params</span><span class="o">=</span><span class="n">direct_model_params_2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
            <span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>  <span class="c1"># Add the direct model predictions</span>

        <span class="c1"># Instantiate a covariance normative model from the base model</span>
        <span class="n">covariance_model</span> <span class="o">=</span> <span class="n">CovarianceNormativeModel</span><span class="o">.</span><span class="n">from_direct_model</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span>
            <span class="n">variable_of_interest_1</span><span class="o">=</span><span class="s2">&quot;VOI_1&quot;</span><span class="p">,</span>
            <span class="n">variable_of_interest_2</span><span class="o">=</span><span class="s2">&quot;VOI_2&quot;</span><span class="p">,</span>
            <span class="n">defaults_overwrite</span><span class="o">=</span><span class="p">(</span><span class="n">defaults_overwrite</span> <span class="ow">or</span> <span class="p">{}),</span>
        <span class="p">)</span>

        <span class="c1"># Fit the model silently</span>
        <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">suppress_output</span><span class="p">():</span>
            <span class="n">covariance_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
                <span class="n">save_directory</span><span class="o">=</span><span class="n">save_directory</span><span class="p">,</span>
                <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Return the fitted model parameters if requested</span>
        <span class="k">if</span> <span class="n">return_model_params</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">covariance_model</span><span class="o">.</span><span class="n">model_params</span>

        <span class="c1"># If not returning model parameters, return None</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_all_direct</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_separate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the direct models for all specified eigenmodes.</span>

<span class="sd">        Args:</span>
<span class="sd">            encoded_train_data: np.ndarray</span>
<span class="sd">                Encoded training data as a numpy array (n_samples, n_modes).</span>
<span class="sd">            covariates_dataframe: pd.DataFrame</span>
<span class="sd">                DataFrame containing the covariates for the samples.</span>
<span class="sd">                It must include all specified covariates in the model specification.</span>
<span class="sd">            n_modes: int (default=-1)</span>
<span class="sd">                Number of eigenmodes to fit the model to. If -1, all modes are</span>
<span class="sd">                used. If a positive integer, only the first n_modes are used.</span>
<span class="sd">                Note that the encoded_train_data and the eigenmode basis should have</span>
<span class="sd">                at least n_modes columns/eigenvectors.</span>
<span class="sd">            n_jobs: int (default=-1)</span>
<span class="sd">                Number of parallel jobs to use for fitting the model. If -1, all</span>
<span class="sd">                available CPU cores are used. If 1, no parallelization is used.</span>
<span class="sd">            save_directory: Path | None</span>
<span class="sd">                Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">                A subdirectory named &quot;spectral_normative_model&quot; will be created</span>
<span class="sd">                within the specified save_directory.</span>
<span class="sd">            save_separate: bool (default=False)</span>
<span class="sd">                Whether to save the fitted direct model parameters separately for each</span>
<span class="sd">                eigenmode as individual files. This is only applicable if</span>
<span class="sd">                `save_directory` is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Setup the save directory if needed</span>
        <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>

        <span class="c1"># Fit the base direct model for each eigenmode using parallel processing</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_single_direct</span><span class="p">)(</span>
                <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span>
                <span class="n">covariates_dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
                <span class="n">save_directory</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">ensure_dir</span><span class="p">(</span>
                        <span class="n">save_directory</span>
                        <span class="o">/</span> <span class="s2">&quot;spectral_normative_model&quot;</span>
                        <span class="o">/</span> <span class="s2">&quot;direct_models&quot;</span>
                        <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;mode_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">save_separate</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_modes</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">ParallelTqdm</span><span class="p">(</span>
                <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
                <span class="n">total_tasks</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fitting direct models&quot;</span><span class="p">,</span>
            <span class="p">)(</span><span class="n">tasks</span><span class="p">),</span>  <span class="c1"># pyright: ignore[reportCallIssue]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_all_covariance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_separate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the direct models for all specified eigenmodes.</span>

<span class="sd">        Args:</span>
<span class="sd">            encoded_train_data: np.ndarray</span>
<span class="sd">                Encoded training data as a numpy array (n_samples, n_modes).</span>
<span class="sd">            covariates_dataframe: pd.DataFrame</span>
<span class="sd">                DataFrame containing the covariates for the samples.</span>
<span class="sd">                It must include all specified covariates in the model specification.</span>
<span class="sd">            n_jobs: int (default=-1)</span>
<span class="sd">                Number of parallel jobs to use for fitting the model. If -1, all</span>
<span class="sd">                available CPU cores are used. If 1, no parallelization is used.</span>
<span class="sd">            save_directory: Path | None</span>
<span class="sd">                Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">                A subdirectory named &quot;spectral_normative_model&quot; will be created</span>
<span class="sd">                within the specified save_directory.</span>
<span class="sd">            save_separate: bool (default=False)</span>
<span class="sd">                Whether to save the fitted direct model parameters separately for each</span>
<span class="sd">                eigenmode as individual files. This is only applicable if</span>
<span class="sd">                `save_directory` is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Setup the save directory if needed</span>
        <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>

        <span class="c1"># Fit the base covariance models for selected eigenmode pairs in parallel</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_single_covariance</span><span class="p">)(</span>
                <span class="n">variable_of_interest_1</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">[</span>
                    <span class="p">:,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="n">variable_of_interest_2</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">[</span>
                    <span class="p">:,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="n">direct_model_params_1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="p">],</span>
                <span class="n">direct_model_params_2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">],</span>
                <span class="n">covariates_dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
                <span class="n">save_directory</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">ensure_dir</span><span class="p">(</span>
                        <span class="n">save_directory</span>
                        <span class="o">/</span> <span class="s2">&quot;spectral_normative_model&quot;</span>
                        <span class="o">/</span> <span class="s2">&quot;covariance_models&quot;</span>
                        <span class="o">/</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;mode_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">,&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;mode_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">save_separate</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariance_model_params</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">ParallelTqdm</span><span class="p">(</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
            <span class="n">total_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fitting covariance models&quot;</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">tasks</span><span class="p">)</span>  <span class="c1"># pyright: ignore[reportCallIssue]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_separate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">covariance_structure</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the spectral normative model to the provided encoded training data.</span>

<span class="sd">        Args:</span>
<span class="sd">            encoded_train_data: np.ndarray</span>
<span class="sd">                Encoded training data as a numpy array (n_samples, n_modes).</span>
<span class="sd">            covariates_dataframe: pd.DataFrame</span>
<span class="sd">                DataFrame containing the covariates for the samples.</span>
<span class="sd">                It must include all specified covariates in the model specification.</span>
<span class="sd">            n_modes: int (default=-1)</span>
<span class="sd">                Number of eigenmodes to fit the model to. If -1, all modes are</span>
<span class="sd">                used. If a positive integer, only the first n_modes are used.</span>
<span class="sd">                Note that the encoded_train_data and the eigenmode basis should have</span>
<span class="sd">                at least n_modes columns/eigenvectors.</span>
<span class="sd">            n_jobs: int (default=-1)</span>
<span class="sd">                Number of parallel jobs to use for fitting the model. If -1, all</span>
<span class="sd">                available CPU cores are used. If 1, no parallelization is used.</span>
<span class="sd">            save_directory: Path | None</span>
<span class="sd">                Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">                A subdirectory named &quot;spectral_normative_model&quot; will be created</span>
<span class="sd">                within the specified save_directory.</span>
<span class="sd">            save_separate: bool (default=False)</span>
<span class="sd">                Whether to save the fitted direct model parameters separately for each</span>
<span class="sd">                eigenmode as individual files. This is only applicable if</span>
<span class="sd">                `save_directory` is provided.</span>
<span class="sd">            covariance_structure: np.ndarray | float</span>
<span class="sd">                Sparse covariance structure to use for the model fitting. If a</span>
<span class="sd">                (2, n_pairs) array of row and column indices are provided, the model</span>
<span class="sd">                will use this structure. If float, the model will estimate the</span>
<span class="sd">                covariance structure based on the training data and the float value</span>
<span class="sd">                will be used as the threshold to exclude small correlations to form a</span>
<span class="sd">                sparse covariance structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting SNM model fitting:&quot;</span><span class="p">)</span>
        <span class="c1"># Evaluate the number of modes to fit</span>
        <span class="k">if</span> <span class="n">n_modes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="o">.</span><span class="n">n_modes</span>
        <span class="c1"># Validate the input data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">encoded_train_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;encoded_train_data must be a numpy array.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoded_train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n_modes</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;encoded_train_data must have at least </span><span class="si">{</span><span class="n">n_modes</span><span class="si">}</span><span class="s2"> columns (n_modes).&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">&lt;</span> <span class="n">n_modes</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Eigenmode basis has only </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="o">.</span><span class="n">n_modes</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; modes, while </span><span class="si">{</span><span class="n">n_modes</span><span class="si">}</span><span class="s2"> were requested.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># Setup the save directory if needed</span>
        <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Prepare the save directory</span>
            <span class="n">save_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">prepare_save_directory</span><span class="p">(</span>
                <span class="n">save_directory</span><span class="p">,</span>
                <span class="s2">&quot;spectral_normative_model&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 1; direct models for each eigenmode (</span><span class="si">%s</span><span class="s2"> modes)&quot;</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_all_direct</span><span class="p">(</span>
            <span class="n">encoded_train_data</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">,</span>
            <span class="n">covariates_dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
            <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
            <span class="n">save_directory</span><span class="o">=</span><span class="n">save_directory</span><span class="p">,</span>
            <span class="n">save_separate</span><span class="o">=</span><span class="n">save_separate</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 2; identify sparse covariance structure&quot;</span><span class="p">)</span>

        <span class="c1"># Identify sparse covariance structure if a float value is given</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">covariance_structure</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="c1"># Use trained models to compute z-scores</span>
            <span class="n">encoded_train_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                        <span class="n">test_covariates</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
                        <span class="n">model_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">extend_predictions</span><span class="p">(</span>
                        <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">[:,</span> <span class="n">x</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;z-score&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_modes</span><span class="p">)</span>
                <span class="p">],</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identify_sparse_covariance_structure</span><span class="p">(</span>
                    <span class="n">encoded_train_z_scores</span><span class="p">,</span>
                    <span class="n">covariates_dataframe</span><span class="p">,</span>
                    <span class="n">covariance_structure</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">covariance_structure</span><span class="p">)</span>

        <span class="c1"># Verify that the covariance structure is valid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid_covariance_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Invalid sparse covariance structure.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># Model cross basis sparse covariance structure</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Step 3; cross-eigenmode dependency modeling (</span><span class="si">%s</span><span class="s2"> pairs)&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_all_covariance</span><span class="p">(</span>
            <span class="n">encoded_train_data</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">,</span>
            <span class="n">covariates_dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
            <span class="n">save_directory</span><span class="o">=</span><span class="n">save_directory</span><span class="p">,</span>
            <span class="n">save_separate</span><span class="o">=</span><span class="n">save_separate</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Save SNM model parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;n_modes&quot;</span><span class="p">:</span> <span class="n">n_modes</span><span class="p">,</span>
            <span class="s2">&quot;sample_size&quot;</span><span class="p">:</span> <span class="n">encoded_train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;direct_model_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">,</span>
            <span class="s2">&quot;sparse_covariance_structure&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">,</span>
            <span class="s2">&quot;covariance_model_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance_model_params</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="s2">&quot;n_params&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Direct model parameters are not valid.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># Save the model if a save path is provided</span>
        <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_predict_from_spectral_estimates</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">encoded_query</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">eigenmode_mu_estimates</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">eigenmode_std_estimates</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">rho_estimates</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method to predict only the mean and sigma for new data using the fitted</span>
<span class="sd">        spectral moments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare the predictions</span>
        <span class="n">predictions_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">predictions_dict</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eigenmode_mu_estimates</span> <span class="o">@</span> <span class="n">encoded_query</span>
        <span class="c1"># empty initialization of std estimates</span>
        <span class="n">predictions_dict</span><span class="p">[</span><span class="s2">&quot;std_estimate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions_dict</span><span class="p">[</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Load sparse covariance structure</span>
        <span class="n">row_indices</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;sparse_covariance_structure&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">col_indices</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;sparse_covariance_structure&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Select indices that are both within n_modes</span>
        <span class="n">corr_index_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">row_indices</span> <span class="o">&lt;</span> <span class="n">n_modes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col_indices</span> <span class="o">&lt;</span> <span class="n">n_modes</span><span class="p">)</span>

        <span class="c1"># Estimate query variance for each sample</span>
        <span class="k">for</span> <span class="n">sample_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_covariates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># Build sparse correlation matrix</span>
            <span class="n">sparse_correlations</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">rho_estimates</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">,</span> <span class="n">corr_index_valid</span><span class="p">],</span>  <span class="c1"># sparse data values</span>
                    <span class="p">(</span>  <span class="c1"># row, column indices</span>
                        <span class="n">row_indices</span><span class="p">[</span><span class="n">corr_index_valid</span><span class="p">],</span>
                        <span class="n">col_indices</span><span class="p">[</span><span class="n">corr_index_valid</span><span class="p">],</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
            <span class="c1"># Make it symmetric</span>
            <span class="n">sparse_correlations</span> <span class="o">=</span> <span class="n">sparse_correlations</span> <span class="o">+</span> <span class="n">sparse_correlations</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># Set diagonal to 1</span>
            <span class="n">sparse_correlations</span><span class="o">.</span><span class="n">setdiag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1"># Weight mode stds by encoding</span>
            <span class="n">weighted_mode_stds</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="n">eigenmode_std_estimates</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span>
                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">encoded_query</span>
            <span class="p">)</span>
            <span class="c1"># Compute the variance estimate</span>
            <span class="n">predictions_dict</span><span class="p">[</span><span class="s2">&quot;std_estimate&quot;</span><span class="p">][</span><span class="n">sample_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">weighted_mode_stds</span> <span class="o">*</span> <span class="p">(</span><span class="n">sparse_correlations</span> <span class="o">@</span> <span class="n">weighted_mode_stds</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Create a the predictions object</span>
        <span class="k">return</span> <span class="n">NormativePredictions</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions_dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">encoded_query</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">extended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">encoded_test_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict normative moments (mean, std) for new data using the fitted spectral</span>
<span class="sd">        normative model.</span>
<span class="sd">        Spectral normative modeling can estimate the normative distribution of any</span>
<span class="sd">        variable of interest defined as a spatial query encoded in the latent low-pass</span>
<span class="sd">        graph spectral space.</span>

<span class="sd">        Args:</span>
<span class="sd">            encoded_query: np.ndarray</span>
<span class="sd">                Encoded query data defining the normative variable of interest.</span>
<span class="sd">                Can be provided as:</span>
<span class="sd">                - shape = (n_modes) for a single query vector</span>
<span class="sd">                - shape = (n_modes, n_queries) for multiple queries predicted at once</span>
<span class="sd">            test_covariates: pd.DataFrame</span>
<span class="sd">                DataFrame containing the new covariate data to predict.</span>
<span class="sd">                This must include all specified covariates.</span>
<span class="sd">            extended: bool (default: False)</span>
<span class="sd">                If True, return additional stats such as log-likelihood, centiles, etc.</span>
<span class="sd">                Note that extended predictions require encoded_test_data to be</span>
<span class="sd">                provided in addition to the covariates.</span>
<span class="sd">            model_params: dict | None</span>
<span class="sd">                Optional dictionary of model parameters to use. If not provided,</span>
<span class="sd">                the stored parameters from model.fit() will be used.</span>
<span class="sd">            encoded_test_data: np.ndarray | None</span>
<span class="sd">                Optional encoded test data for the phenotype being modeled (only</span>
<span class="sd">                required for extended predictions).</span>
<span class="sd">                Expects a numpy array (n_samples, n_modes)</span>
<span class="sd">            n_modes: int | None</span>
<span class="sd">                Optional number of modes to use for the prediction. If not provided,</span>
<span class="sd">                the stored number of modes from model.fit() will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: DataFrame containing the predicted moments (mean, std) for</span>
<span class="sd">                the variable of interest defined by the encoded query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find n_modes</span>
        <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_modes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_modes&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;The base model is not specified. Cannot predict new data.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="c1"># Validate the new data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fit_input</span><span class="p">(</span><span class="n">encoded_train_data</span><span class="o">=</span><span class="n">encoded_query</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">)</span>

        <span class="c1"># Parameters</span>
        <span class="k">if</span> <span class="n">model_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>

        <span class="c1"># direct normative predictions for each eigenmode</span>
        <span class="n">eigenmode_mu_estimates</span><span class="p">,</span> <span class="n">eigenmode_std_estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                    <span class="n">test_covariates</span><span class="p">,</span>
                    <span class="n">model_params</span><span class="o">=</span><span class="n">direct_model_params</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">to_array</span><span class="p">([</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;std_estimate&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">T</span>
                <span class="k">for</span> <span class="n">direct_model_params</span> <span class="ow">in</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;direct_model_params&quot;</span><span class="p">]</span>
            <span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># estimates have a shape of (n_samples, n_modes)</span>

        <span class="c1"># create a dummy covariance model</span>
        <span class="n">covariance_model</span> <span class="o">=</span> <span class="n">CovarianceNormativeModel</span><span class="o">.</span><span class="n">from_direct_model</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span>
            <span class="n">variable_of_interest_1</span><span class="o">=</span><span class="s2">&quot;dummy_VOI_1&quot;</span><span class="p">,</span>  <span class="c1"># Dummy variable of interest</span>
            <span class="n">variable_of_interest_2</span><span class="o">=</span><span class="s2">&quot;dummy_VOI_2&quot;</span><span class="p">,</span>  <span class="c1"># Dummy variable of interest</span>
        <span class="p">)</span>

        <span class="c1"># cross-mode dependence structure</span>
        <span class="n">rho_estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">covariance_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                    <span class="n">test_covariates</span><span class="p">,</span>
                    <span class="n">model_params</span><span class="o">=</span><span class="n">covariance_model_params</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">to_array</span><span class="p">([</span><span class="s2">&quot;correlation_estimate&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">T</span>
                <span class="k">for</span> <span class="n">covariance_model_params</span> <span class="ow">in</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;covariance_model_params&quot;</span><span class="p">]</span>
            <span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># estimates have a shape of (n_samples, n_covariance_pairs)</span>

        <span class="c1"># reformat encoded queries</span>
        <span class="n">encoded_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">encoded_query</span><span class="p">[:</span><span class="n">n_modes</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_modes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Compute the predictions</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_from_spectral_estimates</span><span class="p">(</span>
            <span class="n">encoded_query</span><span class="o">=</span><span class="n">encoded_query</span><span class="p">,</span>
            <span class="n">eigenmode_mu_estimates</span><span class="o">=</span><span class="n">eigenmode_mu_estimates</span><span class="p">,</span>
            <span class="n">eigenmode_std_estimates</span><span class="o">=</span><span class="n">eigenmode_std_estimates</span><span class="p">,</span>
            <span class="n">rho_estimates</span><span class="o">=</span><span class="n">rho_estimates</span><span class="p">,</span>
            <span class="n">test_covariates</span><span class="o">=</span><span class="n">test_covariates</span><span class="p">,</span>
            <span class="n">model_params</span><span class="o">=</span><span class="n">model_params</span><span class="p">,</span>
            <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Check if extended predictions are requested</span>
        <span class="k">if</span> <span class="n">extended</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">encoded_test_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Extended predictions require encoded_test_data to be provided.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="c1"># Add extended statistics to predictions (e.g. centiles, log-loss, etc.)</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">extend_predictions</span><span class="p">(</span>
                <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">encoded_test_data</span> <span class="o">@</span> <span class="n">encoded_query</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">encoded_query</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">encoded_test_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">query_train_moments</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the model on new data and return predictions along with evaluation</span>
<span class="sd">        metrics.</span>

<span class="sd">        Args:</span>
<span class="sd">            encoded_query: np.ndarray</span>
<span class="sd">                Encoded query data defining the normative variable of interest.</span>
<span class="sd">                Can be provided as:</span>
<span class="sd">                - shape = (n_modes) for a single query vector</span>
<span class="sd">                - shape = (n_modes, n_queries) for multiple queries predicted at once</span>
<span class="sd">            test_covariates: pd.DataFrame</span>
<span class="sd">                DataFrame containing the new covariate data to predict.</span>
<span class="sd">                This must include all specified covariates.</span>
<span class="sd">            encoded_test_data: np.ndarray | None</span>
<span class="sd">                Encoded test data for the phenotype being modeled. Expects a numpy array</span>
<span class="sd">                of shape: (n_test, n_modes).</span>
<span class="sd">            query_train_moments: np.ndarray | None</span>
<span class="sd">                A (2, n_queries) array containing the query moments (mean, std) directly</span>
<span class="sd">                measured in the training data. While optional, providing these moments</span>
<span class="sd">                is strongly recommended for accurate evaluation of the model&#39;s MSLL.</span>
<span class="sd">                If not provided, the model will use the test data moments as an</span>
<span class="sd">                approximation, which may lead to overestimating MSLL. This is made</span>
<span class="sd">                optional to allow evaluating MSLL when the training data is not</span>
<span class="sd">                accessible (e.g. using a pre-trained model).</span>
<span class="sd">            model_params: dict | None</span>
<span class="sd">                Optional dictionary of model parameters to use. If not provided,</span>
<span class="sd">                the stored parameters from model.fit() will be used.</span>
<span class="sd">            n_modes: int | None</span>
<span class="sd">                Optional number of modes to use for the prediction. If not provided,</span>
<span class="sd">                the stored number of modes from model.fit() will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            NormativePredictions:</span>
<span class="sd">                Object containing the predicted moments (mean, std) for</span>
<span class="sd">                the variable of interest defined by the encoded query, along with</span>
<span class="sd">                evaluation metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find n_modes</span>
        <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_modes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_modes&quot;</span><span class="p">])</span>

        <span class="c1"># Parameters</span>
        <span class="k">if</span> <span class="n">model_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>

        <span class="c1"># reformat encoded queries</span>
        <span class="n">encoded_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">encoded_query</span><span class="p">[:</span><span class="n">n_modes</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_modes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Run extended predictions</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">encoded_query</span><span class="o">=</span><span class="n">encoded_query</span><span class="p">,</span>
            <span class="n">test_covariates</span><span class="o">=</span><span class="n">test_covariates</span><span class="p">,</span>
            <span class="n">extended</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">model_params</span><span class="o">=</span><span class="n">model_params</span><span class="p">,</span>
            <span class="n">encoded_test_data</span><span class="o">=</span><span class="n">encoded_test_data</span><span class="p">,</span>
            <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">query_train_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Query moments not provided. Using test data moments as an&quot;</span>
                <span class="s2">&quot; approximation, which may lead to overestimating MSLL.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">query_train_moments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">encoded_test_data</span> <span class="o">@</span> <span class="n">encoded_query</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">encoded_test_data</span> <span class="o">@</span> <span class="n">encoded_query</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">evaluate_predictions</span><span class="p">(</span>
            <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">encoded_test_data</span> <span class="o">@</span> <span class="n">encoded_query</span><span class="p">,</span>
            <span class="n">train_mean</span><span class="o">=</span><span class="n">query_train_moments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">train_std</span><span class="o">=</span><span class="n">query_train_moments</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">n_params</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralNormativeModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a spectral normative model instance from the specified save directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory: Path</span>
<span class="sd">                Directory to load the fitted model from. A subdirectory named</span>
<span class="sd">                &quot;spectral_normative_model&quot; will be searched within this directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the load directory</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_load_directory</span><span class="p">(</span>
            <span class="n">directory</span><span class="p">,</span>
            <span class="s2">&quot;spectral_normative_model&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Check if the pickled joblib file exists in this directory</span>
        <span class="n">pickled_file</span> <span class="o">=</span> <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;spectral_model_dict.joblib&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pickled_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Model Load Error: Pickled file &#39;</span><span class="si">{</span><span class="n">pickled_file</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="n">model_dict</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickled_file</span><span class="p">)</span>

        <span class="c1"># Create an instance of the class</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">eigenmode_basis</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;eigenmode_basis&quot;</span><span class="p">],</span>
            <span class="n">base_model</span><span class="o">=</span><span class="n">DirectNormativeModel</span><span class="p">(</span>
                <span class="n">spec</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span>
                <span class="n">batch_covariates</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;batch_covariates&quot;</span><span class="p">],</span>
                <span class="n">defaults</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;defaults&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;model_params&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.build_from_dataframe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_from_dataframe</span><span class="p">(</span><span class="n">eigenmode_basis</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">gsp</span><span class="o">.</span><span class="n">EigenmodeBasis</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">,</span> <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">numerical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">categorical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nonlinear_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">influencing_mean</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">influencing_variance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spline_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralNormativeModel</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize SNM with an eigenmode basis and a base direct model built from a
pandas DataFrame containing all covariates.</p>
<p>This uses the from_dataframe method of the DirectNormativeModel class
to populate the direct model specification of SNM. Given that SNM does not
require a fixed variable of interest, this method assigns a dummy name
to the variable_of_interest parameter of the DirectNormativeModel. As such,
the provided dataframe should not contain a column with "dummy_VOI" as name.</p>
<p>Essentially, the provided dataframe should contain all covariates as columns.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>eigenmode_basis</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="EigenmodeBasis


  
      dataclass
   (spectranorm.utils.gsp.EigenmodeBasis)" href="#spectranorm.utils.gsp.EigenmodeBasis">EigenmodeBasis</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>utils.gsp.EigenmodeBasis
The eigenmode basis to be used for spectral normative modeling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_type</code>
            </td>
            <td>
                  <code><span title="spectranorm.snm.ModelType">ModelType</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ModelType
Type of the model to create, either "HBR" (Hierarchical Bayesian
Regression) or "BLR" (Bayesian Linear Regression).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates_dataframe</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the data for all covariates and all samples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>numerical_covariates</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of numerical covariate names.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>categorical_covariates</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of categorical covariate names.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_covariates</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of batch covariate names which should also be included in
categorical_covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nonlinear_covariates</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of covariate names to be modeled as nonlinear effects.
These should also be included in numerical_covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>influencing_mean</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of covariate names that influence the mean of the variable
of interest. These should be included in either numerical_covariates
or categorical_covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>influencing_variance</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str] | None
List of covariate names that influence the variance of the variable
of interest. These should be included in either numerical_covariates
or categorical_covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spline_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict
Additional keyword arguments for spline specification, such as
<code>df</code>, <code>degree</code>, and <code>knots</code>. These are passed to the
<code>create_spline_spec</code> method to create spline specifications for
nonlinear covariates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="SpectralNormativeModel


  
      dataclass
   (spectranorm.snm.SpectralNormativeModel)" href="#spectranorm.snm.SpectralNormativeModel">SpectralNormativeModel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SpectralNormativeModel
An instance of SpectralNormativeModel with base model specs initialized
based on the provided data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_from_dataframe</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">eigenmode_basis</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">gsp</span><span class="o">.</span><span class="n">EigenmodeBasis</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">,</span>
    <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">numerical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nonlinear_covariates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">influencing_mean</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">influencing_variance</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spline_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralNormativeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize SNM with an eigenmode basis and a base direct model built from a</span>
<span class="sd">    pandas DataFrame containing all covariates.</span>

<span class="sd">    This uses the from_dataframe method of the DirectNormativeModel class</span>
<span class="sd">    to populate the direct model specification of SNM. Given that SNM does not</span>
<span class="sd">    require a fixed variable of interest, this method assigns a dummy name</span>
<span class="sd">    to the variable_of_interest parameter of the DirectNormativeModel. As such,</span>
<span class="sd">    the provided dataframe should not contain a column with &quot;dummy_VOI&quot; as name.</span>

<span class="sd">    Essentially, the provided dataframe should contain all covariates as columns.</span>

<span class="sd">    Args:</span>
<span class="sd">        eigenmode_basis: utils.gsp.EigenmodeBasis</span>
<span class="sd">            The eigenmode basis to be used for spectral normative modeling.</span>
<span class="sd">        model_type: ModelType</span>
<span class="sd">            Type of the model to create, either &quot;HBR&quot; (Hierarchical Bayesian</span>
<span class="sd">            Regression) or &quot;BLR&quot; (Bayesian Linear Regression).</span>
<span class="sd">        covariates_dataframe: pd.DataFrame</span>
<span class="sd">            DataFrame containing the data for all covariates and all samples.</span>
<span class="sd">        numerical_covariates: list[str] | None</span>
<span class="sd">            List of numerical covariate names.</span>
<span class="sd">        categorical_covariates: list[str] | None</span>
<span class="sd">            List of categorical covariate names.</span>
<span class="sd">        batch_covariates: list[str] | None</span>
<span class="sd">            List of batch covariate names which should also be included in</span>
<span class="sd">            categorical_covariates.</span>
<span class="sd">        nonlinear_covariates: list[str] | None</span>
<span class="sd">            List of covariate names to be modeled as nonlinear effects.</span>
<span class="sd">            These should also be included in numerical_covariates.</span>
<span class="sd">        influencing_mean: list[str] | None</span>
<span class="sd">            List of covariate names that influence the mean of the variable</span>
<span class="sd">            of interest. These should be included in either numerical_covariates</span>
<span class="sd">            or categorical_covariates.</span>
<span class="sd">        influencing_variance: list[str] | None</span>
<span class="sd">            List of covariate names that influence the variance of the variable</span>
<span class="sd">            of interest. These should be included in either numerical_covariates</span>
<span class="sd">            or categorical_covariates.</span>
<span class="sd">        spline_kwargs: dict</span>
<span class="sd">            Additional keyword arguments for spline specification, such as</span>
<span class="sd">            `df`, `degree`, and `knots`. These are passed to the</span>
<span class="sd">            `create_spline_spec` method to create spline specifications for</span>
<span class="sd">            nonlinear covariates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SpectralNormativeModel</span>
<span class="sd">            An instance of SpectralNormativeModel with base model specs initialized</span>
<span class="sd">            based on the provided data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add a dummy variable of interest to the covariates_dataframe</span>
    <span class="n">covariates_dataframe</span> <span class="o">=</span> <span class="n">covariates_dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">covariates_dataframe</span><span class="p">[</span><span class="s2">&quot;dummy_VOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Dummy variable of interest</span>
    <span class="c1"># Specify the base model from the dataframe</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">eigenmode_basis</span><span class="o">=</span><span class="n">eigenmode_basis</span><span class="p">,</span>
        <span class="n">base_model</span><span class="o">=</span><span class="n">DirectNormativeModel</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
            <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span>
            <span class="n">dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
            <span class="n">variable_of_interest</span><span class="o">=</span><span class="s2">&quot;dummy_VOI&quot;</span><span class="p">,</span>  <span class="c1"># Dummy variable of interest</span>
            <span class="n">numerical_covariates</span><span class="o">=</span><span class="p">(</span><span class="n">numerical_covariates</span> <span class="ow">or</span> <span class="p">[]),</span>
            <span class="n">categorical_covariates</span><span class="o">=</span><span class="p">(</span><span class="n">categorical_covariates</span> <span class="ow">or</span> <span class="p">[]),</span>
            <span class="n">batch_covariates</span><span class="o">=</span><span class="p">(</span><span class="n">batch_covariates</span> <span class="ow">or</span> <span class="p">[]),</span>
            <span class="n">nonlinear_covariates</span><span class="o">=</span><span class="p">(</span><span class="n">nonlinear_covariates</span> <span class="ow">or</span> <span class="p">[]),</span>
            <span class="n">influencing_mean</span><span class="o">=</span><span class="p">(</span><span class="n">influencing_mean</span> <span class="ow">or</span> <span class="p">[]),</span>
            <span class="n">influencing_variance</span><span class="o">=</span><span class="p">(</span><span class="n">influencing_variance</span> <span class="ow">or</span> <span class="p">[]),</span>
            <span class="n">spline_kwargs</span><span class="o">=</span><span class="p">(</span><span class="n">spline_kwargs</span> <span class="ow">or</span> <span class="p">{}),</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.evaluate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate</span><span class="p">(</span><span class="n">encoded_query</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">encoded_test_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">query_train_moments</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Evaluate the model on new data and return predictions along with evaluation
metrics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>encoded_query</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Encoded query data defining the normative variable of interest.
Can be provided as:
- shape = (n_modes) for a single query vector
- shape = (n_modes, n_queries) for multiple queries predicted at once</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_covariates</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the new covariate data to predict.
This must include all specified covariates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>encoded_test_data</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray | None
Encoded test data for the phenotype being modeled. Expects a numpy array
of shape: (n_test, n_modes).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>query_train_moments</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray | None
A (2, n_queries) array containing the query moments (mean, std) directly
measured in the training data. While optional, providing these moments
is strongly recommended for accurate evaluation of the model's MSLL.
If not provided, the model will use the test data moments as an
approximation, which may lead to overestimating MSLL. This is made
optional to allow evaluating MSLL when the training data is not
accessible (e.g. using a pre-trained model).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict | None
Optional dictionary of model parameters to use. If not provided,
the stored parameters from model.fit() will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_modes</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int | None
Optional number of modes to use for the prediction. If not provided,
the stored number of modes from model.fit() will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>NormativePredictions</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="NormativePredictions


  
      dataclass
   (spectranorm.snm.NormativePredictions)" href="#spectranorm.snm.NormativePredictions">NormativePredictions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object containing the predicted moments (mean, std) for
the variable of interest defined by the encoded query, along with
evaluation metrics.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">encoded_query</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">encoded_test_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">query_train_moments</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the model on new data and return predictions along with evaluation</span>
<span class="sd">    metrics.</span>

<span class="sd">    Args:</span>
<span class="sd">        encoded_query: np.ndarray</span>
<span class="sd">            Encoded query data defining the normative variable of interest.</span>
<span class="sd">            Can be provided as:</span>
<span class="sd">            - shape = (n_modes) for a single query vector</span>
<span class="sd">            - shape = (n_modes, n_queries) for multiple queries predicted at once</span>
<span class="sd">        test_covariates: pd.DataFrame</span>
<span class="sd">            DataFrame containing the new covariate data to predict.</span>
<span class="sd">            This must include all specified covariates.</span>
<span class="sd">        encoded_test_data: np.ndarray | None</span>
<span class="sd">            Encoded test data for the phenotype being modeled. Expects a numpy array</span>
<span class="sd">            of shape: (n_test, n_modes).</span>
<span class="sd">        query_train_moments: np.ndarray | None</span>
<span class="sd">            A (2, n_queries) array containing the query moments (mean, std) directly</span>
<span class="sd">            measured in the training data. While optional, providing these moments</span>
<span class="sd">            is strongly recommended for accurate evaluation of the model&#39;s MSLL.</span>
<span class="sd">            If not provided, the model will use the test data moments as an</span>
<span class="sd">            approximation, which may lead to overestimating MSLL. This is made</span>
<span class="sd">            optional to allow evaluating MSLL when the training data is not</span>
<span class="sd">            accessible (e.g. using a pre-trained model).</span>
<span class="sd">        model_params: dict | None</span>
<span class="sd">            Optional dictionary of model parameters to use. If not provided,</span>
<span class="sd">            the stored parameters from model.fit() will be used.</span>
<span class="sd">        n_modes: int | None</span>
<span class="sd">            Optional number of modes to use for the prediction. If not provided,</span>
<span class="sd">            the stored number of modes from model.fit() will be used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        NormativePredictions:</span>
<span class="sd">            Object containing the predicted moments (mean, std) for</span>
<span class="sd">            the variable of interest defined by the encoded query, along with</span>
<span class="sd">            evaluation metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find n_modes</span>
    <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_modes&quot;</span><span class="p">])</span>

    <span class="c1"># Parameters</span>
    <span class="k">if</span> <span class="n">model_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>

    <span class="c1"># reformat encoded queries</span>
    <span class="n">encoded_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">encoded_query</span><span class="p">[:</span><span class="n">n_modes</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_modes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Run extended predictions</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">encoded_query</span><span class="o">=</span><span class="n">encoded_query</span><span class="p">,</span>
        <span class="n">test_covariates</span><span class="o">=</span><span class="n">test_covariates</span><span class="p">,</span>
        <span class="n">extended</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">model_params</span><span class="o">=</span><span class="n">model_params</span><span class="p">,</span>
        <span class="n">encoded_test_data</span><span class="o">=</span><span class="n">encoded_test_data</span><span class="p">,</span>
        <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">query_train_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Query moments not provided. Using test data moments as an&quot;</span>
            <span class="s2">&quot; approximation, which may lead to overestimating MSLL.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">query_train_moments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">encoded_test_data</span> <span class="o">@</span> <span class="n">encoded_query</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">encoded_test_data</span> <span class="o">@</span> <span class="n">encoded_query</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">evaluate_predictions</span><span class="p">(</span>
        <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">encoded_test_data</span> <span class="o">@</span> <span class="n">encoded_query</span><span class="p">,</span>
        <span class="n">train_mean</span><span class="o">=</span><span class="n">query_train_moments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">train_std</span><span class="o">=</span><span class="n">query_train_moments</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">n_params</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_separate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">covariance_structure</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Fit the spectral normative model to the provided encoded training data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>encoded_train_data</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Encoded training data as a numpy array (n_samples, n_modes).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates_dataframe</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the covariates for the samples.
It must include all specified covariates in the model specification.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_modes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int (default=-1)
Number of eigenmodes to fit the model to. If -1, all modes are
used. If a positive integer, only the first n_modes are used.
Note that the encoded_train_data and the eigenmode basis should have
at least n_modes columns/eigenvectors.</p>
              </div>
            </td>
            <td>
                  <code>-1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_jobs</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int (default=-1)
Number of parallel jobs to use for fitting the model. If -1, all
available CPU cores are used. If 1, no parallelization is used.</p>
              </div>
            </td>
            <td>
                  <code>-1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path | None
Directory to save the fitted model. If None, the model is not saved.
A subdirectory named "spectral_normative_model" will be created
within the specified save_directory.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_separate</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool (default=False)
Whether to save the fitted direct model parameters separately for each
eigenmode as individual files. This is only applicable if
<code>save_directory</code> is provided.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariance_structure</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]] | <span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray | float
Sparse covariance structure to use for the model fitting. If a
(2, n_pairs) array of row and column indices are provided, the model
will use this structure. If float, the model will estimate the
covariance structure based on the training data and the float value
will be used as the threshold to exclude small correlations to form a
sparse covariance structure.</p>
              </div>
            </td>
            <td>
                  <code>0.25</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_separate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">covariance_structure</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit the spectral normative model to the provided encoded training data.</span>

<span class="sd">    Args:</span>
<span class="sd">        encoded_train_data: np.ndarray</span>
<span class="sd">            Encoded training data as a numpy array (n_samples, n_modes).</span>
<span class="sd">        covariates_dataframe: pd.DataFrame</span>
<span class="sd">            DataFrame containing the covariates for the samples.</span>
<span class="sd">            It must include all specified covariates in the model specification.</span>
<span class="sd">        n_modes: int (default=-1)</span>
<span class="sd">            Number of eigenmodes to fit the model to. If -1, all modes are</span>
<span class="sd">            used. If a positive integer, only the first n_modes are used.</span>
<span class="sd">            Note that the encoded_train_data and the eigenmode basis should have</span>
<span class="sd">            at least n_modes columns/eigenvectors.</span>
<span class="sd">        n_jobs: int (default=-1)</span>
<span class="sd">            Number of parallel jobs to use for fitting the model. If -1, all</span>
<span class="sd">            available CPU cores are used. If 1, no parallelization is used.</span>
<span class="sd">        save_directory: Path | None</span>
<span class="sd">            Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">            A subdirectory named &quot;spectral_normative_model&quot; will be created</span>
<span class="sd">            within the specified save_directory.</span>
<span class="sd">        save_separate: bool (default=False)</span>
<span class="sd">            Whether to save the fitted direct model parameters separately for each</span>
<span class="sd">            eigenmode as individual files. This is only applicable if</span>
<span class="sd">            `save_directory` is provided.</span>
<span class="sd">        covariance_structure: np.ndarray | float</span>
<span class="sd">            Sparse covariance structure to use for the model fitting. If a</span>
<span class="sd">            (2, n_pairs) array of row and column indices are provided, the model</span>
<span class="sd">            will use this structure. If float, the model will estimate the</span>
<span class="sd">            covariance structure based on the training data and the float value</span>
<span class="sd">            will be used as the threshold to exclude small correlations to form a</span>
<span class="sd">            sparse covariance structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting SNM model fitting:&quot;</span><span class="p">)</span>
    <span class="c1"># Evaluate the number of modes to fit</span>
    <span class="k">if</span> <span class="n">n_modes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="o">.</span><span class="n">n_modes</span>
    <span class="c1"># Validate the input data</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">encoded_train_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;encoded_train_data must be a numpy array.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">encoded_train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n_modes</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;encoded_train_data must have at least </span><span class="si">{</span><span class="n">n_modes</span><span class="si">}</span><span class="s2"> columns (n_modes).&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">&lt;</span> <span class="n">n_modes</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Eigenmode basis has only </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="o">.</span><span class="n">n_modes</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; modes, while </span><span class="si">{</span><span class="n">n_modes</span><span class="si">}</span><span class="s2"> were requested.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="c1"># Setup the save directory if needed</span>
    <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Prepare the save directory</span>
        <span class="n">save_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">prepare_save_directory</span><span class="p">(</span>
            <span class="n">save_directory</span><span class="p">,</span>
            <span class="s2">&quot;spectral_normative_model&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 1; direct models for each eigenmode (</span><span class="si">%s</span><span class="s2"> modes)&quot;</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fit_all_direct</span><span class="p">(</span>
        <span class="n">encoded_train_data</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">,</span>
        <span class="n">covariates_dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
        <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="o">=</span><span class="n">save_directory</span><span class="p">,</span>
        <span class="n">save_separate</span><span class="o">=</span><span class="n">save_separate</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 2; identify sparse covariance structure&quot;</span><span class="p">)</span>

    <span class="c1"># Identify sparse covariance structure if a float value is given</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">covariance_structure</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="c1"># Use trained models to compute z-scores</span>
        <span class="n">encoded_train_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                    <span class="n">test_covariates</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
                    <span class="n">model_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">extend_predictions</span><span class="p">(</span>
                    <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">[:,</span> <span class="n">x</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;z-score&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_modes</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identify_sparse_covariance_structure</span><span class="p">(</span>
                <span class="n">encoded_train_z_scores</span><span class="p">,</span>
                <span class="n">covariates_dataframe</span><span class="p">,</span>
                <span class="n">covariance_structure</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">covariance_structure</span><span class="p">)</span>

    <span class="c1"># Verify that the covariance structure is valid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid_covariance_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Invalid sparse covariance structure.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="c1"># Model cross basis sparse covariance structure</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Step 3; cross-eigenmode dependency modeling (</span><span class="si">%s</span><span class="s2"> pairs)&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fit_all_covariance</span><span class="p">(</span>
        <span class="n">encoded_train_data</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">,</span>
        <span class="n">covariates_dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="o">=</span><span class="n">save_directory</span><span class="p">,</span>
        <span class="n">save_separate</span><span class="o">=</span><span class="n">save_separate</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save SNM model parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n_modes&quot;</span><span class="p">:</span> <span class="n">n_modes</span><span class="p">,</span>
        <span class="s2">&quot;sample_size&quot;</span><span class="p">:</span> <span class="n">encoded_train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;direct_model_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">,</span>
        <span class="s2">&quot;sparse_covariance_structure&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">,</span>
        <span class="s2">&quot;covariance_model_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance_model_params</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="s2">&quot;n_params&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Direct model parameters are not valid.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="c1"># Save the model if a save path is provided</span>
    <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.fit_all_covariance" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_all_covariance</span><span class="p">(</span><span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_separate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Fit the direct models for all specified eigenmodes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>encoded_train_data</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Encoded training data as a numpy array (n_samples, n_modes).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates_dataframe</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the covariates for the samples.
It must include all specified covariates in the model specification.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_jobs</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int (default=-1)
Number of parallel jobs to use for fitting the model. If -1, all
available CPU cores are used. If 1, no parallelization is used.</p>
              </div>
            </td>
            <td>
                  <code>-1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path | None
Directory to save the fitted model. If None, the model is not saved.
A subdirectory named "spectral_normative_model" will be created
within the specified save_directory.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_separate</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool (default=False)
Whether to save the fitted direct model parameters separately for each
eigenmode as individual files. This is only applicable if
<code>save_directory</code> is provided.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_all_covariance</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_separate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit the direct models for all specified eigenmodes.</span>

<span class="sd">    Args:</span>
<span class="sd">        encoded_train_data: np.ndarray</span>
<span class="sd">            Encoded training data as a numpy array (n_samples, n_modes).</span>
<span class="sd">        covariates_dataframe: pd.DataFrame</span>
<span class="sd">            DataFrame containing the covariates for the samples.</span>
<span class="sd">            It must include all specified covariates in the model specification.</span>
<span class="sd">        n_jobs: int (default=-1)</span>
<span class="sd">            Number of parallel jobs to use for fitting the model. If -1, all</span>
<span class="sd">            available CPU cores are used. If 1, no parallelization is used.</span>
<span class="sd">        save_directory: Path | None</span>
<span class="sd">            Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">            A subdirectory named &quot;spectral_normative_model&quot; will be created</span>
<span class="sd">            within the specified save_directory.</span>
<span class="sd">        save_separate: bool (default=False)</span>
<span class="sd">            Whether to save the fitted direct model parameters separately for each</span>
<span class="sd">            eigenmode as individual files. This is only applicable if</span>
<span class="sd">            `save_directory` is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Setup the save directory if needed</span>
    <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>

    <span class="c1"># Fit the base covariance models for selected eigenmode pairs in parallel</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_single_covariance</span><span class="p">)(</span>
            <span class="n">variable_of_interest_1</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">[</span>
                <span class="p">:,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="n">variable_of_interest_2</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">[</span>
                <span class="p">:,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="n">direct_model_params_1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="p">],</span>
            <span class="n">direct_model_params_2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">],</span>
            <span class="n">covariates_dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
            <span class="n">save_directory</span><span class="o">=</span><span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">ensure_dir</span><span class="p">(</span>
                    <span class="n">save_directory</span>
                    <span class="o">/</span> <span class="s2">&quot;spectral_normative_model&quot;</span>
                    <span class="o">/</span> <span class="s2">&quot;covariance_models&quot;</span>
                    <span class="o">/</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;mode_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">,&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;mode_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">save_separate</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">covariance_model_params</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">ParallelTqdm</span><span class="p">(</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
        <span class="n">total_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_covariance_structure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fitting covariance models&quot;</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">tasks</span><span class="p">)</span>  <span class="c1"># pyright: ignore[reportCallIssue]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.fit_all_direct" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_all_direct</span><span class="p">(</span><span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_separate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Fit the direct models for all specified eigenmodes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>encoded_train_data</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Encoded training data as a numpy array (n_samples, n_modes).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates_dataframe</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the covariates for the samples.
It must include all specified covariates in the model specification.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_modes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int (default=-1)
Number of eigenmodes to fit the model to. If -1, all modes are
used. If a positive integer, only the first n_modes are used.
Note that the encoded_train_data and the eigenmode basis should have
at least n_modes columns/eigenvectors.</p>
              </div>
            </td>
            <td>
                  <code>-1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_jobs</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int (default=-1)
Number of parallel jobs to use for fitting the model. If -1, all
available CPU cores are used. If 1, no parallelization is used.</p>
              </div>
            </td>
            <td>
                  <code>-1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path | None
Directory to save the fitted model. If None, the model is not saved.
A subdirectory named "spectral_normative_model" will be created
within the specified save_directory.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_separate</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool (default=False)
Whether to save the fitted direct model parameters separately for each
eigenmode as individual files. This is only applicable if
<code>save_directory</code> is provided.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_all_direct</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">encoded_train_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_separate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit the direct models for all specified eigenmodes.</span>

<span class="sd">    Args:</span>
<span class="sd">        encoded_train_data: np.ndarray</span>
<span class="sd">            Encoded training data as a numpy array (n_samples, n_modes).</span>
<span class="sd">        covariates_dataframe: pd.DataFrame</span>
<span class="sd">            DataFrame containing the covariates for the samples.</span>
<span class="sd">            It must include all specified covariates in the model specification.</span>
<span class="sd">        n_modes: int (default=-1)</span>
<span class="sd">            Number of eigenmodes to fit the model to. If -1, all modes are</span>
<span class="sd">            used. If a positive integer, only the first n_modes are used.</span>
<span class="sd">            Note that the encoded_train_data and the eigenmode basis should have</span>
<span class="sd">            at least n_modes columns/eigenvectors.</span>
<span class="sd">        n_jobs: int (default=-1)</span>
<span class="sd">            Number of parallel jobs to use for fitting the model. If -1, all</span>
<span class="sd">            available CPU cores are used. If 1, no parallelization is used.</span>
<span class="sd">        save_directory: Path | None</span>
<span class="sd">            Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">            A subdirectory named &quot;spectral_normative_model&quot; will be created</span>
<span class="sd">            within the specified save_directory.</span>
<span class="sd">        save_separate: bool (default=False)</span>
<span class="sd">            Whether to save the fitted direct model parameters separately for each</span>
<span class="sd">            eigenmode as individual files. This is only applicable if</span>
<span class="sd">            `save_directory` is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Setup the save directory if needed</span>
    <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>

    <span class="c1"># Fit the base direct model for each eigenmode using parallel processing</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_single_direct</span><span class="p">)(</span>
            <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">encoded_train_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span>
            <span class="n">covariates_dataframe</span><span class="o">=</span><span class="n">covariates_dataframe</span><span class="p">,</span>
            <span class="n">save_directory</span><span class="o">=</span><span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">ensure_dir</span><span class="p">(</span>
                    <span class="n">save_directory</span>
                    <span class="o">/</span> <span class="s2">&quot;spectral_normative_model&quot;</span>
                    <span class="o">/</span> <span class="s2">&quot;direct_models&quot;</span>
                    <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;mode_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">save_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">save_separate</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_modes</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">direct_model_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">ParallelTqdm</span><span class="p">(</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
            <span class="n">total_tasks</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fitting direct models&quot;</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">tasks</span><span class="p">),</span>  <span class="c1"># pyright: ignore[reportCallIssue]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.fit_single_covariance" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_single_covariance</span><span class="p">(</span><span class="n">variable_of_interest_1</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">variable_of_interest_2</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">direct_model_params_1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">direct_model_params_2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_model_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">defaults_overwrite</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Fit a covariance normative model between a single pair of eigenmodes.
This method fits a covariance model to the provided pair of variables
and covariates dataframe, considering the direct model fits for each
eigenmode, while allowing for the cross-eigenmode covariance to vary
normatively.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>variable_of_interest_1</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
The loading vector capturing the variance within training data that
corresponds to a single eigenmode.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>variable_of_interest_2</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
The loading vector capturing the variance within training data that
corresponds to a second eigenmode.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>direct_model_params_1</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict
The parameters of the direct model fitted to the first eigenmode.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>direct_model_params_2</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict
The parameters of the direct model fitted to the second eigenmode.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates_dataframe</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the covariates for the samples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path | None
Directory to save the fitted model. If None, the model is not saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_model_params</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool
If True, return the fitted model parameters.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>defaults_overwrite</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict (default={})
Dictionary of default values to overwrite in the model fitting process.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>return_model_params</code> is True, return the fitted model parameters
in a dictionary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_single_covariance</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">variable_of_interest_1</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">variable_of_interest_2</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">direct_model_params_1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">direct_model_params_2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_model_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">defaults_overwrite</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a covariance normative model between a single pair of eigenmodes.</span>
<span class="sd">    This method fits a covariance model to the provided pair of variables</span>
<span class="sd">    and covariates dataframe, considering the direct model fits for each</span>
<span class="sd">    eigenmode, while allowing for the cross-eigenmode covariance to vary</span>
<span class="sd">    normatively.</span>

<span class="sd">    Args:</span>
<span class="sd">        variable_of_interest_1: np.ndarray</span>
<span class="sd">            The loading vector capturing the variance within training data that</span>
<span class="sd">            corresponds to a single eigenmode.</span>
<span class="sd">        variable_of_interest_2: np.ndarray</span>
<span class="sd">            The loading vector capturing the variance within training data that</span>
<span class="sd">            corresponds to a second eigenmode.</span>
<span class="sd">        direct_model_params_1: dict</span>
<span class="sd">            The parameters of the direct model fitted to the first eigenmode.</span>
<span class="sd">        direct_model_params_2: dict</span>
<span class="sd">            The parameters of the direct model fitted to the second eigenmode.</span>
<span class="sd">        covariates_dataframe: pd.DataFrame</span>
<span class="sd">            DataFrame containing the covariates for the samples.</span>
<span class="sd">        save_directory: Path | None</span>
<span class="sd">            Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">        return_model_params: bool</span>
<span class="sd">            If True, return the fitted model parameters.</span>
<span class="sd">        defaults_overwrite: dict (default={})</span>
<span class="sd">            Dictionary of default values to overwrite in the model fitting process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict:</span>
<span class="sd">            If `return_model_params` is True, return the fitted model parameters</span>
<span class="sd">            in a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare the data for fitting</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">covariates_dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Add the respective mode loadings as the variables of interest</span>
    <span class="n">train_data</span><span class="p">[</span><span class="s2">&quot;VOI_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest_1</span>
    <span class="n">train_data</span><span class="p">[</span><span class="s2">&quot;VOI_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest_2</span>
    <span class="n">train_data</span><span class="p">[[</span><span class="s2">&quot;VOI_1_mu_estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;VOI_1_std_estimate&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">model_params</span><span class="o">=</span><span class="n">direct_model_params_1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
        <span class="o">.</span><span class="n">T</span>
    <span class="p">)</span>  <span class="c1"># Add the direct model predictions</span>
    <span class="n">train_data</span><span class="p">[[</span><span class="s2">&quot;VOI_2_mu_estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;VOI_2_std_estimate&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">model_params</span><span class="o">=</span><span class="n">direct_model_params_2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
        <span class="o">.</span><span class="n">T</span>
    <span class="p">)</span>  <span class="c1"># Add the direct model predictions</span>

    <span class="c1"># Instantiate a covariance normative model from the base model</span>
    <span class="n">covariance_model</span> <span class="o">=</span> <span class="n">CovarianceNormativeModel</span><span class="o">.</span><span class="n">from_direct_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span>
        <span class="n">variable_of_interest_1</span><span class="o">=</span><span class="s2">&quot;VOI_1&quot;</span><span class="p">,</span>
        <span class="n">variable_of_interest_2</span><span class="o">=</span><span class="s2">&quot;VOI_2&quot;</span><span class="p">,</span>
        <span class="n">defaults_overwrite</span><span class="o">=</span><span class="p">(</span><span class="n">defaults_overwrite</span> <span class="ow">or</span> <span class="p">{}),</span>
    <span class="p">)</span>

    <span class="c1"># Fit the model silently</span>
    <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">suppress_output</span><span class="p">():</span>
        <span class="n">covariance_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
            <span class="n">save_directory</span><span class="o">=</span><span class="n">save_directory</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Return the fitted model parameters if requested</span>
    <span class="k">if</span> <span class="n">return_model_params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">covariance_model</span><span class="o">.</span><span class="n">model_params</span>

    <span class="c1"># If not returning model parameters, return None</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.fit_single_direct" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_single_direct</span><span class="p">(</span><span class="n">variable_of_interest</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_model_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Fit a direct normative model for a single spectral eigenmode.
This method fits the base direct model to the provided variable of interest
and covariates dataframe, allowing for the model to be trained on a specific
eigenmode of the spectral embedding.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>variable_of_interest</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
The loading vector capturing the variance within training data that
corresponds to a single eigenmode.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates_dataframe</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the covariates for the samples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path | None
Directory to save the fitted model. If None, the model is not saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_model_params</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool
If True, return the fitted model parameters.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>return_model_params</code> is True, return the fitted model parameters
in a dictionary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_single_direct</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">variable_of_interest</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">save_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_model_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a direct normative model for a single spectral eigenmode.</span>
<span class="sd">    This method fits the base direct model to the provided variable of interest</span>
<span class="sd">    and covariates dataframe, allowing for the model to be trained on a specific</span>
<span class="sd">    eigenmode of the spectral embedding.</span>

<span class="sd">    Args:</span>
<span class="sd">        variable_of_interest: np.ndarray</span>
<span class="sd">            The loading vector capturing the variance within training data that</span>
<span class="sd">            corresponds to a single eigenmode.</span>
<span class="sd">        covariates_dataframe: pd.DataFrame</span>
<span class="sd">            DataFrame containing the covariates for the samples.</span>
<span class="sd">        save_directory: Path | None</span>
<span class="sd">            Directory to save the fitted model. If None, the model is not saved.</span>
<span class="sd">        return_model_params: bool</span>
<span class="sd">            If True, return the fitted model parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict:</span>
<span class="sd">            If `return_model_params` is True, return the fitted model parameters</span>
<span class="sd">            in a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare the data for fitting</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">covariates_dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Add the mode loading as the variable of interest</span>
    <span class="n">train_data</span><span class="p">[</span><span class="s2">&quot;VOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_of_interest</span>

    <span class="c1"># Instantiate a direct normative model from the base model</span>
    <span class="n">direct_model</span> <span class="o">=</span> <span class="n">DirectNormativeModel</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">=</span><span class="n">NormativeModelSpec</span><span class="p">(</span>
            <span class="n">variable_of_interest</span><span class="o">=</span><span class="s2">&quot;VOI&quot;</span><span class="p">,</span>  <span class="c1"># Use the added VOI column</span>
            <span class="n">covariates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
            <span class="n">influencing_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_mean</span><span class="p">,</span>
            <span class="n">influencing_variance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">influencing_variance</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">batch_covariates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
        <span class="n">defaults</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Fit the model silently</span>
    <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">suppress_output</span><span class="p">():</span>
        <span class="n">direct_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
            <span class="n">save_directory</span><span class="o">=</span><span class="n">save_directory</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Return the fitted model parameters if requested</span>
    <span class="k">if</span> <span class="n">return_model_params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">direct_model</span><span class="o">.</span><span class="n">model_params</span>

    <span class="c1"># If not returning model parameters, return None</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.identify_sparse_covariance_structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">identify_sparse_covariance_structure</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">correlation_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Identify the sparse cross-basis covariance structure in the phenotype.
This method analyzes the encoded phenotype to determine the covariance
pairs that need to be modeled.</p>
<p>Note: if the batches become too small, this estimate can become less stable
in which case it is recommended to provide the sparse covariance structure
to the model instead.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
The encoded training data representing the phenotype in the graph
frequency domain.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates_dataframe</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
The DataFrame containing covariates for the samples. The batch
covariates will be used to group the samples and identify the
important covariance pairs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>correlation_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
The threshold to include covariance pairs if significantly correlated.
Should be between 0 and 1.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.integer">integer</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray:
A (N, 2) array: the rows and columns of the
identified sparse covariance structure.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">identify_sparse_covariance_structure</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">covariates_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">correlation_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify the sparse cross-basis covariance structure in the phenotype.</span>
<span class="sd">    This method analyzes the encoded phenotype to determine the covariance</span>
<span class="sd">    pairs that need to be modeled.</span>

<span class="sd">    Note: if the batches become too small, this estimate can become less stable</span>
<span class="sd">    in which case it is recommended to provide the sparse covariance structure</span>
<span class="sd">    to the model instead.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: np.ndarray</span>
<span class="sd">            The encoded training data representing the phenotype in the graph</span>
<span class="sd">            frequency domain.</span>
<span class="sd">        covariates_dataframe: pd.DataFrame</span>
<span class="sd">            The DataFrame containing covariates for the samples. The batch</span>
<span class="sd">            covariates will be used to group the samples and identify the</span>
<span class="sd">            important covariance pairs.</span>
<span class="sd">        correlation_threshold: float</span>
<span class="sd">            The threshold to include covariance pairs if significantly correlated.</span>
<span class="sd">            Should be between 0 and 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray:</span>
<span class="sd">            A (N, 2) array: the rows and columns of the</span>
<span class="sd">            identified sparse covariance structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Start with correlation structure across the whole sample</span>
    <span class="n">corr_max</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_correlation_significance_by_fisher_z</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">correlation_threshold</span><span class="o">=</span><span class="n">correlation_threshold</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Now iterate over all batch covariates</span>
    <span class="k">for</span> <span class="n">batch_effect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">:</span>
        <span class="c1"># For every batch re-evaluate correlations</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">covariates_dataframe</span><span class="p">[</span><span class="n">batch_effect</span><span class="p">]):</span>
            <span class="c1"># Make a mask for the current batch</span>
            <span class="n">batch_mask</span> <span class="o">=</span> <span class="n">covariates_dataframe</span><span class="p">[</span><span class="n">batch_effect</span><span class="p">]</span> <span class="o">==</span> <span class="n">batch</span>
            <span class="c1"># Update maximums</span>
            <span class="n">corr_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">corr_max</span><span class="p">,</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_correlation_significance_by_fisher_z</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">batch_mask</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                        <span class="n">n_samples</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">batch_mask</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">correlation_threshold</span><span class="o">=</span><span class="n">correlation_threshold</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>

    <span class="c1"># Now compute the sparsity structure based on the resulting matrix</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">corr_max</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Remove redundant and duplicate pairs</span>
    <span class="n">rows_lim</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">rows</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="p">]</span>
    <span class="n">cols_lim</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">rows</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rows_lim</span><span class="p">,</span> <span class="n">cols_lim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.load_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_model</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralNormativeModel</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Load a spectral normative model instance from the specified save directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path
Directory to load the fitted model from. A subdirectory named
"spectral_normative_model" will be searched within this directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3346</span>
<span class="normal">3347</span>
<span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span>
<span class="normal">3354</span>
<span class="normal">3355</span>
<span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span>
<span class="normal">3368</span>
<span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralNormativeModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a spectral normative model instance from the specified save directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory: Path</span>
<span class="sd">            Directory to load the fitted model from. A subdirectory named</span>
<span class="sd">            &quot;spectral_normative_model&quot; will be searched within this directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate the load directory</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">validate_load_directory</span><span class="p">(</span>
        <span class="n">directory</span><span class="p">,</span>
        <span class="s2">&quot;spectral_normative_model&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Check if the pickled joblib file exists in this directory</span>
    <span class="n">pickled_file</span> <span class="o">=</span> <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;spectral_model_dict.joblib&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pickled_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Model Load Error: Pickled file &#39;</span><span class="si">{</span><span class="n">pickled_file</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="n">model_dict</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickled_file</span><span class="p">)</span>

    <span class="c1"># Create an instance of the class</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">eigenmode_basis</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;eigenmode_basis&quot;</span><span class="p">],</span>
        <span class="n">base_model</span><span class="o">=</span><span class="n">DirectNormativeModel</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span>
            <span class="n">batch_covariates</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;batch_covariates&quot;</span><span class="p">],</span>
            <span class="n">defaults</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;defaults&quot;</span><span class="p">],</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;model_params&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">encoded_query</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">extended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">encoded_test_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Predict normative moments (mean, std) for new data using the fitted spectral
normative model.
Spectral normative modeling can estimate the normative distribution of any
variable of interest defined as a spatial query encoded in the latent low-pass
graph spectral space.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>encoded_query</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Encoded query data defining the normative variable of interest.
Can be provided as:
- shape = (n_modes) for a single query vector
- shape = (n_modes, n_queries) for multiple queries predicted at once</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_covariates</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
DataFrame containing the new covariate data to predict.
This must include all specified covariates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>extended</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool (default: False)
If True, return additional stats such as log-likelihood, centiles, etc.
Note that extended predictions require encoded_test_data to be
provided in addition to the covariates.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict | None
Optional dictionary of model parameters to use. If not provided,
the stored parameters from model.fit() will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>encoded_test_data</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray | None
Optional encoded test data for the phenotype being modeled (only
required for extended predictions).
Expects a numpy array (n_samples, n_modes)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_modes</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int | None
Optional number of modes to use for the prediction. If not provided,
the stored number of modes from model.fit() will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="NormativePredictions


  
      dataclass
   (spectranorm.snm.NormativePredictions)" href="#spectranorm.snm.NormativePredictions">NormativePredictions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: DataFrame containing the predicted moments (mean, std) for
the variable of interest defined by the encoded query.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">encoded_query</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">test_covariates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">extended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">model_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">encoded_test_data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NormativePredictions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predict normative moments (mean, std) for new data using the fitted spectral</span>
<span class="sd">    normative model.</span>
<span class="sd">    Spectral normative modeling can estimate the normative distribution of any</span>
<span class="sd">    variable of interest defined as a spatial query encoded in the latent low-pass</span>
<span class="sd">    graph spectral space.</span>

<span class="sd">    Args:</span>
<span class="sd">        encoded_query: np.ndarray</span>
<span class="sd">            Encoded query data defining the normative variable of interest.</span>
<span class="sd">            Can be provided as:</span>
<span class="sd">            - shape = (n_modes) for a single query vector</span>
<span class="sd">            - shape = (n_modes, n_queries) for multiple queries predicted at once</span>
<span class="sd">        test_covariates: pd.DataFrame</span>
<span class="sd">            DataFrame containing the new covariate data to predict.</span>
<span class="sd">            This must include all specified covariates.</span>
<span class="sd">        extended: bool (default: False)</span>
<span class="sd">            If True, return additional stats such as log-likelihood, centiles, etc.</span>
<span class="sd">            Note that extended predictions require encoded_test_data to be</span>
<span class="sd">            provided in addition to the covariates.</span>
<span class="sd">        model_params: dict | None</span>
<span class="sd">            Optional dictionary of model parameters to use. If not provided,</span>
<span class="sd">            the stored parameters from model.fit() will be used.</span>
<span class="sd">        encoded_test_data: np.ndarray | None</span>
<span class="sd">            Optional encoded test data for the phenotype being modeled (only</span>
<span class="sd">            required for extended predictions).</span>
<span class="sd">            Expects a numpy array (n_samples, n_modes)</span>
<span class="sd">        n_modes: int | None</span>
<span class="sd">            Optional number of modes to use for the prediction. If not provided,</span>
<span class="sd">            the stored number of modes from model.fit() will be used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame containing the predicted moments (mean, std) for</span>
<span class="sd">            the variable of interest defined by the encoded query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find n_modes</span>
    <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;n_modes&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;The base model is not specified. Cannot predict new data.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="c1"># Validate the new data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fit_input</span><span class="p">(</span><span class="n">encoded_train_data</span><span class="o">=</span><span class="n">encoded_query</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">)</span>

    <span class="c1"># Parameters</span>
    <span class="k">if</span> <span class="n">model_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>

    <span class="c1"># direct normative predictions for each eigenmode</span>
    <span class="n">eigenmode_mu_estimates</span><span class="p">,</span> <span class="n">eigenmode_std_estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">test_covariates</span><span class="p">,</span>
                <span class="n">model_params</span><span class="o">=</span><span class="n">direct_model_params</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">([</span><span class="s2">&quot;mu_estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;std_estimate&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">direct_model_params</span> <span class="ow">in</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;direct_model_params&quot;</span><span class="p">]</span>
        <span class="p">],</span>
    <span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># estimates have a shape of (n_samples, n_modes)</span>

    <span class="c1"># create a dummy covariance model</span>
    <span class="n">covariance_model</span> <span class="o">=</span> <span class="n">CovarianceNormativeModel</span><span class="o">.</span><span class="n">from_direct_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span>
        <span class="n">variable_of_interest_1</span><span class="o">=</span><span class="s2">&quot;dummy_VOI_1&quot;</span><span class="p">,</span>  <span class="c1"># Dummy variable of interest</span>
        <span class="n">variable_of_interest_2</span><span class="o">=</span><span class="s2">&quot;dummy_VOI_2&quot;</span><span class="p">,</span>  <span class="c1"># Dummy variable of interest</span>
    <span class="p">)</span>

    <span class="c1"># cross-mode dependence structure</span>
    <span class="n">rho_estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">covariance_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">test_covariates</span><span class="p">,</span>
                <span class="n">model_params</span><span class="o">=</span><span class="n">covariance_model_params</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">([</span><span class="s2">&quot;correlation_estimate&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">covariance_model_params</span> <span class="ow">in</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;covariance_model_params&quot;</span><span class="p">]</span>
        <span class="p">],</span>
    <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># estimates have a shape of (n_samples, n_covariance_pairs)</span>

    <span class="c1"># reformat encoded queries</span>
    <span class="n">encoded_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">encoded_query</span><span class="p">[:</span><span class="n">n_modes</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_modes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Compute the predictions</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_from_spectral_estimates</span><span class="p">(</span>
        <span class="n">encoded_query</span><span class="o">=</span><span class="n">encoded_query</span><span class="p">,</span>
        <span class="n">eigenmode_mu_estimates</span><span class="o">=</span><span class="n">eigenmode_mu_estimates</span><span class="p">,</span>
        <span class="n">eigenmode_std_estimates</span><span class="o">=</span><span class="n">eigenmode_std_estimates</span><span class="p">,</span>
        <span class="n">rho_estimates</span><span class="o">=</span><span class="n">rho_estimates</span><span class="p">,</span>
        <span class="n">test_covariates</span><span class="o">=</span><span class="n">test_covariates</span><span class="p">,</span>
        <span class="n">model_params</span><span class="o">=</span><span class="n">model_params</span><span class="p">,</span>
        <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Check if extended predictions are requested</span>
    <span class="k">if</span> <span class="n">extended</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">encoded_test_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Extended predictions require encoded_test_data to be provided.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="c1"># Add extended statistics to predictions (e.g. centiles, log-loss, etc.)</span>
        <span class="n">predictions</span><span class="o">.</span><span class="n">extend_predictions</span><span class="p">(</span>
            <span class="n">variable_of_interest</span><span class="o">=</span><span class="n">encoded_test_data</span> <span class="o">@</span> <span class="n">encoded_query</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SpectralNormativeModel.save_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_model</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save the fitted spectral normative model to the specified directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path
Directory to save the fitted model. A subdirectory named
"spectral_normative_model" will be created within this directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the fitted spectral normative model to the specified directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory: Path</span>
<span class="sd">            Directory to save the fitted model. A subdirectory named</span>
<span class="sd">            &quot;spectral_normative_model&quot; will be created within this directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare the save directory</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">prepare_save_directory</span><span class="p">(</span>
        <span class="n">directory</span><span class="p">,</span>
        <span class="s2">&quot;spectral_normative_model&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save the model</span>
    <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
        <span class="s2">&quot;batch_covariates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">batch_covariates</span><span class="p">,</span>
        <span class="s2">&quot;defaults&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
        <span class="s2">&quot;eigenmode_basis&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenmode_basis</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model_params&quot;</span><span class="p">):</span>
        <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;model_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_dict</span><span class="p">,</span> <span class="n">saved_model_dir</span> <span class="o">/</span> <span class="s2">&quot;spectral_model_dict.joblib&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="spectranorm.snm.SplineSpec" class="doc doc-heading">
            <code>SplineSpec</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Specification for spline basis construction.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.SplineSpec.df">df</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
Degrees of freedom (number of basis functions).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.SplineSpec.degree">degree</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
Degree of the spline (e.g., 3 for cubic splines).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.SplineSpec.lower_bound">lower_bound</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
Lower boundary for the spline domain.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.SplineSpec.upper_bound">upper_bound</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float
Upper boundary for the spline domain.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.snm.SplineSpec.knots">knots</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="float">float</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[List[float]]
Optional list of internal knot locations within the spline domain
(excluding the boundary knots). Must be strictly increasing and
contain exactly <code>df - degree - 1</code> values. If unspecified, then
equally spaced quantiles of the input data are used.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SplineSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specification for spline basis construction.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        df: int</span>
<span class="sd">            Degrees of freedom (number of basis functions).</span>
<span class="sd">        degree: int</span>
<span class="sd">            Degree of the spline (e.g., 3 for cubic splines).</span>
<span class="sd">        lower_bound: float</span>
<span class="sd">            Lower boundary for the spline domain.</span>
<span class="sd">        upper_bound: float</span>
<span class="sd">            Upper boundary for the spline domain.</span>
<span class="sd">        knots: Optional[List[float]]</span>
<span class="sd">            Optional list of internal knot locations within the spline domain</span>
<span class="sd">            (excluding the boundary knots). Must be strictly increasing and</span>
<span class="sd">            contain exactly `df - degree - 1` values. If unspecified, then</span>
<span class="sd">            equally spaced quantiles of the input data are used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lower_bound</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">upper_bound</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">df</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_DF</span>
    <span class="n">degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_DEGREE</span>
    <span class="n">knots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Validation checks for the spline specification.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Check that df (degrees of freedom) is greater than degree</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;df (degrees of freedom) must be greater than degree.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="c1"># Check that degree is at least 1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;degree must be at least 1.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="c1"># Check that lower_bound and upper_bound are numeric</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;lower_bound must be less than upper_bound.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">knots</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;All knots must be numeric (int or float).&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="c1"># Check if knots are strictly increasing</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Knots must be strictly increasing.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="c1"># Check if knots are within bounds</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_bound</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_bound</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;All knots must be within the bounds defined by &quot;</span>
                    <span class="s2">&quot;lower_bound and upper_bound.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="c1"># Check if the number of knots is correct</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;knots must contain exactly </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;values, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_spline_spec</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">df</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_DF</span><span class="p">,</span>
        <span class="n">degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_DEGREE</span><span class="p">,</span>
        <span class="n">knots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extrapolation_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_EXTRAPOLATION_FACTOR</span><span class="p">,</span>
        <span class="n">lower_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">upper_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineSpec</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a spline specification from a pandas Series.</span>

<span class="sd">        Args:</span>
<span class="sd">            values: pd.Series</span>
<span class="sd">                The list of input values to make the spline.</span>
<span class="sd">            df: int</span>
<span class="sd">                Degrees of freedom for the spline (default is 5).</span>
<span class="sd">            degree: int</span>
<span class="sd">                Degree of the spline (default is 3).</span>
<span class="sd">            knots: list[float] | None</span>
<span class="sd">                [Optional] List of internal knot locations within the spline domain.</span>
<span class="sd">                If None, equally spaced quantiles of the input data are used.</span>
<span class="sd">            extrapolation_factor: float, positive, default is 0.1</span>
<span class="sd">                [Optional] Factor to extend the lower and upper bounds of the spline</span>
<span class="sd">                domain.</span>
<span class="sd">            lower_bound: float | None</span>
<span class="sd">                [Optional] Lower boundary for the spline domain. If None, it is set to</span>
<span class="sd">                `values.min() - extrapolation_factor * (values.max() - values.min())`.</span>
<span class="sd">            upper_bound: float | None</span>
<span class="sd">                [Optional] Upper boundary for the spline domain. If None, it is set to</span>
<span class="sd">                `values.max() + extrapolation_factor * (values.max() - values.min())`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SplineSpec</span>
<span class="sd">                The created spline specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extrapolation</span> <span class="o">=</span> <span class="n">extrapolation_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">extrapolation</span>
        <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">extrapolation</span>
        <span class="k">if</span> <span class="n">knots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use equally spaced quantiles as knots</span>
            <span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">df</span> <span class="o">-</span> <span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span>
                <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span>
            <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">lower_bound</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span>
            <span class="n">upper_bound</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span>
            <span class="n">knots</span><span class="o">=</span><span class="n">knots</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="spectranorm.snm.SplineSpec.create_spline_spec" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_spline_spec</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">df</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_DF</span><span class="p">,</span> <span class="n">degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_DEGREE</span><span class="p">,</span> <span class="n">knots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extrapolation_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_EXTRAPOLATION_FACTOR</span><span class="p">,</span> <span class="n">lower_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineSpec</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Create a spline specification from a pandas Series.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>values</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.Series
The list of input values to make the spline.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
Degrees of freedom for the spline (default is 5).</p>
              </div>
            </td>
            <td>
                  <code><span title="spectranorm.snm.DEFAULT_SPLINE_DF">DEFAULT_SPLINE_DF</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>degree</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
Degree of the spline (default is 3).</p>
              </div>
            </td>
            <td>
                  <code><span title="spectranorm.snm.DEFAULT_SPLINE_DEGREE">DEFAULT_SPLINE_DEGREE</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>knots</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="float">float</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[float] | None
[Optional] List of internal knot locations within the spline domain.
If None, equally spaced quantiles of the input data are used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>extrapolation_factor</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float, positive, default is 0.1
[Optional] Factor to extend the lower and upper bounds of the spline
domain.</p>
              </div>
            </td>
            <td>
                  <code><span title="spectranorm.snm.DEFAULT_SPLINE_EXTRAPOLATION_FACTOR">DEFAULT_SPLINE_EXTRAPOLATION_FACTOR</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lower_bound</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float | None
[Optional] Lower boundary for the spline domain. If None, it is set to
<code>values.min() - extrapolation_factor * (values.max() - values.min())</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>upper_bound</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float | None
[Optional] Upper boundary for the spline domain. If None, it is set to
<code>values.max() + extrapolation_factor * (values.max() - values.min())</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="SplineSpec


  
      dataclass
   (spectranorm.snm.SplineSpec)" href="#spectranorm.snm.SplineSpec">SplineSpec</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SplineSpec
The created spline specification.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/snm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_spline_spec</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">df</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_DF</span><span class="p">,</span>
    <span class="n">degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_DEGREE</span><span class="p">,</span>
    <span class="n">knots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extrapolation_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_SPLINE_EXTRAPOLATION_FACTOR</span><span class="p">,</span>
    <span class="n">lower_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">upper_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplineSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a spline specification from a pandas Series.</span>

<span class="sd">    Args:</span>
<span class="sd">        values: pd.Series</span>
<span class="sd">            The list of input values to make the spline.</span>
<span class="sd">        df: int</span>
<span class="sd">            Degrees of freedom for the spline (default is 5).</span>
<span class="sd">        degree: int</span>
<span class="sd">            Degree of the spline (default is 3).</span>
<span class="sd">        knots: list[float] | None</span>
<span class="sd">            [Optional] List of internal knot locations within the spline domain.</span>
<span class="sd">            If None, equally spaced quantiles of the input data are used.</span>
<span class="sd">        extrapolation_factor: float, positive, default is 0.1</span>
<span class="sd">            [Optional] Factor to extend the lower and upper bounds of the spline</span>
<span class="sd">            domain.</span>
<span class="sd">        lower_bound: float | None</span>
<span class="sd">            [Optional] Lower boundary for the spline domain. If None, it is set to</span>
<span class="sd">            `values.min() - extrapolation_factor * (values.max() - values.min())`.</span>
<span class="sd">        upper_bound: float | None</span>
<span class="sd">            [Optional] Upper boundary for the spline domain. If None, it is set to</span>
<span class="sd">            `values.max() + extrapolation_factor * (values.max() - values.min())`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SplineSpec</span>
<span class="sd">            The created spline specification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">extrapolation</span> <span class="o">=</span> <span class="n">extrapolation_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">extrapolation</span>
    <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">extrapolation</span>
    <span class="k">if</span> <span class="n">knots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use equally spaced quantiles as knots</span>
        <span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">df</span> <span class="o">-</span> <span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span>
            <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span>
        <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">lower_bound</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span>
        <span class="n">upper_bound</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span>
        <span class="n">knots</span><span class="o">=</span><span class="n">knots</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>



<div class="doc doc-object doc-module">



<h3 id="spectranorm.snm.utils" class="doc doc-heading">
            <code>utils</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">











  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="spectranorm.utils" class="doc doc-heading">
            <code>utils</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="spectranorm.utils.general" class="doc doc-heading">
            <code>general</code>


</h3>

    <div class="doc doc-contents ">

        <p>utils/general.py</p>
<p>General utility functions for spectranorm.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="spectranorm.utils.general.ReportTimeFormatter" class="doc doc-heading">
            <code>ReportTimeFormatter</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="logging.Formatter">Formatter</span></code></p>


        <p>Custom log formatter that injects general.report_time().</p>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/utils/general.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ReportTimeFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom log formatter that injects general.report_time().&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">LogRecord</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">record</span><span class="o">.</span><span class="n">report_time</span> <span class="o">=</span> <span class="n">report_time</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.general.ensure_dir" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ensure_dir</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Ensure that the directory for the given file name exists.</p>
<h6 id="spectranorm.utils.general.ensure_dir--parameters">Parameters</h6>
<p>file_name : Path
    The file name for which to ensure the directory exists.</p>
<h6 id="spectranorm.utils.general.ensure_dir--returns">Returns</h6>
<p>Path
    The original file name.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/general.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ensure_dir</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure that the directory for the given file name exists.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_name : Path</span>
<span class="sd">        The file name for which to ensure the directory exists.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Path</span>
<span class="sd">        The original file name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_name</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.general.get_logger" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_logger</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get a logger with standardized formatting and time reporting.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger name (usually <strong>name</strong>).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>level</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logging level, default INFO.</p>
              </div>
            </td>
            <td>
                  <code><span title="logging.INFO">INFO</span></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="logging.Logger">Logger</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>logging.Logger with a custom ReportTimeFormatter.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/general.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_logger</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a logger with standardized formatting and time reporting.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Logger name (usually __name__).</span>
<span class="sd">        level: Logging level, default INFO.</span>

<span class="sd">    Returns:</span>
<span class="sd">        logging.Logger with a custom ReportTimeFormatter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">ReportTimeFormatter</span><span class="p">(</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(report_time)s</span><span class="s2"> : [</span><span class="si">%(levelname)s</span><span class="s2">] - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logger</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.general.prepare_save_directory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_save_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">subdirectory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;saved_model&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Prepare a directory to save a model.</p>
<p>A subdirectory named 'saved_model' will be created if it does not exist.
If this directory exists, but is not empty, an error is raised.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to a directory to save the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>subdirectory</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the subdirectory to create (default: "saved_model").</p>
              </div>
            </td>
            <td>
                  <code>&#39;saved_model&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>
        <h6 id="spectranorm.utils.general.prepare_save_directory--returns">Returns</h6>
<p>Path
    The path to the created subdirectory.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/general.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_save_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">subdirectory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;saved_model&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare a directory to save a model.</span>

<span class="sd">    A subdirectory named &#39;saved_model&#39; will be created if it does not exist.</span>
<span class="sd">    If this directory exists, but is not empty, an error is raised.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory (Path): Path to a directory to save the model.</span>
<span class="sd">        subdirectory (str): Name of the subdirectory to create (default: &quot;saved_model&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Path</span>
<span class="sd">        The path to the created subdirectory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the directory exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Model Save Error: Directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="c1"># Check if the subdirectory exists and is empty</span>
    <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">/</span> <span class="n">subdirectory</span>
    <span class="k">if</span> <span class="n">saved_model_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">saved_model_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Model Save Error: Directory &#39;</span><span class="si">{</span><span class="n">saved_model_dir</span><span class="si">}</span><span class="s2">&#39; is not empty.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">saved_model_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">saved_model_dir</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.general.report_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">report_time</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">relative_to</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Report the current time or the time elapsed since a given reference point.</p>
<h6 id="spectranorm.utils.general.report_time--parameters">Parameters</h6>
<p>relative_to : float | None
    The reference time in seconds since the epoch. If None, report the current time.
absolute : bool
    If True, report the absolute time format (float). If False, report the time in a
    human-readable format (str).</p>
<h6 id="spectranorm.utils.general.report_time--returns">Returns</h6>
<p>str | float
    The current time or the elapsed time since the reference point.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/general.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">report_time</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">relative_to</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Report the current time or the time elapsed since a given reference point.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    relative_to : float | None</span>
<span class="sd">        The reference time in seconds since the epoch. If None, report the current time.</span>
<span class="sd">    absolute : bool</span>
<span class="sd">        If True, report the absolute time format (float). If False, report the time in a</span>
<span class="sd">        human-readable format (str).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str | float</span>
<span class="sd">        The current time or the elapsed time since the reference point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">relative_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">relative_to</span>
        <span class="k">return</span> <span class="n">elapsed</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">elapsed</span><span class="p">))</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">now</span>
        <span class="k">if</span> <span class="n">absolute</span>
        <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
            <span class="n">now</span><span class="p">,</span>
            <span class="n">tz</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.general.suppress_output" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">suppress_output</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Context manager to suppress stdout and stderr output.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/general.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">suppress_output</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager to suppress stdout and stderr output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fnull</span><span class="p">:</span>
        <span class="n">old_stdout</span><span class="p">,</span> <span class="n">old_stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fnull</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Redirect stdout</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fnull</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Redirect stderr</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">old_stdout</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Restore</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">old_stderr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Restore</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">old_stdout</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">old_stderr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.general.validate_dataframe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_dataframe</span><span class="p">(</span><span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Validate the input DataFrame to ensure all required columns are available.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dataframe</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame
The DataFrame to validate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the DataFrame is not valid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/general.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_dataframe</span><span class="p">(</span><span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the input DataFrame to ensure all required columns are available.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataframe: pd.DataFrame</span>
<span class="sd">            The DataFrame to validate.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the DataFrame is not valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Input data must be a pandas DataFrame.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="c1"># report if a column is missing</span>
    <span class="n">missing_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Missing columns in DataFrame: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.general.validate_load_directory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_load_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">subdirectory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;saved_model&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Validate the directory structure for loading a model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>directory</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the main directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>subdirectory</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the subdirectory to check (default: "saved_model").</p>
              </div>
            </td>
            <td>
                  <code>&#39;saved_model&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>
        <h6 id="spectranorm.utils.general.validate_load_directory--returns">Returns</h6>
<p>Path
    The path to the validated subdirectory.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/general.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_load_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">subdirectory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;saved_model&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the directory structure for loading a model.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory (Path): Path to the main directory.</span>
<span class="sd">        subdirectory (str): Name of the subdirectory to check (default: &quot;saved_model&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Path</span>
<span class="sd">        The path to the validated subdirectory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the directory exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Model Load Error: Directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="c1"># Check if the subdirectory exists</span>
    <span class="n">saved_model_dir</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">/</span> <span class="n">subdirectory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">saved_model_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Model Load Error: Directory &#39;</span><span class="si">{</span><span class="n">saved_model_dir</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">saved_model_dir</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="spectranorm.utils.gsp" class="doc doc-heading">
            <code>gsp</code>


</h3>

    <div class="doc doc-contents ">

        <p>utils/gsp.py</p>
<p>Graph Signal Processing (GSP) functions for the Spectranorm package.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="spectranorm.utils.gsp.EigenmodeBasis" class="doc doc-heading">
            <code>EigenmodeBasis</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>Data class to hold eigenmode basis information.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.utils.gsp.EigenmodeBasis.eigenvalues">eigenvalues</span></code></td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Eigenvalues of the Basis (n_modes,).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="spectranorm.utils.gsp.EigenmodeBasis.eigenvectors">eigenvectors</span></code></td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Eigenvectors corresponding to the eigenvalues (n_modes, n_features).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EigenmodeBasis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Data class to hold eigenmode basis information.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        eigenvalues: np.ndarray</span>
<span class="sd">            Eigenvalues of the Basis (n_modes,).</span>
<span class="sd">        eigenvectors: np.ndarray</span>
<span class="sd">            Eigenvectors corresponding to the eigenvalues (n_modes, n_features).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">eigenvalues</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
    <span class="n">eigenvectors</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

    <span class="c1"># Additional attributes</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Eigenvectors must have </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="si">}</span><span class="s2"> modes, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EigenmodeBasis</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load an EigenmodeBasis instance from a joblib file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: str</span>
<span class="sd">                Path to the joblib file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            EigenmodeBasis instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="c1"># Expecting the saved file to contain a dict with these keys:</span>
        <span class="c1"># &#39;eigenvalues&#39;, &#39;eigenvectors&#39;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">eigenvalues</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eigenvalues&quot;</span><span class="p">],</span> <span class="n">eigenvectors</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eigenvectors&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the EigenmodeBasis instance to a joblib file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: str</span>
<span class="sd">                Path to save the joblib file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;eigenvalues&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">,</span>
            <span class="s2">&quot;eigenvectors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">signals</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encode a signal using the eigenmode basis.</span>

<span class="sd">        Args:</span>
<span class="sd">            signal: np.ndarray</span>
<span class="sd">                Signals to encode (n_signals, n_features).</span>
<span class="sd">            n_modes: int | None</span>
<span class="sd">                Number of modes to use for encoding. If None, use all available modes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray</span>
<span class="sd">                Encoded signal in the eigenmode basis (n_signals, n_modes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">signals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_features</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Signal must have </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_features</span><span class="si">}</span><span class="s2"> features, got </span><span class="si">{</span><span class="n">signals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span>

        <span class="k">return</span> <span class="n">signals</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[:</span><span class="n">n_modes</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_and_encode_data_list</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_loader</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and encode a list of data using the eigenmode basis.</span>

<span class="sd">        This function uses the data_loader to load data from the provided paths</span>
<span class="sd">        (for each sample), and then encodes the data using the eigenmode basis.</span>
<span class="sd">        Finally, it can save the encoded data to a specified output path, enabling</span>
<span class="sd">        efficient reuse of the encoded data in subsequent analyses.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_paths: list[str]</span>
<span class="sd">                List of data identifier strings to load data using the data_loader.</span>
<span class="sd">            output_path: str | None</span>
<span class="sd">                Path to save the encoded data (as a .npy file). If None, the encoded</span>
<span class="sd">                data is not saved.</span>
<span class="sd">            n_modes: int | None</span>
<span class="sd">                Number of modes to use for encoding. If None, all modes are used.</span>
<span class="sd">            data_loader: Callable[[str], np.ndarray] = np.load</span>

<span class="sd">        data_loader: Callable[[str], np.ndarray]</span>
<span class="sd">            A callable function to load data from a string identifier (e.g., file path).</span>
<span class="sd">            Note that by default, this is set to load numpy arrays from .npy files.</span>
<span class="sd">            However, you may want to override this with a custom data loader</span>
<span class="sd">            that fits your data format and loading requirements.</span>

<span class="sd">            For instance, `snm.utils.nitools.compute_fslr_thickness` is an example of a</span>
<span class="sd">            custom data loader which can be used to load fs-LR thickness values from a</span>
<span class="sd">            path to a subject&#39;s FreeSurfer directory.</span>

<span class="sd">            If you don&#39;t want to use a custom data loader, you can alternatively convert</span>
<span class="sd">            all individual data files to numpy arrays and use the default data loader,</span>
<span class="sd">            which loads numpy arrays from .npy files.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: (n_samples, n_modes)</span>
<span class="sd">                Encoded data of all individuals as a single numpy array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span>
        <span class="c1"># Load and encode data</span>
        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_paths</span><span class="p">),</span> <span class="n">n_modes</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_paths</span><span class="p">):</span>
            <span class="c1"># Load (using data_loader) and Encode</span>
            <span class="n">encoded_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">data_loader</span><span class="p">(</span><span class="n">data_path</span><span class="p">),</span>
                <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">encoded_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">encoded_data</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="spectranorm.utils.gsp.EigenmodeBasis.encode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">encode</span><span class="p">(</span><span class="n">signals</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Encode a signal using the eigenmode basis.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>signal</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Signals to encode (n_signals, n_features).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_modes</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int | None
Number of modes to use for encoding. If None, use all available modes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Encoded signal in the eigenmode basis (n_signals, n_modes).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">signals</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encode a signal using the eigenmode basis.</span>

<span class="sd">    Args:</span>
<span class="sd">        signal: np.ndarray</span>
<span class="sd">            Signals to encode (n_signals, n_features).</span>
<span class="sd">        n_modes: int | None</span>
<span class="sd">            Number of modes to use for encoding. If None, use all available modes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Encoded signal in the eigenmode basis (n_signals, n_modes).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">signals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_features</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Signal must have </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_features</span><span class="si">}</span><span class="s2"> features, got </span><span class="si">{</span><span class="n">signals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span>

    <span class="k">return</span> <span class="n">signals</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[:</span><span class="n">n_modes</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="spectranorm.utils.gsp.EigenmodeBasis.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EigenmodeBasis</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Load an EigenmodeBasis instance from a joblib file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filepath</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Path to the joblib file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="EigenmodeBasis


  
      dataclass
   (spectranorm.utils.gsp.EigenmodeBasis)" href="#spectranorm.utils.gsp.EigenmodeBasis">EigenmodeBasis</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>EigenmodeBasis instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EigenmodeBasis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load an EigenmodeBasis instance from a joblib file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath: str</span>
<span class="sd">            Path to the joblib file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        EigenmodeBasis instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="c1"># Expecting the saved file to contain a dict with these keys:</span>
    <span class="c1"># &#39;eigenvalues&#39;, &#39;eigenvectors&#39;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">eigenvalues</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eigenvalues&quot;</span><span class="p">],</span> <span class="n">eigenvectors</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eigenvectors&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="spectranorm.utils.gsp.EigenmodeBasis.load_and_encode_data_list" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_and_encode_data_list</span><span class="p">(</span><span class="n">data_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Load and encode a list of data using the eigenmode basis.</p>
<p>This function uses the data_loader to load data from the provided paths
(for each sample), and then encodes the data using the eigenmode basis.
Finally, it can save the encoded data to a specified output path, enabling
efficient reuse of the encoded data in subsequent analyses.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_paths</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]
List of data identifier strings to load data using the data_loader.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str | None
Path to save the encoded data (as a .npy file). If None, the encoded
data is not saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_modes</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int | None
Number of modes to use for encoding. If None, all modes are used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_loader</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="str">str</span>], <span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callable[[str], np.ndarray] = np.load</p>
              </div>
            </td>
            <td>
                  <code><span title="numpy.load">load</span></code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="data_loader" open>
  <summary>Callable[[str], np.ndarray]</summary>
  <p>A callable function to load data from a string identifier (e.g., file path).
Note that by default, this is set to load numpy arrays from .npy files.
However, you may want to override this with a custom data loader
that fits your data format and loading requirements.</p>
<p>For instance, <code>snm.utils.nitools.compute_fslr_thickness</code> is an example of a
custom data loader which can be used to load fs-LR thickness values from a
path to a subject's FreeSurfer directory.</p>
<p>If you don't want to use a custom data loader, you can alternatively convert
all individual data files to numpy arrays and use the default data loader,
which loads numpy arrays from .npy files.</p>
</details>

    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray: (n_samples, n_modes)
Encoded data of all individuals as a single numpy array.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_and_encode_data_list</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">data_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">data_loader</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and encode a list of data using the eigenmode basis.</span>

<span class="sd">    This function uses the data_loader to load data from the provided paths</span>
<span class="sd">    (for each sample), and then encodes the data using the eigenmode basis.</span>
<span class="sd">    Finally, it can save the encoded data to a specified output path, enabling</span>
<span class="sd">    efficient reuse of the encoded data in subsequent analyses.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_paths: list[str]</span>
<span class="sd">            List of data identifier strings to load data using the data_loader.</span>
<span class="sd">        output_path: str | None</span>
<span class="sd">            Path to save the encoded data (as a .npy file). If None, the encoded</span>
<span class="sd">            data is not saved.</span>
<span class="sd">        n_modes: int | None</span>
<span class="sd">            Number of modes to use for encoding. If None, all modes are used.</span>
<span class="sd">        data_loader: Callable[[str], np.ndarray] = np.load</span>

<span class="sd">    data_loader: Callable[[str], np.ndarray]</span>
<span class="sd">        A callable function to load data from a string identifier (e.g., file path).</span>
<span class="sd">        Note that by default, this is set to load numpy arrays from .npy files.</span>
<span class="sd">        However, you may want to override this with a custom data loader</span>
<span class="sd">        that fits your data format and loading requirements.</span>

<span class="sd">        For instance, `snm.utils.nitools.compute_fslr_thickness` is an example of a</span>
<span class="sd">        custom data loader which can be used to load fs-LR thickness values from a</span>
<span class="sd">        path to a subject&#39;s FreeSurfer directory.</span>

<span class="sd">        If you don&#39;t want to use a custom data loader, you can alternatively convert</span>
<span class="sd">        all individual data files to numpy arrays and use the default data loader,</span>
<span class="sd">        which loads numpy arrays from .npy files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: (n_samples, n_modes)</span>
<span class="sd">            Encoded data of all individuals as a single numpy array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span>
    <span class="c1"># Load and encode data</span>
    <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_paths</span><span class="p">),</span> <span class="n">n_modes</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_paths</span><span class="p">):</span>
        <span class="c1"># Load (using data_loader) and Encode</span>
        <span class="n">encoded_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">data_loader</span><span class="p">(</span><span class="n">data_path</span><span class="p">),</span>
            <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">encoded_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">encoded_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="spectranorm.utils.gsp.EigenmodeBasis.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Save the EigenmodeBasis instance to a joblib file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filepath</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str
Path to save the joblib file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the EigenmodeBasis instance to a joblib file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath: str</span>
<span class="sd">            Path to save the joblib file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;eigenvalues&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">,</span>
        <span class="s2">&quot;eigenvectors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.gsp.compute_random_walk_laplacian_eigenmodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_random_walk_laplacian_eigenmodes</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span> <span class="o">|</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">num_eigenvalues</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute the eigenvalues of the random walk Laplacian.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adjacency_matrix</code>
            </td>
            <td>
                  <code><span title="scipy.sparse.spmatrix">spmatrix</span> | <span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sparse.spmatrix
The adjacency matrix of the graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_eigenvalues</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
Number of eigenvalues to compute.</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]], <span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>eigenvalues, eigenvectors: (np.ndarray, np.ndarray)
Eigenvalues and eigenvectors of the random walk Laplacian.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_random_walk_laplacian_eigenmodes</span><span class="p">(</span>
    <span class="n">adjacency_matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span> <span class="o">|</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">num_eigenvalues</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the eigenvalues of the random walk Laplacian.</span>

<span class="sd">    Args:</span>
<span class="sd">        adjacency_matrix: sparse.spmatrix</span>
<span class="sd">            The adjacency matrix of the graph.</span>
<span class="sd">        num_eigenvalues: int</span>
<span class="sd">            Number of eigenvalues to compute.</span>

<span class="sd">    Returns:</span>
<span class="sd">        eigenvalues, eigenvectors: (np.ndarray, np.ndarray)</span>
<span class="sd">            Eigenvalues and eigenvectors of the random walk Laplacian.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to CSR format if in a different format</span>
    <span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">make_csr_matrix</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">)</span>

    <span class="c1"># Ensure the adjacency matrix is symmetric</span>
    <span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">adjacency_matrix</span> <span class="o">+</span> <span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Convert to transition matrix</span>
    <span class="n">transition_matrix</span> <span class="o">=</span> <span class="n">convert_adjacency_to_transition_matrix</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">)</span>

    <span class="c1"># Use shift invert mode to compute the eigenvalues for the transition matrix,</span>
    <span class="c1"># starting with the trivial eigenvalue 1</span>
    <span class="n">initial_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lambdas</span><span class="p">,</span> <span class="n">vectors</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigsh</span><span class="p">(</span>
        <span class="n">transition_matrix</span><span class="p">,</span>
        <span class="n">k</span><span class="o">=</span><span class="n">num_eigenvalues</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">which</span><span class="o">=</span><span class="s2">&quot;LM&quot;</span><span class="p">,</span>
        <span class="n">v0</span><span class="o">=</span><span class="n">initial_vector</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Convert to Laplacian eigenvalues</span>
    <span class="n">lambdas</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lambdas</span>
    <span class="n">lambda_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
    <span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">lambda_idx</span><span class="p">]</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="n">vectors</span><span class="p">[:,</span> <span class="n">lambda_idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.gsp.compute_symmetric_normalized_laplacian_eigenmodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_symmetric_normalized_laplacian_eigenmodes</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span> <span class="o">|</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">num_eigenvalues</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute the eigenvalues of the symmetric normalized Laplacian.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adjacency_matrix</code>
            </td>
            <td>
                  <code><span title="scipy.sparse.spmatrix">spmatrix</span> | <span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sparse.spmatrix
The adjacency matrix of the graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_eigenvalues</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
Number of eigenvalues to compute.</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]], <span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>eigenvalues, eigenvectors: (np.ndarray, np.ndarray)
Eigenvalues and eigenvectors of the symmetric normalized Laplacian.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_symmetric_normalized_laplacian_eigenmodes</span><span class="p">(</span>
    <span class="n">adjacency_matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span> <span class="o">|</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">num_eigenvalues</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the eigenvalues of the symmetric normalized Laplacian.</span>

<span class="sd">    Args:</span>
<span class="sd">        adjacency_matrix: sparse.spmatrix</span>
<span class="sd">            The adjacency matrix of the graph.</span>
<span class="sd">        num_eigenvalues: int</span>
<span class="sd">            Number of eigenvalues to compute.</span>

<span class="sd">    Returns:</span>
<span class="sd">        eigenvalues, eigenvectors: (np.ndarray, np.ndarray)</span>
<span class="sd">            Eigenvalues and eigenvectors of the symmetric normalized Laplacian.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to CSR format if in a different format</span>
    <span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">make_csr_matrix</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">)</span>

    <span class="c1"># Ensure the adjacency matrix is symmetric</span>
    <span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">adjacency_matrix</span> <span class="o">+</span> <span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Perform symmetric normalization</span>
    <span class="n">normalized_matrix</span> <span class="o">=</span> <span class="n">perform_symmetric_normalization</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">)</span>

    <span class="c1"># Use shift invert mode to compute the eigenvalues for the</span>
    <span class="c1"># normalized adjacency matrix</span>
    <span class="n">lambdas</span><span class="p">,</span> <span class="n">vectors</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigsh</span><span class="p">(</span>
        <span class="n">normalized_matrix</span><span class="p">,</span>
        <span class="n">k</span><span class="o">=</span><span class="n">num_eigenvalues</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">which</span><span class="o">=</span><span class="s2">&quot;LM&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Note the largest eigenvalues of the adjacency matrix correspond to</span>
    <span class="c1"># the smallest eigenvalues of the Laplacian</span>

    <span class="c1"># Convert to Laplacian eigenvalues</span>
    <span class="n">lambdas</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lambdas</span>
    <span class="n">lambda_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
    <span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">lambda_idx</span><span class="p">]</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="n">vectors</span><span class="p">[:,</span> <span class="n">lambda_idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">vectors</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.gsp.convert_adjacency_to_transition_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_adjacency_to_transition_matrix</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Convert an adjacency matrix to a transition matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adjacency_matrix</code>
            </td>
            <td>
                  <code><span title="scipy.sparse.spmatrix">spmatrix</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sparse.spmatrix
The adjacency matrix of the graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="scipy.sparse.csr_matrix">csr_matrix</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sparse.spmatrix
Transition matrix.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">convert_adjacency_to_transition_matrix</span><span class="p">(</span>
    <span class="n">adjacency_matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an adjacency matrix to a transition matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        adjacency_matrix: sparse.spmatrix</span>
<span class="sd">            The adjacency matrix of the graph.</span>

<span class="sd">    Returns:</span>
<span class="sd">        sparse.spmatrix</span>
<span class="sd">            Transition matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to CSR format if in a different format</span>
    <span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">make_csr_matrix</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">)</span>

    <span class="c1"># Compute the degree matrix</span>
    <span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">degree_matrix_inv</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">degrees</span><span class="p">)</span>

    <span class="c1"># Create the transition matrix</span>
    <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">degree_matrix_inv</span> <span class="o">@</span> <span class="n">adjacency_matrix</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.gsp.make_csr_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_csr_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span> <span class="o">|</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Ensure the input matrix is in CSR format.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_csr_matrix</span><span class="p">(</span>
    <span class="n">matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span> <span class="o">|</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure the input matrix is in CSR format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sparse</span><span class="o">.</span><span class="n">isspmatrix_csr</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matrix</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.gsp.perform_symmetric_normalization" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">perform_symmetric_normalization</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Perform symmetric normalization on the adjacency matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adjacency_matrix</code>
            </td>
            <td>
                  <code><span title="scipy.sparse.spmatrix">spmatrix</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sparse.spmatrix
The adjacency matrix of the graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="scipy.sparse.csr_matrix">csr_matrix</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sparse.spmatrix
Symmetrically normalized adjacency matrix.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/gsp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">perform_symmetric_normalization</span><span class="p">(</span>
    <span class="n">adjacency_matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform symmetric normalization on the adjacency matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        adjacency_matrix: sparse.spmatrix</span>
<span class="sd">            The adjacency matrix of the graph.</span>

<span class="sd">    Returns:</span>
<span class="sd">        sparse.spmatrix</span>
<span class="sd">            Symmetrically normalized adjacency matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to CSR format if in a different format</span>
    <span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">make_csr_matrix</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">)</span>
    <span class="c1"># Compute the degree matrix</span>
    <span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">degree_matrix_inv_sqrt</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">degrees</span><span class="p">))</span>

    <span class="c1"># Perform symmetric normalization</span>
    <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span>
        <span class="n">degree_matrix_inv_sqrt</span> <span class="o">@</span> <span class="n">adjacency_matrix</span> <span class="o">@</span> <span class="n">degree_matrix_inv_sqrt</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="spectranorm.utils.metrics" class="doc doc-heading">
            <code>metrics</code>


</h3>

    <div class="doc doc-contents ">

        <p>utils/metrics.py</p>
<p>Utility functions for computing various model metrics in the Spectranorm package.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.metrics.compute_bic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_bic</span><span class="p">(</span><span class="n">model_log_likelihoods</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">n_params</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute Bayesian Information Criterion (BIC) for model evaluation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_log_likelihoods</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Log likelihoods from the model. (n_samples) or (n_samples, n_outputs)
if multiple outputs are being assessed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_params</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
Number of parameters in the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_samples</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
Number of samples used in the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Bayesian Information Criterion. (n_outputs,) if multiple outputs are
assessed, otherwise a scalar.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_bic</span><span class="p">(</span>
    <span class="n">model_log_likelihoods</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">n_params</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Bayesian Information Criterion (BIC) for model evaluation.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_log_likelihoods: np.ndarray</span>
<span class="sd">            Log likelihoods from the model. (n_samples) or (n_samples, n_outputs)</span>
<span class="sd">            if multiple outputs are being assessed.</span>
<span class="sd">        n_params: int</span>
<span class="sd">            Number of parameters in the model.</span>
<span class="sd">        n_samples: int</span>
<span class="sd">            Number of samples used in the model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Bayesian Information Criterion. (n_outputs,) if multiple outputs are</span>
<span class="sd">            assessed, otherwise a scalar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model_log_likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_params</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.metrics.compute_expv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_expv</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute Explained Variance (EXPV) between true and predicted values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
True values. (n_samples) or (n_samples, n_outputs) if multiple outputs
are being assessed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_pred</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Explained Variance. (n_outputs,) if multiple outputs are assessed,
otherwise a scalar.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_expv</span><span class="p">(</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Explained Variance (EXPV) between true and predicted values.</span>

<span class="sd">    Args:</span>
<span class="sd">        y: np.ndarray</span>
<span class="sd">            True values. (n_samples) or (n_samples, n_outputs) if multiple outputs</span>
<span class="sd">            are being assessed.</span>
<span class="sd">        y_pred: np.ndarray</span>
<span class="sd">            Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Explained Variance. (n_outputs,) if multiple outputs are assessed,</span>
<span class="sd">            otherwise a scalar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.metrics.compute_mae" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_mae</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute Mean Absolute Error (MAE) between true and predicted values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
True values. (n_samples) or (n_samples, n_outputs) if multiple outputs
are being assessed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_pred</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Mean Absolute Error. (n_outputs,) if multiple outputs are assessed,
otherwise a scalar.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_mae</span><span class="p">(</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Mean Absolute Error (MAE) between true and predicted values.</span>

<span class="sd">    Args:</span>
<span class="sd">        y: np.ndarray</span>
<span class="sd">            True values. (n_samples) or (n_samples, n_outputs) if multiple outputs</span>
<span class="sd">            are being assessed.</span>
<span class="sd">        y_pred: np.ndarray</span>
<span class="sd">            Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Mean Absolute Error. (n_outputs,) if multiple outputs are assessed,</span>
<span class="sd">            otherwise a scalar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.metrics.compute_mape" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_mape</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute Mean Absolute Percentage Error (MAPE) between true and predicted values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
True values. (n_samples) or (n_samples, n_outputs) if multiple outputs
are being assessed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_pred</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Mean Absolute Percentage Error. (n_outputs,) if multiple outputs are
assessed, otherwise a scalar.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_mape</span><span class="p">(</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Mean Absolute Percentage Error (MAPE) between true and predicted values.</span>

<span class="sd">    Args:</span>
<span class="sd">        y: np.ndarray</span>
<span class="sd">            True values. (n_samples) or (n_samples, n_outputs) if multiple outputs</span>
<span class="sd">            are being assessed.</span>
<span class="sd">        y_pred: np.ndarray</span>
<span class="sd">            Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Mean Absolute Percentage Error. (n_outputs,) if multiple outputs are</span>
<span class="sd">            assessed, otherwise a scalar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.metrics.compute_mse" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_mse</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute Mean Squared Error (MSE) between true and predicted values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
True values. (n_samples) or (n_samples, n_outputs) if multiple outputs
are being assessed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_pred</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Mean Squared Error. (n_outputs,) if multiple outputs are assessed,
otherwise a scalar.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_mse</span><span class="p">(</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Mean Squared Error (MSE) between true and predicted values.</span>

<span class="sd">    Args:</span>
<span class="sd">        y: np.ndarray</span>
<span class="sd">            True values. (n_samples) or (n_samples, n_outputs) if multiple outputs</span>
<span class="sd">            are being assessed.</span>
<span class="sd">        y_pred: np.ndarray</span>
<span class="sd">            Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Mean Squared Error. (n_outputs,) if multiple outputs are assessed,</span>
<span class="sd">            otherwise a scalar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.metrics.compute_msll" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_msll</span><span class="p">(</span><span class="n">model_log_likelihoods</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">baseline_log_likelihoods</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute Mean Standardized Log Loss (MSLL) based on model and baseline log
likelihoods.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_log_likelihoods</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Log likelihoods from the model. (n_samples) or (n_samples, n_outputs)
if multiple outputs are being assessed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>baseline_log_likelihoods</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Log likelihoods from the baseline model (a trivial model). Same shape as
model_log_likelihoods.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Mean Standardized Log Loss. (n_outputs,) if multiple outputs are assessed,
otherwise a scalar.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_msll</span><span class="p">(</span>
    <span class="n">model_log_likelihoods</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">baseline_log_likelihoods</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Mean Standardized Log Loss (MSLL) based on model and baseline log</span>
<span class="sd">    likelihoods.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_log_likelihoods: np.ndarray</span>
<span class="sd">            Log likelihoods from the model. (n_samples) or (n_samples, n_outputs)</span>
<span class="sd">            if multiple outputs are being assessed.</span>
<span class="sd">        baseline_log_likelihoods: np.ndarray</span>
<span class="sd">            Log likelihoods from the baseline model (a trivial model). Same shape as</span>
<span class="sd">            model_log_likelihoods.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Mean Standardized Log Loss. (n_outputs,) if multiple outputs are assessed,</span>
<span class="sd">            otherwise a scalar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="o">-</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model_log_likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">baseline_log_likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.metrics.compute_r2" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_r2</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute R-squared (coefficient of determination) between true and predicted values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
True values. (n_samples) or (n_samples, n_outputs) if multiple outputs
are being assessed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_pred</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
R-squared value. (n_outputs,) if multiple outputs are assessed,
otherwise a scalar.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_r2</span><span class="p">(</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute R-squared (coefficient of determination) between true and predicted values.</span>

<span class="sd">    Args:</span>
<span class="sd">        y: np.ndarray</span>
<span class="sd">            True values. (n_samples) or (n_samples, n_outputs) if multiple outputs</span>
<span class="sd">            are being assessed.</span>
<span class="sd">        y_pred: np.ndarray</span>
<span class="sd">            Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            R-squared value. (n_outputs,) if multiple outputs are assessed,</span>
<span class="sd">            otherwise a scalar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss_res</span> <span class="o">/</span> <span class="n">ss_tot</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.metrics.compute_rmse" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_rmse</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute Root Mean Squared Error (RMSE) between true and predicted values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
True values. (n_samples) or (n_samples, n_outputs) if multiple outputs
are being assessed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y_pred</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Root Mean Squared Error. (n_outputs,) if multiple outputs are assessed,
otherwise a scalar.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_rmse</span><span class="p">(</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">y_pred</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Root Mean Squared Error (RMSE) between true and predicted values.</span>

<span class="sd">    Args:</span>
<span class="sd">        y: np.ndarray</span>
<span class="sd">            True values. (n_samples) or (n_samples, n_outputs) if multiple outputs</span>
<span class="sd">            are being assessed.</span>
<span class="sd">        y_pred: np.ndarray</span>
<span class="sd">            Predicted values. (n_samples) or (n_samples, n_outputs) same shape as y.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Root Mean Squared Error. (n_outputs,) if multiple outputs are assessed,</span>
<span class="sd">            otherwise a scalar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">compute_mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="spectranorm.utils.nitools" class="doc doc-heading">
            <code>nitools</code>


</h3>

    <div class="doc doc-contents ">

        <p>utils/nitools.py</p>
<p>Neuroimaging functions to deal with imaging files for spectranorm.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.compute_adaptive_area_barycentric_transformation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_adaptive_area_barycentric_transformation</span><span class="p">(</span><span class="n">source_vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">source_triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">source_vertex_areas</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">target_vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">target_triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">target_vertex_areas</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">source_vertex_mask</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">k_candidates</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Computes an adaptive area barycentric transformation matrix from the source mesh to
the target mesh (similar to workbench command's ADAP_BARY_AREA option).</p>
<h6 id="spectranorm.utils.nitools.compute_adaptive_area_barycentric_transformation--parameters">Parameters</h6>
<p>source_vertices : np.ndarray
    Array of shape (N1, 3) containing the coordinates of the source vertices.
source_triangles : np.ndarray
    Array of shape (M1, 3) containing the indices of the source triangles.
source_vertex_areas : np.ndarray
    Array of shape (N1,) containing the areas of the source vertices.
target_vertices : np.ndarray
    Array of shape (N2, 3) containing the coordinates of the target vertices.
target_triangles : np.ndarray
    Array of shape (M2, 3) containing the indices of the target triangles.
target_vertex_areas : np.ndarray
    Array of shape (N2,) containing the areas of the target vertices.
source_vertex_mask : np.ndarray | None
    (N1,) Optional mask for source vertices.
k_candidates : int
    Number of candidate triangles to consider for each target vertex.
tol : float
    Tolerance for barycentric coordinate computation.</p>
<h6 id="spectranorm.utils.nitools.compute_adaptive_area_barycentric_transformation--returns">Returns</h6>
<p>sparse.csr_matrix
    Sparse matrix of shape (N2, N1) representing the transformation.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_adaptive_area_barycentric_transformation</span><span class="p">(</span>
    <span class="n">source_vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>  <span class="c1"># (n_source, 3)</span>
    <span class="n">source_triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>  <span class="c1"># (n_tri_source, 3)</span>
    <span class="n">source_vertex_areas</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>  <span class="c1"># (n_source,)</span>
    <span class="n">target_vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>  <span class="c1"># (n_target, 3)</span>
    <span class="n">target_triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>  <span class="c1"># (n_tri_target, 3)</span>
    <span class="n">target_vertex_areas</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>  <span class="c1"># (n_target,)</span>
    <span class="n">source_vertex_mask</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># (n_source,)</span>
    <span class="n">k_candidates</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># number of candidate triangles to check</span>
    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">,</span>  <span class="c1"># tolerance for barycentric coords</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes an adaptive area barycentric transformation matrix from the source mesh to</span>
<span class="sd">    the target mesh (similar to workbench command&#39;s ADAP_BARY_AREA option).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_vertices : np.ndarray</span>
<span class="sd">        Array of shape (N1, 3) containing the coordinates of the source vertices.</span>
<span class="sd">    source_triangles : np.ndarray</span>
<span class="sd">        Array of shape (M1, 3) containing the indices of the source triangles.</span>
<span class="sd">    source_vertex_areas : np.ndarray</span>
<span class="sd">        Array of shape (N1,) containing the areas of the source vertices.</span>
<span class="sd">    target_vertices : np.ndarray</span>
<span class="sd">        Array of shape (N2, 3) containing the coordinates of the target vertices.</span>
<span class="sd">    target_triangles : np.ndarray</span>
<span class="sd">        Array of shape (M2, 3) containing the indices of the target triangles.</span>
<span class="sd">    target_vertex_areas : np.ndarray</span>
<span class="sd">        Array of shape (N2,) containing the areas of the target vertices.</span>
<span class="sd">    source_vertex_mask : np.ndarray | None</span>
<span class="sd">        (N1,) Optional mask for source vertices.</span>
<span class="sd">    k_candidates : int</span>
<span class="sd">        Number of candidate triangles to consider for each target vertex.</span>
<span class="sd">    tol : float</span>
<span class="sd">        Tolerance for barycentric coordinate computation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sparse.csr_matrix</span>
<span class="sd">        Sparse matrix of shape (N2, N1) representing the transformation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># --- Step 1: Compute forward and reverse barycentric transformations ---</span>
    <span class="n">forward_transform</span> <span class="o">=</span> <span class="n">compute_barycentric_transformation</span><span class="p">(</span>
        <span class="n">source_vertices</span><span class="o">=</span><span class="n">source_vertices</span><span class="p">,</span>
        <span class="n">source_triangles</span><span class="o">=</span><span class="n">source_triangles</span><span class="p">,</span>
        <span class="n">target_vertices</span><span class="o">=</span><span class="n">target_vertices</span><span class="p">,</span>
        <span class="n">k_candidates</span><span class="o">=</span><span class="n">k_candidates</span><span class="p">,</span>
        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

    <span class="n">reverse_transform</span> <span class="o">=</span> <span class="n">compute_barycentric_transformation</span><span class="p">(</span>
        <span class="n">source_vertices</span><span class="o">=</span><span class="n">target_vertices</span><span class="p">,</span>
        <span class="n">source_triangles</span><span class="o">=</span><span class="n">target_triangles</span><span class="p">,</span>
        <span class="n">target_vertices</span><span class="o">=</span><span class="n">source_vertices</span><span class="p">,</span>
        <span class="n">k_candidates</span><span class="o">=</span><span class="n">k_candidates</span><span class="p">,</span>
        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

    <span class="c1"># Convert reverse scatter to gather (transpose)</span>
    <span class="n">reverse_gather_transform</span> <span class="o">=</span> <span class="n">reverse_transform</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

    <span class="c1"># --- Step 2: Decide forward vs reverse for each target vertex</span>
    <span class="c1"># Choose the mapping with higher number of sources involved</span>
    <span class="c1"># Count non-zero entries in each row of the forward and reverse matrices</span>
    <span class="c1"># Note: Since we have CSR format, we can use indptr for efficiency</span>
    <span class="n">forward_sources</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">forward_transform</span><span class="o">.</span><span class="n">indptr</span><span class="p">)</span>
    <span class="n">reverse_sources</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">reverse_gather_transform</span><span class="o">.</span><span class="n">indptr</span><span class="p">)</span>

    <span class="c1"># Pick forward if it has &gt;= as many sources as reverse</span>
    <span class="n">use_forward</span> <span class="o">=</span> <span class="n">forward_sources</span> <span class="o">&gt;=</span> <span class="n">reverse_sources</span>

    <span class="c1"># --- Step 3: Build the adaptive gather matrix</span>
    <span class="n">adap_gather</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="n">use_forward</span><span class="p">)</span> <span class="o">@</span> <span class="n">forward_transform</span>
        <span class="o">+</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="o">~</span><span class="n">use_forward</span><span class="p">)</span> <span class="o">@</span> <span class="n">reverse_gather_transform</span>
    <span class="p">)</span>

    <span class="c1"># --- Step 4: Multiply each row by target vertex area (area contributions)</span>
    <span class="n">adap_gather</span> <span class="o">=</span> <span class="n">adap_gather</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
    <span class="n">adap_gather</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="n">target_vertex_areas</span><span class="p">)</span> <span class="o">@</span> <span class="n">adap_gather</span><span class="p">)</span>

    <span class="c1"># --- Step 5: Correction sum (sum over target vertices for each source vertex)</span>
    <span class="n">correction_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">adap_gather</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># --- Step 6: Scale by source_areas / correction_sum (scatter normalization)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">correction_sum</span><span class="p">)</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">correction_sum</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">scale</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_vertex_areas</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">/</span> <span class="n">correction_sum</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
    <span class="n">adap_gather</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">adap_gather</span> <span class="o">@</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>

    <span class="c1"># --- Step 7: ROI masking</span>
    <span class="c1"># (remove columns corresponding to masked-out source vertices)</span>
    <span class="k">if</span> <span class="n">source_vertex_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">adap_gather</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span>
            <span class="n">adap_gather</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                <span class="n">source_vertex_mask</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># --- Step 8: Normalize each row to sum to 1</span>
    <span class="n">row_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">adap_gather</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">row_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">row_sums</span><span class="p">)</span>
    <span class="n">valid_rows</span> <span class="o">=</span> <span class="n">row_sums</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">row_scale</span><span class="p">[</span><span class="n">valid_rows</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">row_sums</span><span class="p">[</span><span class="n">valid_rows</span><span class="p">]</span>
    <span class="n">adap_gather</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="n">row_scale</span><span class="p">)</span> <span class="o">@</span> <span class="n">adap_gather</span>

    <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">adap_gather</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.compute_barycentric_transformation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_barycentric_transformation</span><span class="p">(</span><span class="n">source_vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">source_triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">target_vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">k_candidates</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute sparse barycentric transformation matrix from target_vertices to
source_vertices.</p>
<h6 id="spectranorm.utils.nitools.compute_barycentric_transformation--parameters">Parameters</h6>
<p>source_vertices : numpy.ndarray
    Array of shape (N1, 3) containing the coordinates of the source vertices.
source_triangles : numpy.ndarray
    Array of shape (M1, 3) containing the indices of the source triangles.
target_vertices : numpy.ndarray
    Array of shape (N2, 3) containing the coordinates of the target vertices.
k_candidates : int
    Number of candidate triangles to consider for each target vertex. (default: 10)
tol : float
    Tolerance for inside-triangle check. (default: 1e-10)</p>
<h6 id="spectranorm.utils.nitools.compute_barycentric_transformation--returns">Returns</h6>
<p>barycentric_transformation : scipy.sparse.csr_matrix
    Sparse matrix of shape (N2, N1) representing the barycentric transformation.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_barycentric_transformation</span><span class="p">(</span>
    <span class="n">source_vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">source_triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">target_vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">k_candidates</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute sparse barycentric transformation matrix from target_vertices to</span>
<span class="sd">    source_vertices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_vertices : numpy.ndarray</span>
<span class="sd">        Array of shape (N1, 3) containing the coordinates of the source vertices.</span>
<span class="sd">    source_triangles : numpy.ndarray</span>
<span class="sd">        Array of shape (M1, 3) containing the indices of the source triangles.</span>
<span class="sd">    target_vertices : numpy.ndarray</span>
<span class="sd">        Array of shape (N2, 3) containing the coordinates of the target vertices.</span>
<span class="sd">    k_candidates : int</span>
<span class="sd">        Number of candidate triangles to consider for each target vertex. (default: 10)</span>
<span class="sd">    tol : float</span>
<span class="sd">        Tolerance for inside-triangle check. (default: 1e-10)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    barycentric_transformation : scipy.sparse.csr_matrix</span>
<span class="sd">        Sparse matrix of shape (N2, N1) representing the barycentric transformation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute source triangle centroids</span>
    <span class="n">source_triangle_centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">source_vertices</span><span class="p">[</span><span class="n">source_triangles</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Build KD-tree on triangle centroids to get a quick nearest triangle search</span>
    <span class="n">triangle_tree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">source_triangle_centroids</span><span class="p">)</span>

    <span class="c1"># Find the K nearest source triangles for each target vertex</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">candidate_triangles</span> <span class="o">=</span> <span class="n">triangle_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">target_vertices</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_candidates</span><span class="p">)</span>

    <span class="c1"># Reshape candidate_triangles to ensure it&#39;s 2D</span>
    <span class="n">candidate_triangles</span> <span class="o">=</span> <span class="n">candidate_triangles</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_candidates</span><span class="p">)</span>

    <span class="c1"># Compute coordinates of all vertices in the candidate triangles</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">source_vertices</span><span class="p">[</span><span class="n">source_triangles</span><span class="p">][</span><span class="n">candidate_triangles</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">source_vertices</span><span class="p">[</span><span class="n">source_triangles</span><span class="p">][</span><span class="n">candidate_triangles</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">source_vertices</span><span class="p">[</span><span class="n">source_triangles</span><span class="p">][</span><span class="n">candidate_triangles</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Compute vectors for barycentric coordinates</span>
    <span class="c1"># v0 = b - a, v1 = c - a, v2 = target - a</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">target_vertices</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span>

    <span class="c1"># Compute vector dot products</span>
    <span class="n">d00</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijk-&gt;ij&quot;</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span>
    <span class="n">d01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijk-&gt;ij&quot;</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span>
    <span class="n">d11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijk-&gt;ij&quot;</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span>
    <span class="n">d20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijk-&gt;ij&quot;</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span>
    <span class="n">d21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijk-&gt;ij&quot;</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span>

    <span class="c1"># Compute barycentric coordinates</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">d00</span> <span class="o">*</span> <span class="n">d11</span> <span class="o">-</span> <span class="n">d01</span> <span class="o">*</span> <span class="n">d01</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">d11</span> <span class="o">*</span> <span class="n">d20</span> <span class="o">-</span> <span class="n">d01</span> <span class="o">*</span> <span class="n">d21</span><span class="p">)</span> <span class="o">/</span> <span class="n">den</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">d00</span> <span class="o">*</span> <span class="n">d21</span> <span class="o">-</span> <span class="n">d01</span> <span class="o">*</span> <span class="n">d20</span><span class="p">)</span> <span class="o">/</span> <span class="n">den</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">gamma</span>

    <span class="c1"># Check if target is inside any of the candidate triangles</span>
    <span class="n">is_inside</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">tol</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">beta</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">tol</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">tol</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">den</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">)</span>
    <span class="n">found_valid</span> <span class="o">=</span> <span class="n">is_inside</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Choose the optimal candidate</span>
    <span class="n">selected_candidate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">is_inside</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">selected_candidate</span><span class="p">[</span><span class="o">~</span><span class="n">found_valid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Mark cases with no valid candidates</span>

    <span class="c1"># Start preparing the sparse transformation matrix</span>
    <span class="n">rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">selected_candidate</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">valid_idx</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">selected_triangles</span> <span class="o">=</span> <span class="n">candidate_triangles</span><span class="p">[</span>
            <span class="n">valid_idx</span><span class="p">,</span>
            <span class="n">selected_candidate</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="n">selected_vertex_indices</span> <span class="o">=</span> <span class="n">source_triangles</span><span class="p">[</span><span class="n">selected_triangles</span><span class="p">]</span>
        <span class="n">alpha_values</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">,</span> <span class="n">selected_candidate</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]]</span>
        <span class="n">beta_values</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">,</span> <span class="n">selected_candidate</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]]</span>
        <span class="n">gamma_values</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">,</span> <span class="n">selected_candidate</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]]</span>

        <span class="n">rows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">selected_vertex_indices</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">bary_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">alpha_values</span><span class="p">,</span> <span class="n">beta_values</span><span class="p">,</span> <span class="n">gamma_values</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bary_coords</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="c1"># Fallback: nearest vertex for points without valid candidates</span>
    <span class="n">invalid_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">selected_candidate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">invalid_idx</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">vertex_tree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">source_vertices</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">nearest_vertices</span> <span class="o">=</span> <span class="n">vertex_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">target_vertices</span><span class="p">[</span><span class="n">invalid_idx</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">invalid_idx</span><span class="p">)</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nearest_vertices</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">invalid_idx</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

    <span class="c1"># Build and return the barycentric transformation matrix</span>
    <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cols</span><span class="p">))),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">target_vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source_vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.compute_fslr_thickness" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_fslr_thickness</span><span class="p">(</span><span class="n">subject_freesurfer_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute the fs_LR thickness from FreeSurfer output directory.</p>
<p>This function can be passed to a <code>snm.utils.gsp.EigenmodeBasis</code> as a dataloader
for the <code>load_and_encode_data_list</code> method.</p>
<p>Note: Assuming FreeSurfer's recon-all is completed, this function automatically
maps thickness estimates from subject's native cortical surface space onto the
standard fs_LR space.</p>
<h6 id="spectranorm.utils.nitools.compute_fslr_thickness--parameters">Parameters</h6>
<p>subject_freesurfer_directory : str
    Path to the FreeSurfer subject directory.</p>
<h6 id="spectranorm.utils.nitools.compute_fslr_thickness--returns">Returns</h6>
<p>np.ndarray
    Array of shape (59412,) containing the thickness values for fs_LR vertices
    (excluding the medial wall).</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_fslr_thickness</span><span class="p">(</span>
    <span class="n">subject_freesurfer_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the fs_LR thickness from FreeSurfer output directory.</span>

<span class="sd">    This function can be passed to a `snm.utils.gsp.EigenmodeBasis` as a dataloader</span>
<span class="sd">    for the `load_and_encode_data_list` method.</span>

<span class="sd">    Note: Assuming FreeSurfer&#39;s recon-all is completed, this function automatically</span>
<span class="sd">    maps thickness estimates from subject&#39;s native cortical surface space onto the</span>
<span class="sd">    standard fs_LR space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subject_freesurfer_directory : str</span>
<span class="sd">        Path to the FreeSurfer subject directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Array of shape (59412,) containing the thickness values for fs_LR vertices</span>
<span class="sd">        (excluding the medial wall).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cifti_mask</span> <span class="o">=</span> <span class="n">get_fslr_surface_indices_from_cifti</span><span class="p">()</span>
    <span class="n">adap_area_barycentric_transformation</span> <span class="o">=</span> <span class="n">compute_fsnative_to_fslr32k_transformation</span><span class="p">(</span>
        <span class="n">subject_freesurfer_directory</span><span class="p">,</span>
    <span class="p">)[</span><span class="n">cifti_mask</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">fsnative_thickness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_morph_data</span><span class="p">(</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/lh.thickness&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_morph_data</span><span class="p">(</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/rh.thickness&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">adap_area_barycentric_transformation</span> <span class="o">@</span> <span class="n">fsnative_thickness</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.compute_fsnative_to_fslr32k_transformation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_fsnative_to_fslr32k_transformation</span><span class="p">(</span><span class="n">subject_freesurfer_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute the transformation matrix from FreeSurfer native space to fs_LR-32k
space using an adaptive area barycentric transformation.</p>
<p>Note: This function combines the vertices across left and right hemispheres
to create a unified transformation matrix (left first, then right).</p>
<h6 id="spectranorm.utils.nitools.compute_fsnative_to_fslr32k_transformation--parameters">Parameters</h6>
<p>subject_freesurfer_directory : str
    Path to the FreeSurfer subject directory.</p>
<h6 id="spectranorm.utils.nitools.compute_fsnative_to_fslr32k_transformation--returns">Returns</h6>
<p>sparse.csr_matrix
    Sparse matrix representing the transformation from fsnative space to fs_LR-32k.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_fsnative_to_fslr32k_transformation</span><span class="p">(</span>
    <span class="n">subject_freesurfer_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the transformation matrix from FreeSurfer native space to fs_LR-32k</span>
<span class="sd">    space using an adaptive area barycentric transformation.</span>

<span class="sd">    Note: This function combines the vertices across left and right hemispheres</span>
<span class="sd">    to create a unified transformation matrix (left first, then right).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subject_freesurfer_directory : str</span>
<span class="sd">        Path to the FreeSurfer subject directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sparse.csr_matrix</span>
<span class="sd">        Sparse matrix representing the transformation from fsnative space to fs_LR-32k.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load fs_LR 32k files</span>
    <span class="n">left_fslr_sphere_vertices</span><span class="p">,</span> <span class="n">left_fslr_triangles</span> <span class="o">=</span> <span class="n">load_gifti_surface</span><span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span>
                <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;spectranorm.data.templates.fs_LR_32k&quot;</span><span class="p">)</span>
                <span class="o">/</span> <span class="s2">&quot;fs_LR-deformed_to-fsaverage.L.sphere.32k_fs_LR.surf.gii&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">left_fslr_midthickness_vertices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_gifti_surface</span><span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span>
                <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;spectranorm.data.templates.HCP&quot;</span><span class="p">)</span>
                <span class="o">/</span> <span class="s2">&quot;S1200.L.midthickness_MSMAll.32k_fs_LR.surf.gii&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">left_fslr_vertex_areas</span> <span class="o">=</span> <span class="n">compute_vertex_areas</span><span class="p">(</span>
        <span class="n">left_fslr_midthickness_vertices</span><span class="p">,</span>
        <span class="n">left_fslr_triangles</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">right_fslr_sphere_vertices</span><span class="p">,</span> <span class="n">right_fslr_triangles</span> <span class="o">=</span> <span class="n">load_gifti_surface</span><span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span>
                <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;spectranorm.data.templates.fs_LR_32k&quot;</span><span class="p">)</span>
                <span class="o">/</span> <span class="s2">&quot;fs_LR-deformed_to-fsaverage.R.sphere.32k_fs_LR.surf.gii&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">right_fslr_midthickness_vertices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_gifti_surface</span><span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span>
                <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;spectranorm.data.templates.HCP&quot;</span><span class="p">)</span>
                <span class="o">/</span> <span class="s2">&quot;S1200.R.midthickness_MSMAll.32k_fs_LR.surf.gii&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">right_fslr_vertex_areas</span> <span class="o">=</span> <span class="n">compute_vertex_areas</span><span class="p">(</span>
        <span class="n">right_fslr_midthickness_vertices</span><span class="p">,</span>
        <span class="n">right_fslr_triangles</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Load subject native files</span>
    <span class="n">left_fsnative_sphere_vertices</span><span class="p">,</span> <span class="n">left_fsnative_triangles</span> <span class="o">=</span> <span class="n">load_freesurfer_surface</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/lh.sphere.reg&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">left_fsnative_white_vertices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_freesurfer_surface</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/lh.white&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">left_fsnative_pial_vertices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_freesurfer_surface</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/lh.pial&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">left_fsnative_midthickness_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="p">(</span><span class="n">left_fsnative_white_vertices</span> <span class="o">+</span> <span class="n">left_fsnative_pial_vertices</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">left_fsnative_vertex_areas</span> <span class="o">=</span> <span class="n">compute_vertex_areas</span><span class="p">(</span>
        <span class="n">left_fsnative_midthickness_vertices</span><span class="p">,</span>
        <span class="n">left_fsnative_triangles</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">right_fsnative_sphere_vertices</span><span class="p">,</span> <span class="n">right_fsnative_triangles</span> <span class="o">=</span> <span class="n">load_freesurfer_surface</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/rh.sphere.reg&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">right_fsnative_white_vertices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_freesurfer_surface</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/rh.white&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">right_fsnative_pial_vertices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_freesurfer_surface</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/rh.pial&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">right_fsnative_midthickness_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="p">(</span><span class="n">right_fsnative_white_vertices</span> <span class="o">+</span> <span class="n">right_fsnative_pial_vertices</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">right_fsnative_vertex_areas</span> <span class="o">=</span> <span class="n">compute_vertex_areas</span><span class="p">(</span>
        <span class="n">right_fsnative_midthickness_vertices</span><span class="p">,</span>
        <span class="n">right_fsnative_triangles</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Compute transformations</span>
    <span class="n">left_surface_transformation</span> <span class="o">=</span> <span class="n">compute_adaptive_area_barycentric_transformation</span><span class="p">(</span>
        <span class="n">source_vertices</span><span class="o">=</span><span class="n">left_fsnative_sphere_vertices</span><span class="p">,</span>
        <span class="n">source_triangles</span><span class="o">=</span><span class="n">left_fsnative_triangles</span><span class="p">,</span>
        <span class="n">source_vertex_areas</span><span class="o">=</span><span class="n">left_fsnative_vertex_areas</span><span class="p">,</span>
        <span class="n">target_vertices</span><span class="o">=</span><span class="n">left_fslr_sphere_vertices</span><span class="p">,</span>
        <span class="n">target_triangles</span><span class="o">=</span><span class="n">left_fslr_triangles</span><span class="p">,</span>
        <span class="n">target_vertex_areas</span><span class="o">=</span><span class="n">left_fslr_vertex_areas</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">right_surface_transformation</span> <span class="o">=</span> <span class="n">compute_adaptive_area_barycentric_transformation</span><span class="p">(</span>
        <span class="n">source_vertices</span><span class="o">=</span><span class="n">right_fsnative_sphere_vertices</span><span class="p">,</span>
        <span class="n">source_triangles</span><span class="o">=</span><span class="n">right_fsnative_triangles</span><span class="p">,</span>
        <span class="n">source_vertex_areas</span><span class="o">=</span><span class="n">right_fsnative_vertex_areas</span><span class="p">,</span>
        <span class="n">target_vertices</span><span class="o">=</span><span class="n">right_fslr_sphere_vertices</span><span class="p">,</span>
        <span class="n">target_triangles</span><span class="o">=</span><span class="n">right_fslr_triangles</span><span class="p">,</span>
        <span class="n">target_vertex_areas</span><span class="o">=</span><span class="n">right_fslr_vertex_areas</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Combine the transformations and return</span>
    <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span>
        <span class="n">sparse</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">left_surface_transformation</span><span class="p">,</span>
                <span class="n">right_surface_transformation</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.compute_total_euler_number" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_total_euler_number</span><span class="p">(</span><span class="n">subject_freesurfer_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute the total Euler number from FreeSurfer output directory.
Note: This function assumes FreeSurfer's recon-all is completed.</p>
<h6 id="spectranorm.utils.nitools.compute_total_euler_number--parameters">Parameters</h6>
<p>subject_freesurfer_directory : str
    Path to the FreeSurfer subject directory.</p>
<h6 id="spectranorm.utils.nitools.compute_total_euler_number--returns">Returns</h6>
<p>int
    The total Euler number (sum over left and right surfaces).</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_total_euler_number</span><span class="p">(</span><span class="n">subject_freesurfer_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the total Euler number from FreeSurfer output directory.</span>
<span class="sd">    Note: This function assumes FreeSurfer&#39;s recon-all is completed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subject_freesurfer_directory : str</span>
<span class="sd">        Path to the FreeSurfer subject directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The total Euler number (sum over left and right surfaces).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left_surface</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/lh.orig.nofix&quot;</span>
    <span class="n">right_surface</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_freesurfer_directory</span><span class="si">}</span><span class="s2">/surf/rh.orig.nofix&quot;</span>

    <span class="c1"># Compute the Euler characteristic for each surface</span>
    <span class="n">left_euler</span> <span class="o">=</span> <span class="n">get_euler_number</span><span class="p">(</span><span class="o">*</span><span class="n">load_freesurfer_surface</span><span class="p">(</span><span class="n">left_surface</span><span class="p">))</span>
    <span class="n">right_euler</span> <span class="o">=</span> <span class="n">get_euler_number</span><span class="p">(</span><span class="o">*</span><span class="n">load_freesurfer_surface</span><span class="p">(</span><span class="n">right_surface</span><span class="p">))</span>

    <span class="c1"># Return the total Euler number</span>
    <span class="k">return</span> <span class="n">left_euler</span> <span class="o">+</span> <span class="n">right_euler</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.compute_vertex_areas" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_vertex_areas</span><span class="p">(</span><span class="n">vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute the surface area of each vertex in a triangular mesh.</p>
<h6 id="spectranorm.utils.nitools.compute_vertex_areas--parameters">Parameters</h6>
<p>vertices : numpy.ndarray
    Array of shape (n_vertices, 3) containing vertex coordinates.
triangles : numpy.ndarray
    Array of shape (n_triangles, 3) containing vertex indices for each triangular
    face.</p>
<h6 id="spectranorm.utils.nitools.compute_vertex_areas--returns">Returns</h6>
<p>vertex_areas : numpy.ndarray
    Array of shape (n_vertices,) containing the area associated with each vertex.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_vertex_areas</span><span class="p">(</span>
    <span class="n">vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the surface area of each vertex in a triangular mesh.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vertices : numpy.ndarray</span>
<span class="sd">        Array of shape (n_vertices, 3) containing vertex coordinates.</span>
<span class="sd">    triangles : numpy.ndarray</span>
<span class="sd">        Array of shape (n_triangles, 3) containing vertex indices for each triangular</span>
<span class="sd">        face.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vertex_areas : numpy.ndarray</span>
<span class="sd">        Array of shape (n_vertices,) containing the area associated with each vertex.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute the area of each triangle</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">triangles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">triangles</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">triangles</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="n">triangle_areas</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v2</span> <span class="o">-</span> <span class="n">v0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Accumulate areas for each vertex</span>
    <span class="c1"># One third of each triangle&#39;s area is attributed to each of its vertices</span>
    <span class="n">vertex_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">vertex_areas</span><span class="p">,</span> <span class="n">triangles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">triangle_areas</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">vertex_areas</span><span class="p">,</span> <span class="n">triangles</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">triangle_areas</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">vertex_areas</span><span class="p">,</span> <span class="n">triangles</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">triangle_areas</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vertex_areas</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.get_euler_number" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_euler_number</span><span class="p">(</span><span class="n">vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the Euler number of a surface.</p>
<h6 id="spectranorm.utils.nitools.get_euler_number--parameters">Parameters</h6>
<p>vertices : numpy.ndarray
    Array of shape (n_vertices, 3) containing vertex coordinates.
triangles : numpy.ndarray
    Array of shape (n_triangles, 3) containing vertex indices for each triangular
    face.</p>
<h6 id="spectranorm.utils.nitools.get_euler_number--returns">Returns</h6>
<p>euler_number : int
    The Euler number of the surface.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_euler_number</span><span class="p">(</span>
    <span class="n">vertices</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">triangles</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Euler number of a surface.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vertices : numpy.ndarray</span>
<span class="sd">        Array of shape (n_vertices, 3) containing vertex coordinates.</span>
<span class="sd">    triangles : numpy.ndarray</span>
<span class="sd">        Array of shape (n_triangles, 3) containing vertex indices for each triangular</span>
<span class="sd">        face.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    euler_number : int</span>
<span class="sd">        The Euler number of the surface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Euler characteristic: V - E + F = 2 for closed surfaces</span>
    <span class="c1"># where V = number of vertices, E = number of edges, F = number of faces</span>

    <span class="n">n_vertices</span> <span class="o">=</span> <span class="n">vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_faces</span> <span class="o">=</span> <span class="n">triangles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Compute number of unique edges</span>
    <span class="c1"># Extract all edges from triangles</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">triangles</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
            <span class="n">triangles</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span>
            <span class="n">triangles</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># Sort edges so that [1,2] and [2,1] are considered the same</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Count unique edges</span>
    <span class="n">n_edges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Compute and return the Euler number</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_vertices</span> <span class="o">-</span> <span class="n">n_edges</span> <span class="o">+</span> <span class="n">n_faces</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.get_fslr_surface_indices_from_cifti" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_fslr_surface_indices_from_cifti</span><span class="p">(</span><span class="n">cifti_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the fs_LR surface indices from a CIFTI file (excluding the medial wall).</p>
<h6 id="spectranorm.utils.nitools.get_fslr_surface_indices_from_cifti--parameters">Parameters</h6>
<p>cifti_file : str
    Path to the CIFTI file. By default a ones.dscalar.nii template will be used.</p>
<h6 id="spectranorm.utils.nitools.get_fslr_surface_indices_from_cifti--returns">Returns</h6>
<p>np.ndarray
    The indices indicating of vertices present in the CIFTI format.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_fslr_surface_indices_from_cifti</span><span class="p">(</span>
    <span class="n">cifti_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the fs_LR surface indices from a CIFTI file (excluding the medial wall).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cifti_file : str</span>
<span class="sd">        Path to the CIFTI file. By default a ones.dscalar.nii template will be used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        The indices indicating of vertices present in the CIFTI format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use default ones.dscalar.nii if no file is provided</span>
    <span class="k">if</span> <span class="n">cifti_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cifti_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span>
                <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;spectranorm.data.templates.CIFTI&quot;</span><span class="p">)</span>
                <span class="o">/</span> <span class="s2">&quot;ones.dscalar.nii&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="n">cifti</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">loadsave</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cifti_file</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cifti</span><span class="p">,</span> <span class="n">nib</span><span class="o">.</span><span class="n">cifti2</span><span class="o">.</span><span class="n">cifti2</span><span class="o">.</span><span class="n">Cifti2Image</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">cifti_file</span><span class="si">}</span><span class="s2"> is not a valid CIFTI file.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="c1"># Extract the brain models for left and right cortical surfaces</span>
    <span class="n">brain_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cifti</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_index_map</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">brain_models</span><span class="p">)</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
    <span class="n">left_surface_model</span><span class="p">,</span> <span class="n">right_surface_model</span> <span class="o">=</span> <span class="n">brain_models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">brain_models</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Return the indices for left and right surfaces</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">left_surface_model</span><span class="o">.</span><span class="n">vertex_indices</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">right_surface_model</span><span class="o">.</span><span class="n">vertex_indices</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">left_surface_model</span><span class="o">.</span><span class="n">surface_number_of_vertices</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.load_freesurfer_surface" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_freesurfer_surface</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load a FreeSurfer surface file.</p>
<h6 id="spectranorm.utils.nitools.load_freesurfer_surface--parameters">Parameters</h6>
<p>file : str
    Path to the FreeSurfer surface file to be loaded.</p>
<h6 id="spectranorm.utils.nitools.load_freesurfer_surface--returns">Returns</h6>
<p>vertices : numpy.ndarray
    Array of shape (n_vertices, 3) containing vertex coordinates.
triangles : numpy.ndarray
    Array of shape (n_triangles, 3) containing vertex indices for each triangular
    face.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_freesurfer_surface</span><span class="p">(</span>
    <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a FreeSurfer surface file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : str</span>
<span class="sd">        Path to the FreeSurfer surface file to be loaded.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vertices : numpy.ndarray</span>
<span class="sd">        Array of shape (n_vertices, 3) containing vertex coordinates.</span>
<span class="sd">    triangles : numpy.ndarray</span>
<span class="sd">        Array of shape (n_triangles, 3) containing vertex indices for each triangular</span>
<span class="sd">        face.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">surface</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">triangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">surface</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">triangles</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.nitools.load_gifti_surface" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_gifti_surface</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load a GIfTI surface file.</p>
<h6 id="spectranorm.utils.nitools.load_gifti_surface--parameters">Parameters</h6>
<p>file : Path
    Path to the GIfTI surface file to be loaded (.gii).</p>
<h6 id="spectranorm.utils.nitools.load_gifti_surface--returns">Returns</h6>
<p>vertices : numpy.ndarray
    Array of shape (n_vertices, 3) containing vertex coordinates.
triangles : numpy.ndarray
    Array of shape (n_triangles, 3) containing vertex indices for each triangular
    face.</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/nitools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_gifti_surface</span><span class="p">(</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a GIfTI surface file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : Path</span>
<span class="sd">        Path to the GIfTI surface file to be loaded (.gii).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vertices : numpy.ndarray</span>
<span class="sd">        Array of shape (n_vertices, 3) containing vertex coordinates.</span>
<span class="sd">    triangles : numpy.ndarray</span>
<span class="sd">        Array of shape (n_triangles, 3) containing vertex indices for each triangular</span>
<span class="sd">        face.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gifti_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;nib.gifti.gifti.GiftiImage&quot;</span><span class="p">,</span> <span class="n">nib</span><span class="o">.</span><span class="n">loadsave</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">gifti_data</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">triangles</span> <span class="o">=</span> <span class="n">gifti_data</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">triangles</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="spectranorm.utils.parallel" class="doc doc-heading">
            <code>parallel</code>


</h3>

    <div class="doc doc-contents ">

        <p>utils/parallel.py</p>
<p>Utility functions for spectranorm's parallel execution (e.g. via Joblib).</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="spectranorm.utils.parallel.ParallelTqdm" class="doc doc-heading">
            <code>ParallelTqdm</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="joblib.Parallel">Parallel</span></code></p>


        <p>joblib.Parallel, but with a tqdm progressbar</p>
<h6 id="spectranorm.utils.parallel.ParallelTqdm--additional-parameters">Additional parameters:</h6>
<p>total_tasks: int, default: None
    the number of expected jobs. Used in the tqdm progressbar.
    If None, try to infer from the length of the called iterator, and
    fallback to use the number of remaining items as soon as we finish
    dispatching.
    Note: use a list instead of an iterator if you want the total_tasks
    to be inferred from its length.</p>


<details class="desc" open>
  <summary>str, default: None</summary>
  <p>the description used in the tqdm progressbar.</p>
</details>

<details class="disable_progressbar" open>
  <summary>bool, default: False</summary>
  <p>If True, a tqdm progressbar is not used.</p>
</details>

<details class="show_joblib_header" open>
  <summary>bool, default: False</summary>
  <p>If True, show joblib header before the progressbar.</p>
</details>        <h6 id="spectranorm.utils.parallel.ParallelTqdm--removed-parameters">Removed parameters:</h6>
<p>verbose: will be ignored</p>
<h6 id="spectranorm.utils.parallel.ParallelTqdm--usage">Usage:</h6>
<blockquote>
<blockquote>
<blockquote>
<p>from joblib import delayed
from time import sleep
ParallelTqdm(n_jobs=-1)([delayed(sleep)(.1) for _ in range(10)])
80%|████████  | 8/10 [00:02&lt;00:00,  3.12tasks/s]</p>
</blockquote>
</blockquote>
</blockquote>







              <details class="quote">
                <summary>Source code in <code>src/spectranorm/utils/parallel.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ParallelTqdm</span><span class="p">(</span><span class="n">Parallel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;joblib.Parallel, but with a tqdm progressbar</span>

<span class="sd">    Additional parameters:</span>
<span class="sd">    ----------------------</span>
<span class="sd">    total_tasks: int, default: None</span>
<span class="sd">        the number of expected jobs. Used in the tqdm progressbar.</span>
<span class="sd">        If None, try to infer from the length of the called iterator, and</span>
<span class="sd">        fallback to use the number of remaining items as soon as we finish</span>
<span class="sd">        dispatching.</span>
<span class="sd">        Note: use a list instead of an iterator if you want the total_tasks</span>
<span class="sd">        to be inferred from its length.</span>

<span class="sd">    desc: str, default: None</span>
<span class="sd">        the description used in the tqdm progressbar.</span>

<span class="sd">    disable_progressbar: bool, default: False</span>
<span class="sd">        If True, a tqdm progressbar is not used.</span>

<span class="sd">    show_joblib_header: bool, default: False</span>
<span class="sd">        If True, show joblib header before the progressbar.</span>

<span class="sd">    Removed parameters:</span>
<span class="sd">    -------------------</span>
<span class="sd">    verbose: will be ignored</span>


<span class="sd">    Usage:</span>
<span class="sd">    ------</span>
<span class="sd">    &gt;&gt;&gt; from joblib import delayed</span>
<span class="sd">    &gt;&gt;&gt; from time import sleep</span>
<span class="sd">    &gt;&gt;&gt; ParallelTqdm(n_jobs=-1)([delayed(sleep)(.1) for _ in range(10)])</span>
<span class="sd">    80%|████████  | 8/10 [00:02&lt;00:00,  3.12tasks/s]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_original_iterator</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>  <span class="c1"># mimic joblib internal attribute</span>
    <span class="n">n_dispatched_tasks</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">n_completed_tasks</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">total_tasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">desc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable_progressbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">show_joblib_header</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;verbose&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;verbose is not supported. &quot;</span>
                <span class="s2">&quot;Use disable_progressbar and show_joblib_header instead.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">show_joblib_header</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="o">=</span> <span class="n">total_tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_progressbar</span> <span class="o">=</span> <span class="n">disable_progressbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">:</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">Sized</span><span class="p">):</span>
                <span class="c1"># try to infer total_tasks from the length of the called iterator</span>
                <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
            <span class="c1"># call parent function</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># close tqdm progress bar</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="fm">__call__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">Parallel</span><span class="o">.</span><span class="fm">__call__</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch_one_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="c1"># start progress_bar, if not started yet.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span>
                <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span><span class="p">,</span>
                <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_progressbar</span><span class="p">,</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;tasks&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># call parent function</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch_one_batch</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>

    <span class="n">dispatch_one_batch</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">Parallel</span><span class="o">.</span><span class="n">dispatch_one_batch</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the process of the parallel execution using tqdm&quot;&quot;&quot;</span>
        <span class="c1"># if we finish dispatching, find total_tasks from the number of remaining items</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_iterator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dispatched_tasks</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># update progressbar</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_completed_tasks</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="spectranorm.utils.parallel.ParallelTqdm.print_progress" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_progress</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Display the process of the parallel execution using tqdm</p>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/parallel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the process of the parallel execution using tqdm&quot;&quot;&quot;</span>
    <span class="c1"># if we finish dispatching, find total_tasks from the number of remaining items</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_iterator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dispatched_tasks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
    <span class="c1"># update progressbar</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_completed_tasks</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="spectranorm.utils.stats" class="doc doc-heading">
            <code>stats</code>


</h3>

    <div class="doc doc-contents ">

        <p>utils/stats.py</p>
<p>Statistical utility functions for the Spectranorm package.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.stats.compute_censored_log_likelihood" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_censored_log_likelihood</span><span class="p">(</span><span class="n">observations</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">predicted_mus</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">predicted_sigmas</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">censored_quantile</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute censored log likelihood, replacing extreme low likelihoods with a censoring
threshold.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>observations</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Observed data points (N,).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>predicted_mus</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted means for each observation (N,).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>predicted_sigmas</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted standard deviations for each observation (N,).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>censored_quantile</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float (default=0.01)
Quantile below which log-likelihoods are censored.</p>
              </div>
            </td>
            <td>
                  <code>0.01</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray:
The censored log likelihood of all observations.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_censored_log_likelihood</span><span class="p">(</span>
    <span class="n">observations</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">predicted_mus</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">predicted_sigmas</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">censored_quantile</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute censored log likelihood, replacing extreme low likelihoods with a censoring</span>
<span class="sd">    threshold.</span>

<span class="sd">    Args:</span>
<span class="sd">        observations: np.ndarray</span>
<span class="sd">            Observed data points (N,).</span>
<span class="sd">        predicted_mus: np.ndarray</span>
<span class="sd">            Predicted means for each observation (N,).</span>
<span class="sd">        predicted_sigmas: np.ndarray</span>
<span class="sd">            Predicted standard deviations for each observation (N,).</span>
<span class="sd">        censored_quantile: float (default=0.01)</span>
<span class="sd">            Quantile below which log-likelihoods are censored.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray:</span>
<span class="sd">            The censored log likelihood of all observations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute log likelihoods</span>
    <span class="n">log_likelihoods</span> <span class="o">=</span> <span class="n">compute_log_likelihood</span><span class="p">(</span>
        <span class="n">observations</span><span class="p">,</span>
        <span class="n">predicted_mus</span><span class="p">,</span>
        <span class="n">predicted_sigmas</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Compute censoring threshold based on standard normal</span>
    <span class="n">censor_threshold</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">censored_quantile</span><span class="p">),</span>
        <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Apply censoring (two-sided) and return</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">log_likelihoods</span> <span class="o">&lt;</span> <span class="n">censor_threshold</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">censored_quantile</span><span class="p">),</span>
        <span class="n">log_likelihoods</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.stats.compute_centiles_from_z_scores" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_centiles_from_z_scores</span><span class="p">(</span><span class="n">z_scores</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Convert z-scores to percentiles.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>z_scores</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Array of z-scores.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Array of percentiles corresponding to the z-scores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_centiles_from_z_scores</span><span class="p">(</span>
    <span class="n">z_scores</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert z-scores to percentiles.</span>

<span class="sd">    Args:</span>
<span class="sd">        z_scores: np.ndarray</span>
<span class="sd">            Array of z-scores.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Array of percentiles corresponding to the z-scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert z-scores to percentiles using the cumulative distribution function (CDF)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z_scores</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.stats.compute_correlation_significance_by_fisher_z" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_correlation_significance_by_fisher_z</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">correlation_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute the significance of correlations between variables in the data matrix,
thresholded by a specified correlation value, using Fisher's z-transformation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>correlation_matrix</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
A 2D array of pairwise correlation values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_samples</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int
The number of samples used to compute correlation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>correlation_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>float (default=0.0)
The correlation threshold above which correlations are to be considered
significant.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.bool_">bool_</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
A boolean matrix indicating significantly large correlations between
variables. The True values indicate correlations that are significantly
larger than the threshold.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_correlation_significance_by_fisher_z</span><span class="p">(</span>
    <span class="n">correlation_matrix</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">correlation_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the significance of correlations between variables in the data matrix,</span>
<span class="sd">    thresholded by a specified correlation value, using Fisher&#39;s z-transformation.</span>

<span class="sd">    Args:</span>
<span class="sd">        correlation_matrix: np.ndarray</span>
<span class="sd">            A 2D array of pairwise correlation values.</span>
<span class="sd">        n_samples: int</span>
<span class="sd">            The number of samples used to compute correlation.</span>
<span class="sd">        correlation_threshold: float (default=0.0)</span>
<span class="sd">            The correlation threshold above which correlations are to be considered</span>
<span class="sd">            significant.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            A boolean matrix indicating significantly large correlations between</span>
<span class="sd">            variables. The True values indicate correlations that are significantly</span>
<span class="sd">            larger than the threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fisher&#39;s z-transformation</span>
    <span class="n">fisher_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctanh</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">)</span>
    <span class="n">z_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctanh</span><span class="p">(</span><span class="n">correlation_threshold</span><span class="p">)</span>
    <span class="c1"># Standard error of the Fisher z</span>
    <span class="n">se</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Apply the correlation threshold and return significance matrix</span>
    <span class="c1"># 95% confidence interval</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fisher_z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">z_threshold</span> <span class="o">+</span> <span class="p">(</span><span class="n">se</span> <span class="o">*</span> <span class="mf">1.96</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="spectranorm.utils.stats.compute_log_likelihood" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_log_likelihood</span><span class="p">(</span><span class="n">observations</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">predicted_mus</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">predicted_sigmas</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute the log likelihood of observations given predicted means and standard
deviations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>observations</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Observed data points.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>predicted_mus</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted means for the observations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>predicted_sigmas</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Predicted standard deviations for the observations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray
Log likelihood of each observation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/spectranorm/utils/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_log_likelihood</span><span class="p">(</span>
    <span class="n">observations</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">predicted_mus</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">predicted_sigmas</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the log likelihood of observations given predicted means and standard</span>
<span class="sd">    deviations.</span>

<span class="sd">    Args:</span>
<span class="sd">        observations: np.ndarray</span>
<span class="sd">            Observed data points.</span>
<span class="sd">        predicted_mus: np.ndarray</span>
<span class="sd">            Predicted means for the observations.</span>
<span class="sd">        predicted_sigmas: np.ndarray</span>
<span class="sd">            Predicted standard deviations for the observations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Log likelihood of each observation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">predicted_mus</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">predicted_sigmas</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>